{% extends "base.html" %}

{% block title %}Profile Settings - Ready 2 Dink{% endblock %}

{% block content %}


<div class="container py-4">
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="neon-frame">
            <div class="text-center mb-4">
                <h4 class="card-title mb-0 text-bold text-neon">
                    <i class="fas fa-user-cog me-2"></i>Profile Settings
                </h4>
                <p class="mb-0 text-secondary">Update your profile information and preferences</p>
            </div>
            <div class="card-body">
                <!-- Current Profile Display -->
                <div class="row mb-4">
                    <div class="col-auto">
                        {% if player.selfie %}
                            <img src="{{ url_for('static', filename='uploads/' + player.selfie) }}" 
                                 class="rounded-circle profile-avatar" style="width: 80px; height: 80px; object-fit: cover;" 
                                 alt="Current Profile Photo">
                        {% else %}
                            <div class="rounded-circle avatar-placeholder d-inline-flex align-items-center justify-content-center" 
                                 style="width: 80px; height: 80px;">
                                <i class="fas fa-user text-white fa-2x"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div class="col">
                        <h5 class="mb-1 text-bold text-white">{{ player.full_name }}</h5>
                        <p class="mb-1">
                            <span class="badge badge-primary me-2">{{ player.skill_level }}</span>
                            <span class="badge badge-success">
                                {{ player.wins or 0 }}W-{{ player.losses or 0 }}L
                                {% if player.tournament_wins and player.tournament_wins > 0 %}
                                    {% for i in range(player.tournament_wins) %}‚≠ê{% endfor %}
                                {% endif %}
                            </span>
                        </p>
                        <small class="text-muted">{{ player.email }}</small>
                    </div>
                </div>

                <!-- Account Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="card-title mb-0 text-neon text-bold">
                            <i class="fas fa-wallet me-2"></i>Account Information
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">Tournament Credits:</span>
                                    <span class="text-bold text-neon-green">
                                        {% if player.tournament_credits and player.tournament_credits > 0 %}
                                            ${{ "%.2f"|format(player.tournament_credits) }}
                                        {% else %}
                                            $0.00
                                        {% endif %}
                                    </span>
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Credits from tournament refunds that can be used for future entries
                                </small>
                            </div>
                            <div class="col-md-6">
                                {% if player.player_id %}
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">Player ID:</span>
                                    <span class="text-bold text-neon">{{ player.player_id }}</span>
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-id-card me-1"></i>
                                    Your unique 4-digit player identifier
                                </small>
                                {% endif %}
                            </div>
                        </div>
                        {% if player.tournament_credits and player.tournament_credits > 0 %}
                        <div class="row mt-3">
                            <div class="col-12">
                                <a href="{{ url_for('credit_transaction_history', player_id=player.id) }}" 
                                   class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-history me-1"></i>View Credit History
                                </a>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <hr>

                <!-- Edit Form -->
                <form method="POST" action="{{ url_for('update_profile') }}" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="full_name" class="form-label">
                                    <i class="fas fa-user me-1"></i>Full Name *
                                </label>
                                <input type="text" class="form-control" id="full_name" name="full_name" 
                                       value="{{ player.full_name }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">
                                    <i class="fas fa-envelope me-1"></i>Email Address *
                                </label>
                                <input type="email" class="form-control" id="email" name="email" 
                                       value="{{ player.email }}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="address" class="form-label">
                                    <i class="fas fa-home me-1"></i>Street Address *
                                </label>
                                <input type="text" class="form-control" id="address" name="address" 
                                       value="{{ player.address }}" placeholder="123 Main St" required>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label for="zip_code" class="form-label">
                                    <i class="fas fa-map-pin me-1"></i>Zip Code *
                                </label>
                                <input type="text" class="form-control" id="zip_code" name="zip_code" 
                                       value="{{ player.zip_code or '' }}" placeholder="12345" required>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label for="city" class="form-label">
                                    <i class="fas fa-city me-1"></i>City *
                                </label>
                                <input type="text" class="form-control" id="city" name="city" 
                                       value="{{ player.city or '' }}" placeholder="Your City" required>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label for="state" class="form-label">
                                    <i class="fas fa-flag me-1"></i>State *
                                </label>
                                <input type="text" class="form-control" id="state" name="state" 
                                       value="{{ player.state or '' }}" placeholder="CA" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="dob" class="form-label">
                                    <i class="fas fa-birthday-cake me-1"></i>Date of Birth *
                                </label>
                                <input type="text" class="form-control" id="dob" name="dob" 
                                       value="{{ player.dob }}" placeholder="MM-DD-YYYY" required>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Format: MM-DD-YYYY (e.g., 08-05-1976)
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="player_id" class="form-label">
                                    <i class="fas fa-id-card me-1"></i>Player ID *
                                </label>
                                <input type="text" class="form-control" id="player_id" name="player_id" 
                                       value="{{ player.player_id or '' }}" placeholder="1234" maxlength="4" required>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Choose a unique 4-digit number (1000-9999)
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="skill_level" class="form-label">
                                    <i class="fas fa-star me-1"></i>Skill Level *
                                </label>
                                <select class="form-select" id="skill_level" name="skill_level" required>
                                    <option value="">Select skill level</option>
                                    <option value="Beginner" {{ 'selected' if player.skill_level == 'Beginner' }}>Beginner</option>
                                    <option value="Intermediate" {{ 'selected' if player.skill_level == 'Intermediate' }}>Intermediate</option>
                                    <option value="Advanced" {{ 'selected' if player.skill_level == 'Advanced' }}>Advanced</option>
                                    <option value="Professional" {{ 'selected' if player.skill_level == 'Professional' }}>Professional</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gender and Travel Radius -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="gender" class="form-label">
                                    <i class="fas fa-user me-1"></i>Gender
                                </label>
                                <select class="form-select" id="gender" name="gender">
                                    <option value="prefer_not_to_say" {{ 'selected' if player.gender == 'prefer_not_to_say' or not player.gender }}>Prefer not to say</option>
                                    <option value="male" {{ 'selected' if player.gender == 'male' }}>Male</option>
                                    <option value="female" {{ 'selected' if player.gender == 'female' }}>Female</option>
                                    <option value="non_binary" {{ 'selected' if player.gender == 'non_binary' }}>Non-binary</option>
                                </select>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Optional demographic information
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="travel_radius" class="form-label">
                                    <i class="fas fa-route me-1"></i>Maximum Travel Distance (miles)
                                </label>
                                <select class="form-select" id="travel_radius" name="travel_radius">
                                    <option value="5" {{ 'selected' if player.travel_radius == 5 }}>5 miles</option>
                                    <option value="10" {{ 'selected' if player.travel_radius == 10 }}>10 miles</option>
                                    <option value="15" {{ 'selected' if player.travel_radius == 15 }}>15 miles</option>
                                    <option value="25" {{ 'selected' if player.travel_radius == 25 or not player.travel_radius }}>25 miles (default)</option>
                                    <option value="50" {{ 'selected' if player.travel_radius == 50 }}>50 miles</option>
                                    <option value="75" {{ 'selected' if player.travel_radius == 75 }}>75 miles</option>
                                    <option value="100" {{ 'selected' if player.travel_radius == 100 }}>100 miles</option>
                                </select>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    How far you're willing to travel for matches and tournaments
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="preferred_court_1" class="form-label">
                                    <i class="fas fa-map-marker-alt me-1"></i>Favorite Court #1 *
                                </label>
                                <input type="text" class="form-control court-search" id="preferred_court_1" name="preferred_court_1" 
                                       value="{{ player.preferred_court_1 or player.location1 or '' }}" placeholder="Search for pickleball courts..." required>
                                <div id="preferred_court_1-map" class="map-container mt-2" style="height: 200px; display: none; border-radius: 8px;"></div>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Your primary pickleball court or venue
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="preferred_court_2" class="form-label">
                                    <i class="fas fa-map-marker me-1"></i>Favorite Court #2
                                </label>
                                <input type="text" class="form-control court-search" id="preferred_court_2" name="preferred_court_2" 
                                       value="{{ player.preferred_court_2 or player.location2 or '' }}" placeholder="Optional second court...">
                                <div id="preferred_court_2-map" class="map-container mt-2" style="height: 200px; display: none; border-radius: 8px;"></div>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Alternative court location
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="payout_preference" class="form-label">
                            <i class="fas fa-money-bill me-1"></i>Payout Preference for Tournament Winnings
                        </label>
                        <select class="form-select" id="payout_preference" name="payout_preference">
                            <option value="">Select payout method...</option>
                            <option value="PayPal" {{ 'selected' if player.payout_preference == 'PayPal' }}>PayPal</option>
                            <option value="Venmo" {{ 'selected' if player.payout_preference == 'Venmo' }}>Venmo</option>
                            <option value="Zelle" {{ 'selected' if player.payout_preference == 'Zelle' }}>Zelle</option>
                        </select>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Choose how you'd prefer to receive tournament winnings
                        </div>
                    </div>
                    
                    <!-- PayPal Account Info -->
                    <div class="mb-3" id="paypal_section" style="display: none;">
                        <label for="paypal_email" class="form-label">
                            <i class="fab fa-paypal me-1"></i>PayPal Email Address
                        </label>
                        <input type="email" class="form-control" id="paypal_email" name="paypal_email" 
                               value="{{ player.paypal_email or '' }}" placeholder="your.email@example.com">
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Enter the email address associated with your PayPal account
                        </div>
                    </div>
                    
                    <!-- Venmo Account Info -->
                    <div class="mb-3" id="venmo_section" style="display: none;">
                        <label for="venmo_username" class="form-label">
                            <i class="fas fa-user me-1"></i>Venmo Username
                        </label>
                        <input type="text" class="form-control" id="venmo_username" name="venmo_username" 
                               value="{{ player.venmo_username or '' }}" placeholder="@your-venmo-username">
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Enter your Venmo username (with or without the @ symbol)
                        </div>
                    </div>
                    
                    <!-- Zelle Account Info -->
                    <div class="mb-3" id="zelle_section" style="display: none;">
                        <label for="zelle_info" class="form-label">
                            <i class="fas fa-mobile-alt me-1"></i>Zelle Email or Phone Number
                        </label>
                        <input type="text" class="form-control" id="zelle_info" name="zelle_info" 
                               value="{{ player.zelle_info or '' }}" placeholder="email@example.com or (555) 123-4567">
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Enter the email or phone number linked to your Zelle account
                        </div>
                    </div>
                    
                    <!-- Location Settings Section -->
                    <div class="card account-info-card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-map-marker-alt me-2"></i>Location & Search Settings
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- Current Location Display -->
                            {% if player.latitude and player.longitude %}
                            <div class="alert alert-info mb-3">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <i class="fas fa-map-pin text-primary fa-lg"></i>
                                    </div>
                                    <div class="col">
                                        <strong>Current Location:</strong> {{ "%.4f, %.4f"|format(player.latitude, player.longitude) }}
                                        <br><small class="text-muted">GPS coordinates from your registration</small>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="search_radius_miles" class="form-label">
                                            <i class="fas fa-search me-1"></i>Player & Tournament Search Radius
                                        </label>
                                        <div class="input-group">
                                            <input type="range" class="form-range" id="search_radius_range" 
                                                   min="15" max="50" step="5" value="{{ player.search_radius_miles or 15 }}">
                                            <input type="number" class="form-control" id="search_radius_miles" 
                                                   name="search_radius_miles" min="15" max="50" step="5" 
                                                   value="{{ player.search_radius_miles or 15 }}" style="width: 80px;">
                                            <span class="input-group-text">miles</span>
                                        </div>
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Distance to search for other players and tournaments (15-50 miles)
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="location_zip_code" class="form-label">
                                            <i class="fas fa-map-pin me-1"></i>Update Location by ZIP Code
                                        </label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="location_zip_code" 
                                                   name="location_zip_code" placeholder="Enter ZIP code" maxlength="5">
                                            <button type="button" class="btn btn-outline-secondary" id="update_location_btn">
                                                <i class="fas fa-sync me-1"></i>Update
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Enter ZIP code to update your location coordinates
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12">
                                    <button type="button" class="btn btn-outline-primary" id="gps_location_btn">
                                        <i class="fas fa-crosshairs me-1"></i>Use My Current GPS Location
                                    </button>
                                    <div class="form-text mt-2">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Click to use your device's GPS for precise location matching
                                    </div>
                                    <div id="location_status" class="mt-2"></div>
                                </div>
                            </div>
                            
                            <!-- Hidden fields for GPS coordinates -->
                            <input type="hidden" id="latitude" name="latitude" value="{{ player.latitude or '' }}">
                            <input type="hidden" id="longitude" name="longitude" value="{{ player.longitude or '' }}">
                            <input type="hidden" id="location_method" name="location_method" value="">
                        </div>
                    </div>
                    
                    <!-- Team Management Section -->
                    <div class="card account-info-card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-users me-2"></i>Team & Match Preferences
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- Current Team Status -->
                            {% if current_team %}
                            <div class="alert alert-success mb-3">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <i class="fas fa-users text-success fa-2x"></i>
                                    </div>
                                    <div class="col">
                                        <h6 class="mb-1">
                                            <strong>Current Team: {{ current_team.team_name or 'Doubles Partnership' }}</strong>
                                        </h6>
                                        <div class="d-flex align-items-center mb-2">
                                            {% if current_team.player1_id == player.id %}
                                                {% set partner = current_team.player2_name %}
                                                {% set partner_selfie = current_team.player2_selfie %}
                                            {% else %}
                                                {% set partner = current_team.player1_name %}
                                                {% set partner_selfie = current_team.player1_selfie %}
                                            {% endif %}
                                            
                                            {% if partner_selfie %}
                                                <img src="{{ url_for('static', filename='uploads/' + partner_selfie) }}" 
                                                     class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;" 
                                                     alt="{{ partner }}">
                                            {% endif %}
                                            <span class="text-bold">Partner: {{ partner }}</span>
                                        </div>
                                        <small class="text-muted">Team formed on {{ current_team.created_at[:10] }}</small>
                                    </div>
                                    <div class="col-auto">
                                        <a href="{{ url_for('leave_team') }}" class="btn btn-outline-primary btn-sm" onclick="return confirmLeaveTeam()">
                                            <i class="fas fa-sync-alt me-1"></i>Switch Partner today
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Match Preference Selection -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-table-tennis me-1"></i>Match Type Preference
                                </label>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="match_preference_radio" 
                                                   id="singles_pref" value="singles" 
                                                   {{ 'checked' if player.match_preference == 'singles' or not player.match_preference }}
                                                   {{ 'disabled' if current_team }}>
                                            <label class="form-check-label" for="singles_pref">
                                                <i class="fas fa-user me-1"></i>
                                                <strong>Singles</strong><br>
                                                <small class="text-muted">Play individual matches</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="match_preference_radio" 
                                                   id="doubles_with_partner_pref" value="doubles_with_partner" 
                                                   {{ 'checked' if player.match_preference == 'doubles_with_partner' }}
                                                   {{ 'disabled' if current_team }}>
                                            <label class="form-check-label" for="doubles_with_partner_pref">
                                                <i class="fas fa-users me-1"></i>
                                                <strong>Doubles (Have Partner)</strong><br>
                                                <small class="text-muted">Play with a teammate</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="match_preference_radio" 
                                                   id="doubles_need_partner_pref" value="doubles_need_partner" 
                                                   {{ 'checked' if player.match_preference == 'doubles_need_partner' }}
                                                   {{ 'disabled' if current_team }}>
                                            <label class="form-check-label" for="doubles_need_partner_pref">
                                                <i class="fas fa-search me-1"></i>
                                                <strong>Need a Partner</strong><br>
                                                <small class="text-muted">Looking for a teammate</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                {% if current_team %}
                                <div class="form-text text-info mt-2">
                                    <i class="fas fa-info-circle me-1"></i>
                                    You must leave your current team before changing match preferences
                                </div>
                                {% endif %}
                            </div>

                            <!-- Team Action Buttons -->
                            {% if not current_team %}
                            <div class="row mt-3" id="team_action_section" style="display: none;">
                                <!-- Have Partner - Show Invite Form -->
                                <div id="have_partner_section" class="col-12" style="display: none;">
                                    <div class="card bg-dark border-secondary">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-handshake me-2"></i>Invite Your Partner
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            {% if connections %}
                                            <div class="mb-3">
                                                <label class="form-label">Select from players you've played with:</label>
                                                <div class="row">
                                                    {% for connection in connections %}
                                                    <div class="col-md-6 mb-2">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio" name="partner_connection" 
                                                                   id="partner_{{ connection.id }}" value="{{ connection.id }}">
                                                            <label class="form-check-label d-flex align-items-center" 
                                                                   for="partner_{{ connection.id }}">
                                                                {% if connection.selfie %}
                                                                    <img src="{{ url_for('static', filename='uploads/' + connection.selfie) }}" 
                                                                         class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;" 
                                                                         alt="{{ connection.full_name }}">
                                                                {% endif %}
                                                                {{ connection.full_name }}
                                                            </label>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            {% else %}
                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle me-2"></i>
                                                You haven't played any matches yet. Complete some matches first to build connections!
                                            </div>
                                            {% endif %}
                                            
                                            <div class="mb-3">
                                                <label for="invitation_message" class="form-label">Invitation Message (Optional)</label>
                                                <textarea class="form-control" id="invitation_message" rows="2" 
                                                        placeholder="Hey! Want to be my doubles partner?"></textarea>
                                            </div>
                                            
                                            <button type="button" class="btn btn-primary" onclick="sendTeamInvitation()">
                                                <i class="fas fa-paper-plane me-1"></i>Send Invitation
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Need Partner - Show Search Button -->
                                <div id="need_partner_section" class="col-12" style="display: none;">
                                    <div class="card bg-dark border-secondary">
                                        <div class="card-body text-center">
                                            <i class="fas fa-search fa-3x text-primary mb-3"></i>
                                            <h6 class="mb-2">Find Your Perfect Partner</h6>
                                            <p class="text-muted mb-3">Search for other players who also need a doubles partner</p>
                                            <a href="{{ url_for('team_search') }}" class="btn btn-primary">
                                                <i class="fas fa-search me-1"></i>Search for Partners
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Pending Team Invitations -->
                            {% if pending_invitations %}
                            <div class="mt-4">
                                <h6 class="text-neon mb-3">
                                    <i class="fas fa-envelope me-2"></i>Team Invitations ({{ pending_invitations|length }})
                                </h6>
                                {% for invitation in pending_invitations %}
                                <div class="card bg-dark border-warning mb-2">
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <div class="col-auto">
                                                {% if invitation.inviter_selfie %}
                                                    <img src="{{ url_for('static', filename='uploads/' + invitation.inviter_selfie) }}" 
                                                         class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;" 
                                                         alt="{{ invitation.inviter_name }}">
                                                {% else %}
                                                    <div class="rounded-circle avatar-placeholder d-inline-flex align-items-center justify-content-center" 
                                                         style="width: 40px; height: 40px;">
                                                        <i class="fas fa-user text-white"></i>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="col">
                                                <h6 class="mb-1">{{ invitation.inviter_name }} wants to team up!</h6>
                                                {% if invitation.invitation_message %}
                                                <p class="mb-1 text-muted">"{{ invitation.invitation_message }}"</p>
                                                {% endif %}
                                                <small class="text-muted">Sent {{ invitation.created_at[:10] }}</small>
                                            </div>
                                            <div class="col-auto">
                                                <a href="{{ url_for('accept_team_invitation_route', invitation_id=invitation.id) }}" 
                                                   class="btn btn-success btn-sm me-1">
                                                    <i class="fas fa-check me-1"></i>Accept
                                                </a>
                                                <a href="{{ url_for('reject_team_invitation_route', invitation_id=invitation.id) }}" 
                                                   class="btn btn-outline-danger btn-sm">
                                                    <i class="fas fa-times me-1"></i>Decline
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="selfie" class="form-label">
                            <i class="fas fa-camera me-1"></i>Update Profile Photo
                        </label>
                        <input type="file" class="form-control" id="selfie" name="selfie" accept="image/*">
                        <div class="form-text">Optional: Upload a new profile photo (PNG, JPG, JPEG, GIF)</div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary me-md-2">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Update Profile
                        </button>
                    </div>
                </form>
                
                <!-- Account Management Section -->
                <hr class="my-4">
                <div class="row">
                    <div class="col-12">
                        <h5 class="mb-3">
                            <i class="fas fa-cog me-2"></i>Account Management
                        </h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-secondary w-100" id="resetPasswordBtn">
                                    <i class="fas fa-key me-2"></i>Reset Password
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-warning w-100" id="cancelMembershipBtn">
                                    <i class="fas fa-credit-card me-2"></i>Cancel Membership
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-danger w-100" id="deleteAccountBtn">
                                    <i class="fas fa-trash-alt me-2"></i>Delete Account
                                </button>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                These actions are permanent and cannot be undone. Please contact support if you need assistance.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-key me-2"></i>Reset Password
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>We'll send you an email with instructions to reset your password.</p>
                <div class="mb-3">
                    <label for="resetEmail" class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="resetEmail" value="{{ player.email }}" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmResetPassword">
                    <i class="fas fa-paper-plane me-1"></i>Send Reset Email
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Membership Modal -->
<div class="modal fade" id="cancelMembershipModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-credit-card me-2"></i>Cancel Membership
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Are you sure?</strong> Canceling your membership will remove access to premium features.
                </div>
                <p>Your membership will remain active until the end of your current billing period.</p>
                <div class="mb-3">
                    <label for="cancelReason" class="form-label">Reason for canceling (optional)</label>
                    <select class="form-select" id="cancelReason">
                        <option value="">Select a reason...</option>
                        <option value="too_expensive">Too expensive</option>
                        <option value="not_using">Not using the service enough</option>
                        <option value="found_alternative">Found a better alternative</option>
                        <option value="technical_issues">Technical issues</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Keep Membership</button>
                <button type="button" class="btn btn-warning" id="confirmCancelMembership">
                    <i class="fas fa-times me-1"></i>Cancel Membership
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-trash-alt me-2"></i>Delete Account
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning!</strong> This action cannot be undone.
                </div>
                <p>Deleting your account will permanently remove:</p>
                <ul>
                    <li>Your profile and all personal information</li>
                    <li>Match history and tournament records</li>
                    <li>Ranking points and achievements</li>
                    <li>All messages and connections</li>
                </ul>
                <div class="mb-3">
                    <label for="deleteConfirmText" class="form-label">
                        Type <strong>DELETE</strong> to confirm:
                    </label>
                    <input type="text" class="form-control" id="deleteConfirmText" placeholder="Type DELETE">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteAccount" disabled>
                    <i class="fas fa-trash-alt me-1"></i>Delete Account Permanently
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Payout preference field management
function togglePayoutFields() {
    const selectedMethod = document.getElementById('payout_preference').value;
    const paypalSection = document.getElementById('paypal_section');
    const venmoSection = document.getElementById('venmo_section');
    const zelleSection = document.getElementById('zelle_section');
    
    // Hide all sections first
    paypalSection.style.display = 'none';
    venmoSection.style.display = 'none';
    zelleSection.style.display = 'none';
    
    // Show the relevant section
    if (selectedMethod === 'PayPal') {
        paypalSection.style.display = 'block';
    } else if (selectedMethod === 'Venmo') {
        venmoSection.style.display = 'block';
    } else if (selectedMethod === 'Zelle') {
        zelleSection.style.display = 'block';
    }
}

// Initialize payout fields on page load
document.addEventListener('DOMContentLoaded', function() {
    togglePayoutFields();
});

// Add event listener for payout preference changes
document.getElementById('payout_preference').addEventListener('change', togglePayoutFields);

// Date of birth validation and formatting
document.getElementById('dob').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
    
    // Auto-format as user types: MM-DD-YYYY
    if (value.length >= 2 && value.length <= 4) {
        value = value.substring(0, 2) + '-' + value.substring(2);
    } else if (value.length > 4) {
        value = value.substring(0, 2) + '-' + value.substring(2, 4) + '-' + value.substring(4, 8);
    }
    
    e.target.value = value;
    
    // Validate date format - simplified validation
    const datePattern = /^\d{2}-\d{2}-\d{4}$/;
    if (datePattern.test(value)) {
        const [month, day, year] = value.split('-').map(Number);
        
        // Basic validation: month 1-12, day 1-31, year 1900-current year
        const currentYear = new Date().getFullYear();
        if (month >= 1 && month <= 12 && 
            day >= 1 && day <= 31 && 
            year >= 1900 && year <= currentYear) {
            
            // Clear any validation errors
            e.target.setCustomValidity('');
            e.target.classList.remove('is-invalid');
            e.target.classList.add('is-valid');
        } else {
            e.target.setCustomValidity('Please enter a valid date');
            e.target.classList.remove('is-valid');
            e.target.classList.add('is-invalid');
        }
    } else if (value.length === 10) {
        e.target.setCustomValidity('Please use MM-DD-YYYY format');
        e.target.classList.remove('is-valid');
        e.target.classList.add('is-invalid');
    } else {
        // Reset validation state for incomplete dates
        e.target.setCustomValidity('');
        e.target.classList.remove('is-valid', 'is-invalid');
    }
});

// Player ID validation and formatting
document.getElementById('player_id').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
    
    // Limit to 4 digits
    if (value.length > 4) {
        value = value.substring(0, 4);
    }
    
    e.target.value = value;
    
    // Validate 4-digit number (1000-9999)
    if (value.length === 4) {
        const playerIdNum = parseInt(value);
        if (playerIdNum >= 1000 && playerIdNum <= 9999) {
            e.target.setCustomValidity('');
            e.target.classList.remove('is-invalid');
            e.target.classList.add('is-valid');
        } else {
            e.target.setCustomValidity('Player ID must be between 1000-9999');
            e.target.classList.remove('is-valid');
            e.target.classList.add('is-invalid');
        }
    } else if (value.length > 0) {
        e.target.setCustomValidity('Player ID must be exactly 4 digits');
        e.target.classList.remove('is-valid');
        e.target.classList.add('is-invalid');
    } else {
        // Reset validation state for empty input
        e.target.setCustomValidity('');
        e.target.classList.remove('is-valid', 'is-invalid');
    }
});

// Preview uploaded image
document.getElementById('selfie').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            // Update the current profile image if it exists
            const currentImg = document.querySelector('img[alt="Current Profile Photo"]');
            if (currentImg) {
                currentImg.src = e.target.result;
            }
        };
        reader.readAsDataURL(file);
    }
});

// Map functionality for court search
let maps = {};
let markers = {};

function initializeMap(containerId, inputId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    // Default to a general location (USA center)
    const map = L.map(containerId).setView([39.8283, -98.5795], 4);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    
    maps[containerId] = map;
    markers[containerId] = null;
    
    return map;
}

function searchCourt(query, mapId, inputId) {
    if (!query || query.length < 3) return;
    
    // Enhanced search for pickleball courts and venues
    const searchQuery = `pickleball court ${query}`;
    
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=8&addressdetails=1`)
        .then(response => response.json())
        .then(data => {
            if (data && data.length > 0) {
                const result = data[0];
                const lat = parseFloat(result.lat);
                const lon = parseFloat(result.lon);
                
                // Store coordinates for database (create hidden input)
                let coordinatesInput = document.getElementById(inputId + '_coordinates');
                if (!coordinatesInput) {
                    coordinatesInput = document.createElement('input');
                    coordinatesInput.type = 'hidden';
                    coordinatesInput.id = inputId + '_coordinates';
                    coordinatesInput.name = inputId + '_coordinates';
                    document.getElementById(inputId).parentNode.appendChild(coordinatesInput);
                }
                coordinatesInput.value = JSON.stringify({lat: lat, lng: lon, address: result.display_name});
                
                const map = maps[mapId];
                if (map) {
                    // Remove existing marker
                    if (markers[mapId]) {
                        map.removeLayer(markers[mapId]);
                    }
                    
                    // Add new marker with enhanced popup for exact directions
                    const popupContent = `
                        <div class="text-center" style="min-width: 200px;">
                            <strong style="color: #3F567F;">${result.display_name}</strong><br>
                            <small class="text-muted">Lat: ${lat.toFixed(6)}, Lng: ${lon.toFixed(6)}</small><br>
                            <div class="mt-2">
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" 
                                   target="_blank" class="btn btn-sm btn-primary me-1">
                                   <i class="fas fa-directions"></i> Get Directions
                                </a>
                                <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}" 
                                   target="_blank" class="btn btn-sm btn-outline-secondary">
                                   <i class="fas fa-map"></i> View on Map
                                </a>
                            </div>
                            <div class="mt-1">
                                <small class="text-success">
                                    <i class="fas fa-map-pin"></i> Exact location saved
                                </small>
                            </div>
                        </div>
                    `;
                    
                    markers[mapId] = L.marker([lat, lon])
                        .addTo(map)
                        .bindPopup(popupContent)
                        .openPopup();
                    
                    // Center map on court with higher zoom for precision
                    map.setView([lat, lon], 16);
                }
            } else {
                // Fallback: try general search if no courts found
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`)
                    .then(response => response.json())
                    .then(generalData => {
                        if (generalData && generalData.length > 0) {
                            const result = generalData[0];
                            const lat = parseFloat(result.lat);
                            const lon = parseFloat(result.lon);
                            
                            // Store coordinates
                            let coordinatesInput = document.getElementById(inputId + '_coordinates');
                            if (!coordinatesInput) {
                                coordinatesInput = document.createElement('input');
                                coordinatesInput.type = 'hidden';
                                coordinatesInput.id = inputId + '_coordinates';
                                coordinatesInput.name = inputId + '_coordinates';
                                document.getElementById(inputId).parentNode.appendChild(coordinatesInput);
                            }
                            coordinatesInput.value = JSON.stringify({lat: lat, lng: lon, address: result.display_name});
                            
                            const map = maps[mapId];
                            if (map) {
                                if (markers[mapId]) {
                                    map.removeLayer(markers[mapId]);
                                }
                                
                                const popupContent = `
                                    <div class="text-center">
                                        <strong style="color: #E0563F;">${result.display_name}</strong><br>
                                        <small class="text-muted">General location - please verify court details</small><br>
                                        <div class="mt-2">
                                            <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" 
                                               target="_blank" class="btn btn-sm btn-primary">
                                               <i class="fas fa-directions"></i> Get Directions
                                            </a>
                                        </div>
                                    </div>
                                `;
                                
                                markers[mapId] = L.marker([lat, lon])
                                    .addTo(map)
                                    .bindPopup(popupContent)
                                    .openPopup();
                                
                                map.setView([lat, lon], 14);
                            }
                        }
                    });
            }
        })
        .catch(error => {
            console.log('Court search error:', error);
        });
}

// Initialize court search functionality
document.addEventListener('DOMContentLoaded', function() {
    const courtInputs = document.querySelectorAll('.court-search');
    
    courtInputs.forEach(input => {
        const mapId = input.id + '-map';
        let searchTimeout;
        
        // If input has a value, search for it immediately
        if (input.value && input.value.length >= 3) {
            setTimeout(() => {
                const mapContainer = document.getElementById(mapId);
                if (mapContainer) {
                    mapContainer.style.display = 'block';
                    initializeMap(mapId, input.id);
                    searchCourt(input.value, mapId, input.id);
                }
            }, 500);
        }
        
        input.addEventListener('input', function() {
            const query = this.value.trim();
            const mapContainer = document.getElementById(mapId);
            
            if (query.length >= 3) {
                // Show map container
                if (mapContainer) {
                    mapContainer.style.display = 'block';
                    
                    // Initialize map if not already done
                    if (!maps[mapId]) {
                        setTimeout(() => {
                            initializeMap(mapId, input.id);
                        }, 100);
                    }
                    
                    // Debounced search
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        searchCourt(query, mapId, input.id);
                    }, 500);
                }
            } else {
                // Hide map container if query is too short
                if (mapContainer) {
                    mapContainer.style.display = 'none';
                }
            }
        });
        
        input.addEventListener('focus', function() {
            if (this.value.length >= 3) {
                const mapContainer = document.getElementById(mapId);
                if (mapContainer) {
                    mapContainer.style.display = 'block';
                    
                    // Refresh map size when shown
                    setTimeout(() => {
                        if (maps[mapId]) {
                            maps[mapId].invalidateSize();
                        }
                    }, 100);
                }
            }
        });
    });
    
    // Account Management Button Handlers
    document.getElementById('resetPasswordBtn').addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('resetPasswordModal'));
        modal.show();
    });
    
    document.getElementById('cancelMembershipBtn').addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('cancelMembershipModal'));
        modal.show();
    });
    
    document.getElementById('deleteAccountBtn').addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('deleteAccountModal'));
        modal.show();
    });
    
    // Delete account confirmation text validation
    document.getElementById('deleteConfirmText').addEventListener('input', function() {
        const confirmBtn = document.getElementById('confirmDeleteAccount');
        const inputText = this.value.trim();
        
        if (inputText === 'DELETE') {
            confirmBtn.disabled = false;
            confirmBtn.classList.remove('disabled');
        } else {
            confirmBtn.disabled = true;
            confirmBtn.classList.add('disabled');
        }
    });
    
    // Reset Password Confirmation
    document.getElementById('confirmResetPassword').addEventListener('click', function() {
        // Show loading state
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';
        this.disabled = true;
        
        // Simulate sending email (replace with actual backend call)
        setTimeout(() => {
            alert('Password reset email sent! Check your inbox for instructions.');
            const modal = bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal'));
            modal.hide();
            
            // Reset button
            this.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send Reset Email';
            this.disabled = false;
        }, 2000);
    });
});

// IMMEDIATE TEST - This should show up first
alert('JavaScript is running!');
console.log('=== IMMEDIATE TEST - JavaScript is working! ===');

// Team Management Functions - Direct Approach with immediate testing
(function() {
    console.log('Script loading...');
    
    // Test immediately when script loads
    setTimeout(function() {
        console.log('Testing elements...');
        const radios = document.querySelectorAll('input[name="match_preference_radio"]');
        const teamSection = document.getElementById('team_action_section');
        const havePartner = document.getElementById('have_partner_section');
        const needPartner = document.getElementById('need_partner_section');
        
        console.log('Found:', radios.length, 'radios');
        console.log('Team section:', !!teamSection);
        console.log('Have partner:', !!havePartner);
        console.log('Need partner:', !!needPartner);
        
        if (radios.length > 0) {
            radios.forEach(function(radio, index) {
                console.log('Adding listener to radio', index, radio.value);
                radio.addEventListener('change', function() {
                    console.log('Radio changed to:', this.value);
                    showTeamSection(this.value);
                });
            });
        }
    }, 500);
    
    function showTeamSection(preference) {
        console.log('showTeamSection called with:', preference);
        const teamSection = document.getElementById('team_action_section');
        const havePartner = document.getElementById('have_partner_section');
        const needPartner = document.getElementById('need_partner_section');
        
        if (!teamSection) {
            console.log('Team section not found!');
            return;
        }
        
        // Hide all first
        teamSection.style.display = 'none';
        if (havePartner) havePartner.style.display = 'none';
        if (needPartner) needPartner.style.display = 'none';
        
        if (preference === 'doubles_with_partner') {
            console.log('Showing have partner section');
            teamSection.style.display = 'block';
            if (havePartner) havePartner.style.display = 'block';
        } else if (preference === 'doubles_need_partner') {
            console.log('Showing need partner section');
            teamSection.style.display = 'block';
            if (needPartner) needPartner.style.display = 'block';
        }
    }
    
    // Also try with DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM ready, testing again...');
        const radios = document.querySelectorAll('input[name="match_preference_radio"]');
        console.log('DOM ready - found', radios.length, 'radios');
    });
})();

// Send team invitation function - Fixed: Moved outside DOMContentLoaded
function sendTeamInvitation() {
        const selectedPartner = document.querySelector('input[name="partner_connection"]:checked');
        const message = document.getElementById('invitation_message').value;

        if (!selectedPartner) {
            alert('Please select a partner to invite.');
            return;
        }

        const formData = new FormData();
        formData.append('invitee_id', selectedPartner.value);
        formData.append('message', message);

        // Show loading state
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';
        button.disabled = true;

        fetch('/send_team_invitation', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Team invitation sent successfully!');
                // Reset form
                document.getElementById('invitation_message').value = '';
                selectedPartner.checked = false;
            } else {
                alert('Failed to send invitation: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error sending invitation. Please try again.');
        })
        .finally(() => {
            // Reset button
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }

    // Confirm leave team function
    function confirmLeaveTeam() {
        return confirm('Are you sure you want to switch partners? This will dissolve your current team and both players can form new partnerships. This action cannot be undone.');
    }
    
    // Cancel Membership Confirmation
    document.getElementById('confirmCancelMembership').addEventListener('click', function() {
        const reason = document.getElementById('cancelReason').value;
        
        // Show loading state
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
        this.disabled = true;
        
        // Simulate cancellation (replace with actual backend call)
        setTimeout(() => {
            alert('Membership cancellation requested. You will receive a confirmation email shortly.');
            const modal = bootstrap.Modal.getInstance(document.getElementById('cancelMembershipModal'));
            modal.hide();
            
            // Reset button
            this.innerHTML = '<i class="fas fa-times me-1"></i>Cancel Membership';
            this.disabled = false;
        }, 2000);
    });
    
    // Delete Account Confirmation
    document.getElementById('confirmDeleteAccount').addEventListener('click', function() {
        // Show loading state
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';
        this.disabled = true;
        
        // Simulate deletion (replace with actual backend call)
        setTimeout(() => {
            alert('Account deletion initiated. All your data will be permanently removed within 24 hours.');
            // In real implementation, this would redirect to login or home page
            window.location.href = '/';
        }, 2000);
    });
});

// Location Settings JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Range slider sync with number input
    const rangeSlider = document.getElementById('search_radius_range');
    const numberInput = document.getElementById('search_radius_miles');
    
    if (rangeSlider && numberInput) {
        rangeSlider.addEventListener('input', function() {
            numberInput.value = this.value;
        });
        
        numberInput.addEventListener('input', function() {
            rangeSlider.value = this.value;
        });
    }
    
    // GPS Location Button
    const gpsBtn = document.getElementById('gps_location_btn');
    const locationStatus = document.getElementById('location_status');
    
    if (gpsBtn) {
        gpsBtn.addEventListener('click', function() {
            getGPSLocation();
        });
    }
    
    // ZIP Code Update Button
    const updateLocationBtn = document.getElementById('update_location_btn');
    const zipCodeInput = document.getElementById('location_zip_code');
    
    if (updateLocationBtn) {
        updateLocationBtn.addEventListener('click', function() {
            updateLocationFromZip();
        });
    }
    
    // GPS Location Function
    function getGPSLocation() {
        if (!navigator.geolocation) {
            showLocationStatus('GPS not supported by this browser', 'danger');
            return;
        }
        
        gpsBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Getting Location...';
        gpsBtn.disabled = true;
        
        showLocationStatus('Requesting GPS location...', 'info');
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Update hidden fields
                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lng;
                document.getElementById('location_method').value = 'gps';
                
                showLocationStatus(`GPS location updated: ${lat.toFixed(4)}, ${lng.toFixed(4)}`, 'success');
                
                // Reset button
                gpsBtn.innerHTML = '<i class="fas fa-crosshairs me-1"></i>Use My Current GPS Location';
                gpsBtn.disabled = false;
            },
            function(error) {
                let errorMessage = 'Error getting GPS location: ';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage += 'Location access denied by user';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage += 'Location information unavailable';
                        break;
                    case error.TIMEOUT:
                        errorMessage += 'Location request timed out';
                        break;
                    default:
                        errorMessage += 'Unknown error occurred';
                        break;
                }
                
                showLocationStatus(errorMessage, 'danger');
                
                // Reset button
                gpsBtn.innerHTML = '<i class="fas fa-crosshairs me-1"></i>Use My Current GPS Location';
                gpsBtn.disabled = false;
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000
            }
        );
    }
    
    // Update Location from ZIP Code
    function updateLocationFromZip() {
        const zipCode = zipCodeInput.value.trim();
        
        if (!zipCode || zipCode.length !== 5 || !/^\d{5}$/.test(zipCode)) {
            showLocationStatus('Please enter a valid 5-digit ZIP code', 'danger');
            return;
        }
        
        updateLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Converting...';
        updateLocationBtn.disabled = true;
        
        showLocationStatus('Converting ZIP code to coordinates...', 'info');
        
        // Call our backend endpoint to convert ZIP to coordinates
        fetch('/api/zip-to-coordinates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ zip_code: zipCode })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.latitude && data.longitude) {
                // Update hidden fields
                document.getElementById('latitude').value = data.latitude;
                document.getElementById('longitude').value = data.longitude;
                document.getElementById('location_method').value = 'zip';
                
                showLocationStatus(`Location updated from ZIP ${zipCode}: ${data.latitude.toFixed(4)}, ${data.longitude.toFixed(4)}`, 'success');
                zipCodeInput.value = ''; // Clear the input
            } else {
                showLocationStatus(data.message || 'Could not convert ZIP code to coordinates', 'danger');
            }
            
            // Reset button
            updateLocationBtn.innerHTML = '<i class="fas fa-sync me-1"></i>Update';
            updateLocationBtn.disabled = false;
        })
        .catch(error => {
            showLocationStatus('Error converting ZIP code: ' + error.message, 'danger');
            
            // Reset button
            updateLocationBtn.innerHTML = '<i class="fas fa-sync me-1"></i>Update';
            updateLocationBtn.disabled = false;
        });
    }
    
    // Show location status messages
    function showLocationStatus(message, type) {
        if (!locationStatus) return;
        
        const alertClass = `alert alert-${type} alert-dismissible fade show`;
        locationStatus.innerHTML = `
            <div class="${alertClass}" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        // Auto-hide success messages after 5 seconds
        if (type === 'success') {
            setTimeout(() => {
                const alert = locationStatus.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }
    }
});
</script>
{% endblock %}