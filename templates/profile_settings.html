{% extends "base.html" %}

{% block title %}Profile Settings - Ready 2 Dink{% endblock %}

{% block content %}


<div class="container py-4">
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="neon-frame">
            <div class="text-center mb-4">
                <h4 class="card-title mb-0 text-bold text-neon">
                    <i class="fas fa-user-cog me-2"></i>Profile Settings
                </h4>
                <p class="mb-0 text-secondary">Update your profile information and preferences</p>
            </div>
            <div class="card-body">
                <!-- Current Profile Display -->
                <div class="row mb-4">
                    <div class="col-auto">
                        {% if player.selfie %}
                            <img src="{{ url_for('static', filename='uploads/' + player.selfie) }}" 
                                 class="rounded-circle profile-avatar" style="width: 80px; height: 80px; object-fit: cover;" 
                                 alt="Current Profile Photo">
                        {% else %}
                            <div class="rounded-circle avatar-placeholder d-inline-flex align-items-center justify-content-center" 
                                 style="width: 80px; height: 80px;">
                                <i class="fas fa-user text-white fa-2x"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div class="col">
                        <h5 class="mb-1 text-bold text-white">{{ player.full_name }}</h5>
                        <p class="mb-1">
                            <span class="badge badge-primary me-2">{{ player.skill_level }}</span>
                            <span class="badge badge-success">
                                {{ player.wins or 0 }}W-{{ player.losses or 0 }}L
                                {% if player.tournament_wins and player.tournament_wins > 0 %}
                                    {% for i in range(player.tournament_wins) %}‚≠ê{% endfor %}
                                {% endif %}
                            </span>
                        </p>
                        <small class="text-muted">{{ player.email }}</small>
                    </div>
                </div>

                <!-- Account Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="card-title mb-0 text-neon text-bold">
                            <i class="fas fa-wallet me-2"></i>Account Information
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">Tournament Credits:</span>
                                    <span class="text-bold text-neon-green">
                                        {% if player.tournament_credits and player.tournament_credits > 0 %}
                                            ${{ "%.2f"|format(player.tournament_credits) }}
                                        {% else %}
                                            $0.00
                                        {% endif %}
                                    </span>
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Credits from tournament refunds that can be used for future entries
                                </small>
                            </div>
                            <div class="col-md-6">
                                {% if player.player_id %}
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">Player ID:</span>
                                    <span class="text-bold text-neon">{{ player.player_id }}</span>
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-id-card me-1"></i>
                                    Your unique 4-digit player identifier
                                </small>
                                {% endif %}
                            </div>
                        </div>
                        {% if player.tournament_credits and player.tournament_credits > 0 %}
                        <div class="row mt-3">
                            <div class="col-12">
                                <a href="{{ url_for('credit_transaction_history', player_id=player.id) }}" 
                                   class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-history me-1"></i>View Credit History
                                </a>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <hr>

                <!-- Edit Form -->
               <form method="POST" action="{{ url_for('update_profile') }}" enctype="multipart/form-data">

    <!-- Username Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="card-title mb-0 text-neon text-bold">
                <i class="fas fa-user-tag me-2"></i>Username
            </h6>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="username" class="form-label">
                    <i class="fas fa-at me-1"></i>Username *
                </label>
                <input type="text" class="form-control" id="username" name="username" 
                       value="{{ player.username or '' }}" required>
                <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>
                    Your public handle ‚Äî must be unique and at least 3 characters.
                </div>
            </div>
        </div>
    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="full_name" class="form-label">
                                    <i class="fas fa-user me-1"></i>Full Name *
                                </label>
                                <input type="text" class="form-control" id="full_name" name="full_name" 
                                       value="{{ player.full_name }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">
                                    <i class="fas fa-envelope me-1"></i>Email Address *
                                </label>
                                <input type="email" class="form-control" id="email" name="email" 
                                       value="{{ player.email }}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="address" class="form-label">
                                    <i class="fas fa-home me-1"></i>Street Address
                                </label>
                                <input type="text" class="form-control" id="address" name="address" 
                                       value="{{ player.address }}" placeholder="123 Main St" required>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label for="zip_code" class="form-label">
                                    <i class="fas fa-map-pin me-1"></i>Zip Code
                                </label>
                                <input type="text" class="form-control" id="zip_code" name="zip_code" 
                                       value="{{ player.zip_code or '' }}" placeholder="12345">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label for="city" class="form-label">
                                    <i class="fas fa-city me-1"></i>City
                                </label>
                                <input type="text" class="form-control" id="city" name="city" 
                                       value="{{ player.city or '' }}" placeholder="Your City">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label for="state" class="form-label">
                                    <i class="fas fa-flag me-1"></i>State
                                </label>
                                <input type="text" class="form-control" id="state" name="state" 
                                       value="{{ player.state or '' }}" placeholder="CA">
                            </div>
                        </div>
                    </div>
                            <div class="row">
                                <div class="col-12">
                                    <button type="button" class="btn btn-outline-primary" id="gps-btn" onclick="requestLocationPermission()">
                                        <i class="fas fa-location-dot me-1"></i>Use My Current Location
                                    </button>
                                        <input type="hidden" id="latitude" name="latitude">
                                        <input type="hidden" id="longitude" name="longitude">
                                        <input type="hidden" id="location1" name="location1">
                                </div>
                            </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="dob" class="form-label">
                                    <i class="fas fa-birthday-cake me-1"></i>Date of Birth 
                                </label>
                                <input type="text" class="form-control" id="dob" name="dob" 
                                       value="{{ player.dob }}" placeholder="MM-DD-YYYY" required>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Format: MM-DD-YYYY (e.g., 08-05-1976)
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="skill_level" class="form-label">
                                    <i class="fas fa-star me-1"></i>Skill Level *
                                </label>
                                <select class="form-select" id="skill_level" name="skill_level" required>
                                    <option value="">Select skill level</option>
                                    <option value="Beginner" {{ 'selected' if player.skill_level == 'Beginner' }}>Beginner</option>
                                    <option value="Intermediate" {{ 'selected' if player.skill_level == 'Intermediate' }}>Intermediate</option>
                                    <option value="Advanced" {{ 'selected' if player.skill_level == 'Advanced' }}>Advanced</option>
                                    <option value="Professional" {{ 'selected' if player.skill_level == 'Professional' }}>Professional</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gender and Travel Radius -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="gender" class="form-label">
                                    <i class="fas fa-user me-1"></i>Gender
                                </label>
                                <select class="form-select" id="gender" name="gender">
                                    <option value="prefer_not_to_say" {{ 'selected' if player.gender == 'prefer_not_to_say' or not player.gender }}>Prefer not to say</option>
                                    <option value="male" {{ 'selected' if player.gender == 'male' }}>Male</option>
                                    <option value="female" {{ 'selected' if player.gender == 'female' }}>Female</option>
                                    <option value="non_binary" {{ 'selected' if player.gender == 'non_binary' }}>Non-binary</option>
                                </select>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Optional demographic information
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="preferred_court_1" class="form-label">
                                    <i class="fas fa-map-marker-alt me-1"></i>Favorite Court #1 *
                                </label>
                                <input type="text" class="form-control court-search" id="preferred_court_1" name="preferred_court_1" 
                                       value="{{ player.preferred_court_1 or player.location1 or '' }}" placeholder="Search for pickleball courts..." required>
                                <div id="preferred_court_1-map" class="map-container mt-2" style="height: 200px; display: none; border-radius: 8px;"></div>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Your primary pickleball court or venue
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="preferred_court_2" class="form-label">
                                    <i class="fas fa-map-marker me-1"></i>Favorite Court #2
                                </label>
                                <input type="text" class="form-control court-search" id="preferred_court_2" name="preferred_court_2" 
                                       value="{{ player.preferred_court_2 or player.location2 or '' }}" placeholder="Optional second court...">
                                <div id="preferred_court_2-map" class="map-container mt-2" style="height: 200px; display: none; border-radius: 8px;"></div>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Alternative court location
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    
                  
                 
                    
                    <!-- Location Settings Section -->
                    <div class="card account-info-card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-map-marker-alt me-2"></i>Location & Search Settings
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- Current Location Display -->
                            

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="search_radius_miles" class="form-label">
                                            <i class="fas fa-search me-1"></i>Player & Tournament Search Radius (up to)
                                        </label>
                                        <div class="input-group">
    
                                            <input type="number" class="form-control" id="search_radius_miles" 
                                                   name="search_radius_miles" min="15" max="50" step="5" 
                                                   value="{{ player.search_radius_miles or 15 }}" style="width: 80px;">
                                            <span class="input-group-text">miles</span>
                                        </div>
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Distance to search for other players and tournaments (15-50 miles)
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        
                                      
                                    </div>
                                </div>
                            </div>

                            
                            <!-- Hidden fields for GPS coordinates -->
                            <input type="hidden" id="latitude" name="latitude" value="{{ player.latitude or '' }}">
                            <input type="hidden" id="longitude" name="longitude" value="{{ player.longitude or '' }}">
                            <input type="hidden" id="location_method" name="location_method" value="">
                        </div>
                    </div>
                    
                    <!-- Team Management Section -->
                   <div class="card account-info-card mb-4">
  <div class="card-header">
    <h6 class="card-title mb-0">
      <i class="fas fa-table-tennis me-2"></i>Team & Match Preferences
    </h6>
  </div>
  <div class="card-body">
    <div class="mb-3">
      <label class="form-label">
        <i class="fas fa-table-tennis me-1"></i>Select Match Type
      </label>
      <div class="row">
        <div class="col-md-6">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="match_preference_radio"
                   id="singles_pref" value="singles"
                   {{ 'checked' if player.match_preference == 'singles' }}>
            <label class="form-check-label" for="singles_pref">
              <i class="fas fa-user me-1"></i><strong>Singles</strong><br>
              <small class="text-muted">Play individual matches</small>
            </label>
          </div>
        </div>

        <div class="col-md-6">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="match_preference_radio"
                   id="doubles_pref" value="doubles"
                   {{ 'checked' if player.match_preference == 'doubles' }}>
            <label class="form-check-label" for="doubles_pref">
              <i class="fas fa-users me-1"></i><strong>Doubles</strong><br>
              <small class="text-muted">Play with a partner</small>
            </label>
          </div>
        </div>
      </div>
    </div>

    
  </div>
</div>
                    
                    <!-- Discoverability Section -->
                   
                    
                    <div class="mb-3">
                        <label for="selfie" class="form-label">
                            <i class="fas fa-camera me-1"></i>Update Profile Photo
                        </label>
                        <input type="file" class="form-control" id="selfie" name="selfie" accept="image/*">
                        <div class="form-text">Optional: Upload a new profile photo (PNG, JPG, JPEG, GIF)</div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary me-md-2">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Update Profile
                        </button>
                    </div>
                </form>
                
                <!-- Account Management Section -->
                <hr class="my-4">
                <div class="row">
                    <div class="col-12">
                        <h5 class="mb-3">
                            <i class="fas fa-cog me-2"></i>Account Management
                        </h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-primary"
        data-bs-toggle="modal"
        data-bs-target="#resetPasswordModal">
  <i class="fas fa-key me-1"></i> Reset Password
</button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-warning w-100" id="cancelMembershipBtn">
                                    <i class="fas fa-credit-card me-2"></i>Cancel Membership
                                </button>
                            </div>
                            <div class="col-md-4">
                                <!-- Delete Account Modal Trigger (outside the modal) -->
<button type="button" class="btn btn-outline-danger w-100" id="openDeleteAccountModal">
  <i class="fas fa-trash-alt me-2"></i>Delete Account
</button>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                These actions are permanent and cannot be undone. Please contact support if you need assistance.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-key me-2"></i>Reset Password
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>We'll send you an email with instructions to reset your password.</p>
                <div class="mb-3">
                    <label for="resetEmail" class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="resetEmail" value="{{ player.email }}" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmResetPassword">
                    <i class="fas fa-paper-plane me-1"></i>Send Reset Email
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Membership Modal -->
<div class="modal fade" id="cancelMembershipModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-credit-card me-2"></i>Cancel Membership
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Are you sure?</strong> Canceling your membership will remove access to premium features.
                </div>
                <p>Your membership will remain active until the end of your current billing period.</p>
                <div class="mb-3">
                    <label for="cancelReason" class="form-label">Reason for canceling (optional)</label>
                    <select class="form-select" id="cancelReason">
                        <option value="">Select a reason...</option>
                        <option value="too_expensive">Too expensive</option>
                        <option value="not_using">Not using the service enough</option>
                        <option value="found_alternative">Found a better alternative</option>
                        <option value="technical_issues">Technical issues</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Keep Membership</button>
                <button type="button" class="btn btn-warning" id="confirmCancelMembership">
                    <i class="fas fa-times me-1"></i>Cancel Membership
                </button>
            </div>
        </div>
    </div>
</div>



<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-triangle me-2"></i>Confirm Account Deletion
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>
          <strong>Warning!</strong> This action is permanent and cannot be undone.
        </p>
        <ul>
          <li>All your matches, tournaments, and stats will be erased.</li>
          <li>Your account and personal data will be permanently deleted.</li>
        </ul>
        <div class="mb-3">
          <label for="deleteConfirmText" class="form-label">
            Type <strong>DELETE</strong> to confirm:
          </label>
          <input
            type="text"
            class="form-control"
            id="deleteConfirmText"
            placeholder="Type DELETE to confirm"
          >
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteAccount" disabled>
          <i class="fas fa-trash-alt me-1"></i>Delete Account Permanently
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const openDeleteBtn = document.getElementById("openDeleteAccountModal");
  const deleteModalEl = document.getElementById("deleteAccountModal");
  const deleteConfirmInput = document.getElementById("deleteConfirmText");
  const confirmDeleteBtn = document.getElementById("confirmDeleteAccount");

  if (openDeleteBtn && deleteModalEl) {
    openDeleteBtn.addEventListener("click", () => {
      console.log("üóëÔ∏è Delete Account clicked ‚Äî opening modal");
      new bootstrap.Modal(deleteModalEl).show();
    });
  }

  if (deleteConfirmInput && confirmDeleteBtn) {
    deleteConfirmInput.addEventListener("input", () => {
      confirmDeleteBtn.disabled = (deleteConfirmInput.value.trim().toUpperCase() !== "DELETE");
    });

    confirmDeleteBtn.addEventListener("click", async () => {
      console.log("üö® Confirm delete initiated");
      if (deleteConfirmInput.value.trim().toUpperCase() !== "DELETE") {
        alert("Please type DELETE to confirm.");
        return;
      }

      confirmDeleteBtn.disabled = true;
      confirmDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';

      try {
        const res = await fetch(`/admin/players/{{ player.id }}/delete`, {
          method: "POST",
          headers: { "X-Requested-With": "XMLHttpRequest" },
        });

        if (res.ok) {
          alert("‚úÖ Account deleted successfully.");
          window.location.href = "/";
        } else {
          const msg = await res.text();
          alert("‚ùå Delete failed: " + msg);
        }
      } catch (err) {
        console.error(err);
        alert("Network error: " + err.message);
      } finally {
        confirmDeleteBtn.innerHTML = '<i class="fas fa-trash-alt me-1"></i>Delete Account Permanently';
        confirmDeleteBtn.disabled = false;
      }
    });
  }
});
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
  const resetBtn = document.getElementById("confirmResetPassword");
  const resetEmailInput = document.getElementById("resetEmail");

  if (!resetBtn) {
    console.warn("Reset password button not found");
    return;
  }

  resetBtn.addEventListener("click", async function () {
    const email = resetEmailInput?.value?.trim();

    if (!email) {
      alert("No email address found. Please check your profile email.");
      return;
    }

    // Show loading feedback
    resetBtn.disabled = true;
    resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';

    try {
      const response = await fetch("/forgot_password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });

      const data = await response.json();

      if (data.success) {
        alert("‚úÖ Password reset email sent! Check your inbox.");
      } else {
        alert("‚ö†Ô∏è " + (data.message || "Failed to send reset email."));
      }
    } catch (err) {
      alert("‚ùå Network error: " + err.message);
      console.error(err);
    } finally {
      resetBtn.disabled = false;
      resetBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send Reset Email';
    }
  });
});
// Payout preference field management


// Initialize payout fields on page load
// Payout field toggle function (called from main DOMContentLoaded)

// Date of birth validation and formatting
document.getElementById('dob').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
    
    // Auto-format as user types: MM-DD-YYYY
    if (value.length >= 2 && value.length <= 4) {
        value = value.substring(0, 2) + '-' + value.substring(2);
    } else if (value.length > 4) {
        value = value.substring(0, 2) + '-' + value.substring(2, 4) + '-' + value.substring(4, 8);
    }
    
    e.target.value = value;
    
    // Validate date format - simplified validation
    const datePattern = /^\d{2}-\d{2}-\d{4}$/;
    if (datePattern.test(value)) {
        const [month, day, year] = value.split('-').map(Number);
        
        // Basic validation: month 1-12, day 1-31, year 1900-current year
        const currentYear = new Date().getFullYear();
        if (month >= 1 && month <= 12 && 
            day >= 1 && day <= 31 && 
            year >= 1900 && year <= currentYear) {
            
            // Clear any validation errors
            e.target.setCustomValidity('');
            e.target.classList.remove('is-invalid');
            e.target.classList.add('is-valid');
        } else {
            e.target.setCustomValidity('Please enter a valid date');
            e.target.classList.remove('is-valid');
            e.target.classList.add('is-invalid');
        }
    } else if (value.length === 10) {
        e.target.setCustomValidity('Please use MM-DD-YYYY format');
        e.target.classList.remove('is-valid');
        e.target.classList.add('is-invalid');
    } else {
        // Reset validation state for incomplete dates
        e.target.setCustomValidity('');
        e.target.classList.remove('is-valid', 'is-invalid');
    }
});

// Player ID validation and formatting
document.getElementById('player_id').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
    
    // Limit to 4 digits
    if (value.length > 4) {
        value = value.substring(0, 4);
    }
    
    e.target.value = value;
    
    // Validate 4-digit number (1000-9999)
    if (value.length === 4) {
        const playerIdNum = parseInt(value);
        if (playerIdNum >= 1000 && playerIdNum <= 9999) {
            e.target.setCustomValidity('');
            e.target.classList.remove('is-invalid');
            e.target.classList.add('is-valid');
        } else {
            e.target.setCustomValidity('Player ID must be between 1000-9999');
            e.target.classList.remove('is-valid');
            e.target.classList.add('is-invalid');
        }
    } else if (value.length > 0) {
        e.target.setCustomValidity('Player ID must be exactly 4 digits');
        e.target.classList.remove('is-valid');
        e.target.classList.add('is-invalid');
    } else {
        // Reset validation state for empty input
        e.target.setCustomValidity('');
        e.target.classList.remove('is-valid', 'is-invalid');
    }
});

// Preview uploaded image
document.getElementById('selfie').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            // Update the current profile image if it exists
            const currentImg = document.querySelector('img[alt="Current Profile Photo"]');
            if (currentImg) {
                currentImg.src = e.target.result;
            }
        };
        reader.readAsDataURL(file);
    }
});

// Map functionality for court search
let maps = {};
let markers = {};

function initializeMap(containerId, inputId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    // Check if Leaflet is loaded
    if (typeof L === 'undefined') {
        console.log('Leaflet not loaded, skipping map initialization');
        return null;
    }
    
    try {
        // Default to a general location (USA center)
        const map = L.map(containerId).setView([39.8283, -98.5795], 4);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        
        maps[containerId] = map;
        markers[containerId] = null;
        
        return map;
    } catch (error) {
        console.error('Error initializing map:', error);
        return null;
    }
}

function searchCourt(query, mapId, inputId) {
    if (!query || query.length < 3) return;
    
    // Enhanced search for pickleball courts and venues
    const searchQuery = `pickleball court ${query}`;
    
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=8&addressdetails=1`)
        .then(response => response.json())
        .then(data => {
            if (data && data.length > 0) {
                const result = data[0];
                const lat = parseFloat(result.lat);
                const lon = parseFloat(result.lon);
                
                // Store coordinates for database (create hidden input)
                let coordinatesInput = document.getElementById(inputId + '_coordinates');
                if (!coordinatesInput) {
                    coordinatesInput = document.createElement('input');
                    coordinatesInput.type = 'hidden';
                    coordinatesInput.id = inputId + '_coordinates';
                    coordinatesInput.name = inputId + '_coordinates';
                    document.getElementById(inputId).parentNode.appendChild(coordinatesInput);
                }
                coordinatesInput.value = JSON.stringify({lat: lat, lng: lon, address: result.display_name});
                
                const map = maps[mapId];
                if (map) {
                    // Remove existing marker
                    if (markers[mapId]) {
                        map.removeLayer(markers[mapId]);
                    }
                    
                    // Add new marker with enhanced popup for exact directions
                    const popupContent = `
                        <div class="text-center" style="min-width: 200px;">
                            <strong style="color: #3F567F;">${result.display_name}</strong><br>
                            <small class="text-muted">Lat: ${lat.toFixed(6)}, Lng: ${lon.toFixed(6)}</small><br>
                            <div class="mt-2">
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" 
                                   target="_blank" class="btn btn-sm btn-primary me-1">
                                   <i class="fas fa-directions"></i> Get Directions
                                </a>
                                <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}" 
                                   target="_blank" class="btn btn-sm btn-outline-secondary">
                                   <i class="fas fa-map"></i> View on Map
                                </a>
                            </div>
                            <div class="mt-1">
                                <small class="text-success">
                                    <i class="fas fa-map-pin"></i> Exact location saved
                                </small>
                            </div>
                        </div>
                    `;
                    
                    markers[mapId] = L.marker([lat, lon])
                        .addTo(map)
                        .bindPopup(popupContent)
                        .openPopup();
                    
                    // Center map on court with higher zoom for precision
                    map.setView([lat, lon], 16);
                }
            } else {
                // Fallback: try general search if no courts found
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`)
                    .then(response => response.json())
                    .then(generalData => {
                        if (generalData && generalData.length > 0) {
                            const result = generalData[0];
                            const lat = parseFloat(result.lat);
                            const lon = parseFloat(result.lon);
                            
                            // Store coordinates
                            let coordinatesInput = document.getElementById(inputId + '_coordinates');
                            if (!coordinatesInput) {
                                coordinatesInput = document.createElement('input');
                                coordinatesInput.type = 'hidden';
                                coordinatesInput.id = inputId + '_coordinates';
                                coordinatesInput.name = inputId + '_coordinates';
                                document.getElementById(inputId).parentNode.appendChild(coordinatesInput);
                            }
                            coordinatesInput.value = JSON.stringify({lat: lat, lng: lon, address: result.display_name});
                            
                            const map = maps[mapId];
                            if (map) {
                                if (markers[mapId]) {
                                    map.removeLayer(markers[mapId]);
                                }
                                
                                const popupContent = `
                                    <div class="text-center">
                                        <strong style="color: #E0563F;">${result.display_name}</strong><br>
                                        <small class="text-muted">General location - please verify court details</small><br>
                                        <div class="mt-2">
                                            <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" 
                                               target="_blank" class="btn btn-sm btn-primary">
                                               <i class="fas fa-directions"></i> Get Directions
                                            </a>
                                        </div>
                                    </div>
                                `;
                                
                                if (typeof L !== 'undefined') {
                                    markers[mapId] = L.marker([lat, lon])
                                        .addTo(map)
                                        .bindPopup(popupContent)
                                        .openPopup();
                                }
                                
                                map.setView([lat, lon], 14);
                            }
                        }
                    });
            }
        })
        .catch(error => {
            console.log('Court search error:', error);
        });
}

// Initialize court search functionality (moved to main DOMContentLoaded)

// Team Management Functions - Clean Fixed Version
function handleRadioChange() {
    // Check if radio is disabled
    if (this.disabled) {
        console.log('Radio button is disabled - user has existing team');
        return;
    }
    
    showTeamSection(this.value);
    updateMatchPreference(this.value);
}

function showTeamSection(preference) {
    const teamSection = document.getElementById('team_action_section');
    const havePartner = document.getElementById('have_partner_section');
    const needPartner = document.getElementById('need_partner_section');
    
    if (!teamSection) return;
    
    // Hide all first
    teamSection.style.display = 'none';
    if (havePartner) havePartner.style.display = 'none';
    if (needPartner) needPartner.style.display = 'none';
    
    if (preference === 'doubles_with_partner') {
        teamSection.style.display = 'block';
        if (havePartner) havePartner.style.display = 'block';
    } else if (preference === 'doubles_need_partner') {
        teamSection.style.display = 'block';
        if (needPartner) needPartner.style.display = 'block';
    }
}

// === MAIN DOM CONTENT LOADED ‚Äî CLEAN CONSOLIDATED SCRIPT ===
document.addEventListener("DOMContentLoaded", function () {
  console.log("‚úÖ Profile Settings JS initialized");

  // === MATCH PREFERENCE FUNCTIONALITY ===
  const radios = document.querySelectorAll('input[name="match_preference_radio"]');
  radios.forEach(radio => {
    radio.addEventListener("change", function () {
      updateMatchPreference(this.value);
    });
  });

  // === PAYOUT PREFERENCE FUNCTIONALITY ===
  const payoutSelect = document.getElementById("payout_preference");
  if (payoutSelect) {
    payoutSelect.addEventListener("change", togglePayoutFields);
    togglePayoutFields();
  }

  // === CANCEL MEMBERSHIP FUNCTIONALITY ===
  const cancelMembershipBtn = document.getElementById("cancelMembershipBtn");
  const confirmCancelMembership = document.getElementById("confirmCancelMembership");
  if (cancelMembershipBtn) {
    cancelMembershipBtn.addEventListener("click", () => {
      new bootstrap.Modal(document.getElementById("cancelMembershipModal")).show();
    });
  }
  if (confirmCancelMembership) {
    confirmCancelMembership.addEventListener("click", function () {
      const reason = document.getElementById("cancelReason")?.value || "";
      this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
      this.disabled = true;
      setTimeout(() => {
        alert("Membership cancellation requested. You will receive a confirmation email shortly.");
        const modal = bootstrap.Modal.getInstance(document.getElementById("cancelMembershipModal"));
        modal.hide();
        this.innerHTML = '<i class="fas fa-times me-1"></i>Cancel Membership';
        this.disabled = false;
      }, 2000);
    });
  }

  // === DELETE ACCOUNT FUNCTIONALITY ===
  const deleteAccountBtn = document.getElementById("deleteAccountBtn");
  const deleteModalEl = document.getElementById("deleteAccountModal");
  const deleteConfirmText = document.getElementById("deleteConfirmText");
  const confirmDeleteBtn = document.getElementById("confirmDeleteAccount");

  if (deleteAccountBtn && deleteModalEl) {
    deleteAccountBtn.addEventListener("click", function () {
      console.log("üü¢ Delete button clicked ‚Äî showing modal...");
      const modal = new bootstrap.Modal(deleteModalEl);
      modal.show();
    });
  }

  if (deleteConfirmText && confirmDeleteBtn) {
    deleteConfirmText.addEventListener("input", function () {
      const value = this.value.trim().toUpperCase();
      confirmDeleteBtn.disabled = (value !== "DELETE");
    });

    confirmDeleteBtn.addEventListener("click", async function () {
      console.log("üß® Confirm delete clicked");
      if (deleteConfirmText.value.trim().toUpperCase() !== "DELETE") {
        alert("Please type DELETE to confirm.");
        return;
      }

      this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';
      this.disabled = true;

      try {
        const response = await fetch(`/admin/players/{{ player.id }}/delete`, {
          method: "POST",
          headers: { "X-Requested-With": "XMLHttpRequest" },
        });

        if (response.redirected) {
          window.location.href = response.url;
          return;
        }

        if (response.ok) {
          alert("‚úÖ Account deleted successfully.");
          window.location.href = "/";
        } else {
          const text = await response.text();
          alert("‚ùå Delete failed: " + text);
        }
      } catch (err) {
        alert("Network error: " + err.message);
        console.error(err);
      } finally {
        this.innerHTML = '<i class="fas fa-trash-alt me-1"></i>Delete Account Permanently';
        this.disabled = false;
      }
    });
  }

  // === RESET PASSWORD FUNCTIONALITY ===
  const resetPasswordBtn = document.getElementById("confirmResetPassword");
  if (resetPasswordBtn) {
    resetPasswordBtn.addEventListener("click", async () => {
      const email = document.getElementById("resetEmail")?.value.trim();
      if (!email) return alert("Missing email address.");
      const btn = resetPasswordBtn;
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';

      try {
        const res = await fetch("/forgot_password", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email }),
        });
        const data = await res.json();
        alert(data.message || "Something went wrong.");
      } catch (err) {
        alert("Error: " + err.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send Reset Email';
      }
    });
  }

  // === LOCATION FUNCTIONALITY ===
  const rangeSlider = document.getElementById("search_radius_range");
  const numberInput = document.getElementById("search_radius_miles");
  if (rangeSlider && numberInput) {
    rangeSlider.addEventListener("input", () => (numberInput.value = rangeSlider.value));
    numberInput.addEventListener("input", () => (rangeSlider.value = numberInput.value));
  }

  const gpsBtn = document.getElementById("gps_location_btn");
  if (gpsBtn) gpsBtn.addEventListener("click", getGPSLocation);

  const updateLocationBtn = document.getElementById("update_location_btn");
  if (updateLocationBtn) updateLocationBtn.addEventListener("click", updateLocationFromZip);

  // === COURT SEARCH FUNCTIONALITY ===
  const courtInputs = document.querySelectorAll(".court-search");
  courtInputs.forEach((input) => {
    const mapId = input.id + "-map";
    let searchTimeout;
    if (input.value && input.value.length >= 3) {
      setTimeout(() => {
        const mapContainer = document.getElementById(mapId);
        if (mapContainer && typeof L !== "undefined") {
          mapContainer.style.display = "block";
          initializeMap(mapId, input.id);
          searchCourt(input.value, mapId, input.id);
        }
      }, 1000);
    }
    input.addEventListener("input", function () {
      const query = this.value.trim();
      const mapContainer = document.getElementById(mapId);
      if (query.length >= 3) {
        if (mapContainer) {
          mapContainer.style.display = "block";
          if (!maps[mapId]) setTimeout(() => initializeMap(mapId, input.id), 100);
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => searchCourt(query, mapId, input.id), 500);
        }
      } else if (mapContainer) {
        mapContainer.style.display = "none";
      }
    });
    input.addEventListener("focus", function () {
      if (this.value.length >= 3) {
        const mapContainer = document.getElementById(mapId);
        if (mapContainer) {
          mapContainer.style.display = "block";
          setTimeout(() => {
            if (maps[mapId]) maps[mapId].invalidateSize();
          }, 100);
        }
      }
    });
  });

  console.log("=== All profile settings initialized successfully ===");
});
</script>
{% endblock %}