{% extends "base.html" %}

{% block title %}Challenges - Ready 2 Dink{% endblock %}

{% block content %}


<div class="challenges-container">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="text-center mb-5">
                    <h1 class="display-4 text-bold mb-3 neon-text">
                        <i class="fas fa-swords me-3"></i>Challenges
                    </h1>
                    <p class="lead text-white text-bold">Challenge other players and manage your matches</p>
                </div>
            </div>
        </div>

        <!-- Incoming Challenges -->
        <div class="row mb-5">
            <div class="col-12">
                <h2 class="text-bold mb-4 neon-text">
                    <i class="fas fa-inbox me-2"></i>Incoming Challenges
                </h2>
                
                {% if incoming_challenges %}
                    {% for challenge in incoming_challenges %}
                    <div class="neon-frame challenge-card incoming mb-4">
                        <div class="card-body p-4">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    {% if challenge.challenger_selfie %}
                                        <img src="{{ url_for('static', filename='uploads/' + challenge.challenger_selfie) }}" 
                                             class="challenge-avatar" alt="Challenger">
                                    {% else %}
                                        <div class="avatar-placeholder">
                                            {{ challenge.challenger_name[0].upper() }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col">
                                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
                                        <div>
                                            <h5 class="mb-1 text-white text-bold neon-text">{{ challenge.challenger_name }}</h5>
                                            <div class="d-flex flex-wrap gap-2 mb-2">
                                                <span class="badge badge-success text-bold">{{ challenge.challenger_skill }}</span>
                                                <span class="badge badge-primary text-bold">{{ challenge.challenger_wins or 0 }}W-{{ challenge.challenger_losses or 0 }}L</span>
                                                {% if challenge.status == 'pending' %}<span class="badge badge-warning text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% elif challenge.status == 'confirmed' %}<span class="badge badge-success text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% elif challenge.status == 'counter_proposed' %}<span class="badge badge-primary text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% elif challenge.status == 'declined' %}<span class="badge badge-danger text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% else %}<span class="badge badge-secondary text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>{% endif %}
                                            </div>
                                            <div class="match-details">
                                                <div class="text-white text-bold"><i class="fas fa-map-marker-alt me-2 text-neon"></i>{{ challenge.court_location or 'Location TBD' }}</div>
                                                <div class="text-white text-bold"><i class="fas fa-clock me-2 text-neon"></i>{{ challenge.scheduled_time or 'Time TBD' }}</div>
                                                <div class="text-white text-bold"><i class="fas fa-calendar me-2 text-neon"></i>Challenged {{ challenge.created_at[:10] }}</div>
                                            </div>
                                        </div>
                                        <div class="mt-3 mt-md-0">
                                            {% if challenge.status == 'pending' %}
                                                <form method="POST" action="{{ url_for('accept_challenge_route', challenge_id=challenge.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-success text-bold me-2">
                                                        <i class="fas fa-check me-1"></i>Accept
                                                    </button>
                                                </form>
                                                <button type="button" class="btn btn-warning text-bold me-2" 
                                                        data-bs-toggle="modal" data-bs-target="#counterModal{{ challenge.id }}">
                                                    <i class="fas fa-exchange-alt me-1"></i>Counter-Propose
                                                </button>
                                                <form method="POST" action="{{ url_for('decline_challenge_route', challenge_id=challenge.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-danger text-bold" onclick="return confirm('Are you sure you want to decline this challenge?')">
                                                        <i class="fas fa-times me-1"></i>Decline
                                                    </button>
                                                </form>
                                            {% elif challenge.status == 'counter_proposed' %}
                                                <form method="POST" action="{{ url_for('accept_challenge_route', challenge_id=challenge.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-success text-bold me-2">
                                                        <i class="fas fa-handshake me-1"></i>Accept Counter
                                                    </button>
                                                </form>
                                                <form method="POST" action="{{ url_for('decline_challenge_route', challenge_id=challenge.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-danger text-bold" onclick="return confirm('Are you sure you want to decline this challenge?')">
                                                        <i class="fas fa-times me-1"></i>Decline
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="neon-frame mb-4">
                        <div class="empty-state">
                            <i class="fas fa-inbox text-neon"></i>
                            <h5 class="text-white mb-2 text-bold neon-text">No Incoming Challenges</h5>
                            <p>When other players challenge you, they'll appear here</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Outgoing Challenges -->
        <div class="row mb-5">
            <div class="col-12">
                <h2 class="text-bold mb-4 neon-text">
                    <i class="fas fa-paper-plane me-2"></i>Sent Challenges
                </h2>
                
                {% if outgoing_challenges %}
                    {% for challenge in outgoing_challenges %}
                    <div class="neon-frame challenge-card outgoing mb-4">
                        <div class="card-body p-4">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    {% if challenge.opponent_selfie %}
                                        <img src="{{ url_for('static', filename='uploads/' + challenge.opponent_selfie) }}" 
                                             class="challenge-avatar" alt="Opponent">
                                    {% else %}
                                        <div class="avatar-placeholder">
                                            {{ challenge.opponent_name[0].upper() }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col">
                                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
                                        <div>
                                            <h5 class="mb-1 text-white text-bold neon-text">{{ challenge.opponent_name }}</h5>
                                            <div class="d-flex flex-wrap gap-2 mb-2">
                                                <span class="badge badge-success text-bold">{{ challenge.opponent_skill }}</span>
                                                <span class="badge badge-primary text-bold">{{ challenge.opponent_wins or 0 }}W-{{ challenge.opponent_losses or 0 }}L</span>
                                                {% if challenge.status == 'pending' %}<span class="badge badge-warning text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% elif challenge.status == 'confirmed' %}<span class="badge badge-success text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% elif challenge.status == 'counter_proposed' %}<span class="badge badge-primary text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% elif challenge.status == 'declined' %}<span class="badge badge-danger text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% else %}<span class="badge badge-secondary text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>{% endif %}
                                            </div>
                                            <div class="match-details">
                                                <div class="text-white text-bold"><i class="fas fa-map-marker-alt me-2 text-neon"></i>{{ challenge.court_location or 'Location TBD' }}</div>
                                                <div class="text-white text-bold"><i class="fas fa-clock me-2 text-neon"></i>{{ challenge.scheduled_time or 'Time TBD' }}</div>
                                                <div class="text-white text-bold"><i class="fas fa-calendar me-2 text-neon"></i>Sent {{ challenge.created_at[:10] }}</div>
                                            </div>
                                        </div>
                                        <div class="mt-3 mt-md-0">
                                            {% if challenge.status == 'pending' %}
                                                <span class="badge bg-warning">
                                                    <i class="fas fa-hourglass-half me-1"></i>Waiting for Response
                                                </span>
                                            {% elif challenge.status == 'counter_proposed' %}
                                                <span class="badge bg-info">
                                                    <i class="fas fa-exchange-alt me-1"></i>Counter-Proposed
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="neon-frame mb-4">
                        <div class="empty-state">
                            <i class="fas fa-paper-plane text-neon"></i>
                            <h5 class="text-white mb-2 text-bold neon-text">No Sent Challenges</h5>
                            <p>Challenge other players below to get started</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Confirmed Matches -->
        {% if confirmed_matches %}
        <div class="row mb-5">
            <div class="col-12">
                <h2 class="text-bold mb-4 neon-text">
                    <i class="fas fa-calendar-check me-2"></i>Upcoming Matches
                </h2>
                
                {% for match in confirmed_matches %}
                <div class="neon-frame challenge-card confirmed mb-4">
                    <div class="card-body p-4">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                {% if match.opponent_selfie %}
                                    <img src="{{ url_for('static', filename='uploads/' + match.opponent_selfie) }}" 
                                         class="challenge-avatar" alt="Opponent">
                                {% else %}
                                    <div class="avatar-placeholder">
                                        {{ match.opponent_name[0].upper() }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col">
                                <h5 class="mb-1 text-white text-bold neon-text">{{ match.opponent_name }}</h5>
                                <div class="d-flex flex-wrap gap-2 mb-2">
                                    <span class="badge badge-success text-bold">{{ match.opponent_skill }}</span>
                                    <span class="badge badge-success text-bold">Confirmed</span>
                                </div>
                                <div class="match-details">
                                    <div class="text-white text-bold"><i class="fas fa-map-marker-alt me-2 text-neon"></i>{{ match.court_location or 'Location TBD' }}</div>
                                    <div class="text-white text-bold"><i class="fas fa-clock me-2 text-neon"></i>{{ match.scheduled_time or 'Time TBD' }}</div>
                                    <div class="text-white text-bold"><i class="fas fa-calendar me-2 text-neon"></i>Confirmed {{ match.created_at[:10] }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Send New Challenge -->
        <div class="row mb-5">
            <div class="col-12">
                <h2 class="text-bold mb-4 neon-text">
                    <i class="fas fa-plus-circle me-2"></i>Challenge a Player
                </h2>
                
                <div class="neon-frame">
                    <form method="POST" action="{{ url_for('send_challenge_route') }}">
                        <div class="mb-4">
                            <label class="form-label text-white text-bold">Select Player to Challenge:</label>
                            <div style="max-height: 400px; overflow-y: auto;">
                                {% for player in available_players %}
                                <div class="player-option">
                                    <div class="row align-items-center">
                                        <div class="col-auto">
                                            <input type="radio" name="opponent_id" value="{{ player.id }}" id="player_{{ player.id }}" class="form-check-input me-2">
                                        </div>
                                        <div class="col-auto">
                                            {% if player.selfie %}
                                                <img src="{{ url_for('static', filename='uploads/' + player.selfie) }}" 
                                                     class="challenge-avatar" alt="Player">
                                            {% else %}
                                                <div class="avatar-placeholder challenge-avatar-placeholder" style="font-size: 1rem;">
                                                    {{ player.full_name[0].upper() }}
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="col">
                                            <label for="player_{{ player.id }}" class="form-check-label" style="cursor: pointer; width: 100%;">
                                                <h6 class="mb-1 text-white text-bold neon-text">{{ player.full_name }}</h6>
                                                <div class="d-flex flex-wrap gap-2">
                                                    <span class="badge badge-success text-bold">{{ player.skill_level }}</span>
                                                    <span class="badge badge-primary text-bold">{{ player.wins or 0 }}W-{{ player.losses or 0 }}L</span>
                                                    <span class="badge badge-warning text-bold">{{ player.ranking_points or 0 }} pts</span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="text-center py-4">
                                    <p class="text-white-50">No available players to challenge at the moment</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label text-white text-bold">Proposed Location (Optional):</label>
                                <input type="text" class="form-control dark-input" name="court_location" 
                                       placeholder="Court or location preference">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label text-white text-bold">Proposed Date & Time (Optional):</label>
                                <input type="datetime-local" class="form-control dark-input" name="scheduled_time">
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-lg text-bold">
                                <i class="fas fa-paper-plane me-2"></i>Send Challenge
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Match History -->
        {% if completed_matches %}
        <div class="row">
            <div class="col-12">
                <h2 class="section-header">
                    <i class="fas fa-history me-2"></i>Match History
                </h2>
                
                {% for match in completed_matches %}
                <div class="challenge-card completed">
                    <div class="card-body p-4">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                {% if match.opponent_selfie %}
                                    <img src="{{ url_for('static', filename='uploads/' + match.opponent_selfie) }}" 
                                         class="challenge-avatar" alt="Opponent">
                                {% else %}
                                    <div class="avatar-placeholder">
                                        {{ match.opponent_name[0].upper() }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col">
                                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
                                    <div>
                                        <h5 class="mb-1 text-white fw-bold">{{ match.opponent_name }}</h5>
                                        <div class="d-flex flex-wrap gap-2 mb-2">
                                            <span class="skill-badge">{{ match.opponent_skill }}</span>
                                            <span class="result-badge result-{{ match.result }}">{{ match.result.title() }}</span>
                                            {% if match.match_result %}
                                                <span class="record-badge">{{ match.match_result }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="match-details">
                                            <div><i class="fas fa-map-marker-alt me-2"></i>{{ match.court_location or 'Various locations' }}</div>
                                            <div><i class="fas fa-calendar me-2"></i>Completed {{ match.created_at[:10] }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Counter-Proposal Modals -->
{% for challenge in incoming_challenges %}
{% if challenge.status == 'pending' %}
<div class="modal fade" id="counterModal{{ challenge.id }}" tabindex="-1" aria-labelledby="counterModalLabel{{ challenge.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background: var(--dark-surface); border: 1px solid var(--glass-border);">
            <div class="modal-header" style="border-bottom: 1px solid var(--glass-border);">
                <h5 class="modal-title text-white text-bold neon-text" id="counterModalLabel{{ challenge.id }}">
                    <i class="fas fa-exchange-alt me-2"></i>Counter-Propose to {{ challenge.challenger_name }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="counterForm{{ challenge.id }}" action="/decline_challenge" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="challenge_id" value="{{ challenge.id }}">
                    
                    <div class="mb-3">
                        <h6 class="text-white text-bold">Current Proposal:</h6>
                        <div class="text-white-50">
                            <div><i class="fas fa-map-marker-alt me-2"></i>{{ challenge.court_location or 'Location TBD' }}</div>
                            <div><i class="fas fa-clock me-2"></i>{{ challenge.scheduled_time or 'Time TBD' }}</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-white text-bold">Alternative Location:</label>
                        <input type="text" class="form-control dark-input" name="proposed_location" 
                               placeholder="Suggest a different court or location">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-white text-bold">Alternative Date & Time:</label>
                        <input type="datetime-local" class="form-control dark-input" name="proposed_time">
                    </div>
                    
                    <div class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i>
                        Propose alternative details and they'll be notified to accept or decline your counter-offer.
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--glass-border);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning text-bold" onclick="handleCounterProposal({{ challenge.id }})">
                        <i class="fas fa-paper-plane me-1"></i>Send Counter-Proposal
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<script>
function handleCounterProposal(challengeId) {
    event.preventDefault();
    
    const form = document.getElementById('counterForm' + challengeId);
    const formData = new FormData(form);
    
    // Prepare the data for the backend
    const data = {
        challenge_id: formData.get('challenge_id'),
        proposed_location: formData.get('proposed_location'),
        proposed_time: formData.get('proposed_time'),
        player_id: {{ session.get('current_player_id', 'null') }}
    };
    
    fetch('/decline_challenge', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message and reload page
            alert(data.message);
            window.location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to send counter-proposal. Please try again.');
    });
}
</script>

{% endblock %}