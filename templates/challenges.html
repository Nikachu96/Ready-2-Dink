{% extends "base.html" %}

{% block title %}Challenges - Ready 2 Dink{% endblock %}

{% block content %}


<div class="challenges-container">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="text-center mb-5">
                    <h1 class="display-4 text-bold mb-3 neon-text">
                        <i class="fas fa-swords me-3"></i>Challenges
                    </h1>
                    <p class="lead text-white text-bold">Challenge other players and manage your matches</p>
                </div>
            </div>
        </div>

        <!-- Incoming Challenges -->
        <div class="row mb-5">
            <div class="col-12">
                <h2 class="text-bold mb-4 neon-text">
                    <i class="fas fa-inbox me-2"></i>Incoming Challenges
                </h2>
                
                {% if incoming_challenges %}
                    {% for challenge in incoming_challenges %}
                    <div class="neon-frame challenge-card incoming mb-4">
                        <div class="card-body p-4">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    {% if challenge.challenger_selfie %}
                                        <img src="{{ url_for('static', filename='uploads/' + challenge.challenger_selfie) }}" 
                                             class="challenge-avatar" alt="Challenger">
                                    {% else %}
                                        <div class="avatar-placeholder">
                                            {{ challenge.challenger_name[0].upper() }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col">
                                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
                                        <div>
                                            <h5 class="mb-1 text-white text-bold neon-text">{{ challenge.challenger_name }}</h5>
                                            <div class="d-flex flex-wrap gap-2 mb-2">
                                                <span class="badge badge-success text-bold">{{ challenge.challenger_skill }}</span>
                                                <span class="badge badge-primary text-bold">{{ challenge.challenger_wins or 0 }}W-{{ challenge.challenger_losses or 0 }}L</span>
                                                {% if challenge.status == 'pending' %}<span class="badge badge-warning text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% elif challenge.status == 'confirmed' %}<span class="badge badge-success text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% elif challenge.status == 'counter_proposed' %}<span class="badge badge-primary text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% elif challenge.status == 'declined' %}<span class="badge badge-danger text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% else %}<span class="badge badge-secondary text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>{% endif %}
                                            </div>
                                            <div class="match-details">
                                                <div class="text-white text-bold"><i class="fas fa-map-marker-alt me-2 text-neon"></i>{{ challenge.court_location or 'Location TBD' }}</div>
                                                <div class="text-white text-bold"><i class="fas fa-clock me-2 text-neon"></i>{{ challenge.scheduled_time or 'Time TBD' }}</div>
                                                <div class="text-white text-bold"><i class="fas fa-calendar me-2 text-neon"></i>Challenged {{ challenge.created_at[:10] }}</div>
                                            </div>
                                        </div>
                                        <div class="mt-3 mt-md-0">
                                            {% if challenge.status == 'pending' %}
                                                <form method="POST" action="{{ url_for('accept_challenge_route', challenge_id=challenge.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-success text-bold me-2">
                                                        <i class="fas fa-check me-1"></i>Accept
                                                    </button>
                                                </form>
                                                <button type="button" class="btn btn-warning text-bold me-2" 
                                                        data-bs-toggle="modal" data-bs-target="#counterModal{{ challenge.id }}">
                                                    <i class="fas fa-exchange-alt me-1"></i>Counter-Propose
                                                </button>
                                                <form method="POST" action="{{ url_for('decline_challenge_route', challenge_id=challenge.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-danger text-bold" onclick="return confirm('Are you sure you want to decline this challenge?')">
                                                        <i class="fas fa-times me-1"></i>Decline
                                                    </button>
                                                </form>
                                            {% elif challenge.status == 'counter_proposed' %}
                                                <form method="POST" action="{{ url_for('accept_challenge_route', challenge_id=challenge.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-success text-bold me-2">
                                                        <i class="fas fa-handshake me-1"></i>Accept Counter
                                                    </button>
                                                </form>
                                                <form method="POST" action="{{ url_for('decline_challenge_route', challenge_id=challenge.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-danger text-bold" onclick="return confirm('Are you sure you want to decline this challenge?')">
                                                        <i class="fas fa-times me-1"></i>Decline
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="neon-frame mb-4">
                        <div class="empty-state">
                            <i class="fas fa-inbox text-neon"></i>
                            <h5 class="text-white mb-2 text-bold neon-text">No Incoming Challenges</h5>
                            <p>When other players challenge you, they'll appear here</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Outgoing Challenges -->
        <div class="row mb-5">
            <div class="col-12">
                <h2 class="text-bold mb-4 neon-text">
                    <i class="fas fa-paper-plane me-2"></i>Sent Challenges
                </h2>
                
                {% if outgoing_challenges %}
                    {% for challenge in outgoing_challenges %}
                    <div class="neon-frame challenge-card outgoing mb-4">
                        <div class="card-body p-4">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    {% if challenge.opponent_selfie %}
                                        <img src="{{ url_for('static', filename='uploads/' + challenge.opponent_selfie) }}" 
                                             class="challenge-avatar" alt="Opponent">
                                    {% else %}
                                        <div class="avatar-placeholder">
                                            {{ challenge.opponent_name[0].upper() }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col">
                                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
                                        <div>
                                            <h5 class="mb-1 text-white text-bold neon-text">{{ challenge.opponent_name }}</h5>
                                            <div class="d-flex flex-wrap gap-2 mb-2">
                                                <span class="badge badge-success text-bold">{{ challenge.opponent_skill }}</span>
                                                <span class="badge badge-primary text-bold">{{ challenge.opponent_wins or 0 }}W-{{ challenge.opponent_losses or 0 }}L</span>
                                                {% if challenge.status == 'pending' %}<span class="badge badge-warning text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% elif challenge.status == 'confirmed' %}<span class="badge badge-success text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% elif challenge.status == 'counter_proposed' %}<span class="badge badge-primary text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% elif challenge.status == 'declined' %}<span class="badge badge-danger text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% else %}<span class="badge badge-secondary text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>{% endif %}
                                            </div>
                                            <div class="match-details">
                                                <div class="text-white text-bold"><i class="fas fa-map-marker-alt me-2 text-neon"></i>{{ challenge.court_location or 'Location TBD' }}</div>
                                                <div class="text-white text-bold"><i class="fas fa-clock me-2 text-neon"></i>{{ challenge.scheduled_time or 'Time TBD' }}</div>
                                                <div class="text-white text-bold"><i class="fas fa-calendar me-2 text-neon"></i>Sent {{ challenge.created_at[:10] }}</div>
                                            </div>
                                        </div>
                                        <div class="mt-3 mt-md-0">
                                            {% if challenge.status == 'pending' %}
                                                <span class="badge bg-warning">
                                                    <i class="fas fa-hourglass-half me-1"></i>Waiting for Response
                                                </span>
                                            {% elif challenge.status == 'counter_proposed' %}
                                                <span class="badge bg-info">
                                                    <i class="fas fa-exchange-alt me-1"></i>Counter-Proposed
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="neon-frame mb-4">
                        <div class="empty-state">
                            <i class="fas fa-paper-plane text-neon"></i>
                            <h5 class="text-white mb-2 text-bold neon-text">No Sent Challenges</h5>
                            <p>Challenge other players below to get started</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Past Due Matches - Need Score Submission -->
        {% set past_due_matches = confirmed_matches|selectattr("time_status", "equalto", "past_due")|list %}
        {% if past_due_matches %}
        <div class="row mb-5">
            <div class="col-12">
                <h2 class="text-bold mb-4 neon-text">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>Submit Score - Past Due Matches
                </h2>
                
                {% for match in past_due_matches %}
                <div class="neon-frame challenge-card past-due mb-4">
                    <div class="card-body p-4">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                {% if match.opponent_selfie %}
                                    <img src="{{ url_for('static', filename='uploads/' + match.opponent_selfie) }}" 
                                         class="challenge-avatar" alt="Opponent">
                                {% else %}
                                    <div class="avatar-placeholder">
                                        {{ match.opponent_name[0].upper() }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col">
                                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
                                    <div>
                                        <h5 class="mb-1 text-white text-bold neon-text">{{ match.opponent_name }}</h5>
                                        <div class="d-flex flex-wrap gap-2 mb-2">
                                            <span class="badge badge-success text-bold">{{ match.opponent_skill }}</span>
                                            <span class="badge badge-warning text-bold">Score Needed</span>
                                        </div>
                                        <div class="match-details">
                                            <div class="text-white text-bold"><i class="fas fa-map-marker-alt me-2 text-neon"></i>{{ match.court_location or 'Location TBD' }}</div>
                                            <div class="text-white text-bold"><i class="fas fa-clock me-2 text-neon"></i>{{ match.scheduled_time or 'Time TBD' }}</div>
                                            <div class="text-white text-bold"><i class="fas fa-calendar me-2 text-neon"></i>Confirmed {{ match.created_at[:10] }}</div>
                                        </div>
                                    </div>
                                    <div class="mt-3 mt-md-0">
                                        <button class="btn btn-warning btn-sm text-bold" 
                                                onclick="showSubmitScore({{ match.id }}, '{{ match.opponent_name }}')">
                                            <i class="fas fa-trophy me-1"></i>Submit Score
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Confirmed Matches - Still Upcoming -->
        {% set upcoming_matches = confirmed_matches|selectattr("time_status", "equalto", "upcoming")|list %}
        {% if upcoming_matches %}
        <div class="row mb-5">
            <div class="col-12">
                <h2 class="text-bold mb-4 neon-text">
                    <i class="fas fa-calendar-check me-2"></i>Upcoming Matches
                </h2>
                
                {% for match in upcoming_matches %}
                <div class="neon-frame challenge-card confirmed mb-4">
                    <div class="card-body p-4">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                {% if match.opponent_selfie %}
                                    <img src="{{ url_for('static', filename='uploads/' + match.opponent_selfie) }}" 
                                         class="challenge-avatar" alt="Opponent">
                                {% else %}
                                    <div class="avatar-placeholder">
                                        {{ match.opponent_name[0].upper() }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col">
                                <h5 class="mb-1 text-white text-bold neon-text">{{ match.opponent_name }}</h5>
                                <div class="d-flex flex-wrap gap-2 mb-2">
                                    <span class="badge badge-success text-bold">{{ match.opponent_skill }}</span>
                                    <span class="badge badge-success text-bold">Confirmed</span>
                                </div>
                                <div class="match-details">
                                    <div class="text-white text-bold"><i class="fas fa-map-marker-alt me-2 text-neon"></i>{{ match.court_location or 'Location TBD' }}</div>
                                    <div class="text-white text-bold"><i class="fas fa-clock me-2 text-neon"></i>{{ match.scheduled_time or 'Time TBD' }}</div>
                                    <div class="text-white text-bold"><i class="fas fa-calendar me-2 text-neon"></i>Confirmed {{ match.created_at[:10] }}</div>
                                </div>
                            </div>
                            {% for match in confirmed_matches %}
<div class="neon-frame challenge-card confirmed mb-4">
  <div class="card-body p-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h5 class="text-white text-bold neon-text">{{ match.opponent_name }}</h5>
        <div class="text-white"><i class="fas fa-map-marker-alt me-2"></i>{{ match.court_location or 'TBD' }}</div>
      </div>
      <button class="btn btn-success btn-lg start-match-btn" 
              data-match-id="{{ match.id }}">
        <i class="fas fa-play-circle me-1"></i>Start Match
      </button>
    </div>
  </div>
</div>
{% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Challenge Players by Skill Level -->
        <div class="row mb-5">
            <div class="col-12">
                <h2 class="text-bold mb-4 neon-text">
                    <i class="fas fa-plus-circle me-2"></i>Pick Player to Challenge:
                </h2>
                
                {% if available_players %}
                    {% set advanced_players = available_players | selectattr("skill_level", "in", ["Advanced", "Expert", "Pro"]) | list %}
                    {% set beginner_players = available_players | selectattr("skill_level", "in", ["Beginner", "Intermediate", "Recreational"]) | list %}
                    
                    <!-- Advanced Players Section -->
                    {% if advanced_players %}
                    <div class="mb-5">
                        <h3 class="text-white text-bold mb-3">Advanced Players</h3>
                        <div class="row">
                            {% for player in advanced_players %}
                            <div class="col-md-6 mb-3">
                                <div class="challenge-player-card advanced">
                                    <div class="row align-items-center">
                                        <div class="col-auto">
                                            {% if player.selfie %}
                                                <img src="{{ url_for('static', filename='uploads/' + player.selfie) }}" 
                                                     class="challenge-player-avatar advanced" alt="{{ player.full_name }}">
                                            {% else %}
                                                <div class="challenge-player-avatar-placeholder advanced">
                                                    {{ player.full_name[0].upper() }}
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="col">
                                            <h5 class="mb-1 text-white text-bold">{{ player.full_name }}</h5>
                                            <div class="player-details">
                                                <div class="text-white mb-1">
                                                    <span class="me-3"><strong>Skill</strong> {{ player.skill_level }}</span>
                                                </div>
                                                <div class="text-white">
                                                    <span><strong>Points</strong> {{ player.ranking_points or 0 }} pts</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <div class="d-flex flex-column gap-2">
                                                <button onclick="showChallengeModal({{ player.id }}, '{{ player.full_name }}')" 
                                                        class="btn btn-challenge-advanced">
                                                    Challenge
                                                </button>
                                                <button onclick="showPlayerStats({{ player.id }})" 
                                                        class="btn btn-stats-advanced">
                                                    View Stats
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Beginner Players Section -->
                    {% if beginner_players %}
                    <div class="mb-5">
                        <h3 class="text-white text-bold mb-3">Beginner Players</h3>
                        <div class="row">
                            {% for player in beginner_players %}
                            <div class="col-md-6 mb-3">
                                <div class="challenge-player-card beginner">
                                    <div class="row align-items-center">
                                        <div class="col-auto">
                                            {% if player.selfie %}
                                                <img src="{{ url_for('static', filename='uploads/' + player.selfie) }}" 
                                                     class="challenge-player-avatar beginner" alt="{{ player.full_name }}">
                                            {% else %}
                                                <div class="challenge-player-avatar-placeholder beginner">
                                                    {{ player.full_name[0].upper() }}
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="col">
                                            <h5 class="mb-1 text-white text-bold">{{ player.full_name }}</h5>
                                            <div class="player-details">
                                                <div class="text-white mb-1">
                                                    <span class="me-3"><strong>Skill</strong> {{ player.skill_level }}</span>
                                                </div>
                                                <div class="text-white">
                                                    <span><strong>Points</strong> {{ player.ranking_points or 0 }} pts</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <div class="d-flex flex-column gap-2">
                                                <button onclick="showChallengeModal({{ player.id }}, '{{ player.full_name }}')" 
                                                        class="btn btn-challenge-beginner">
                                                    Challenge
                                                </button>
                                                <button onclick="showPlayerStats({{ player.id }})" 
                                                        class="btn btn-stats-beginner">
                                                    View Stats
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="neon-frame text-center py-5">
                        <p class="text-white-50 mb-0">No available players to challenge at the moment</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Match History -->
        {% if completed_matches %}
        <div class="row">
            <div class="col-12">
                <h2 class="section-header">
                    <i class="fas fa-history me-2"></i>Match History
                </h2>
                
                {% for match in completed_matches %}
                <div class="challenge-card completed">
                    <div class="card-body p-4">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                {% if match.opponent_selfie %}
                                    <img src="{{ url_for('static', filename='uploads/' + match.opponent_selfie) }}" 
                                         class="challenge-avatar" alt="Opponent">
                                {% else %}
                                    <div class="avatar-placeholder">
                                        {{ match.opponent_name[0].upper() }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col">
                                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
                                    <div>
                                        <h5 class="mb-1 text-white fw-bold">{{ match.opponent_name }}</h5>
                                        <div class="d-flex flex-wrap gap-2 mb-2">
                                            <span class="skill-badge">{{ match.opponent_skill }}</span>
                                            <span class="result-badge result-{{ match.result }}">{{ match.result.title() }}</span>
                                            {% if match.match_result %}
                                                <span class="record-badge">{{ match.match_result }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="match-details">
                                            <div><i class="fas fa-map-marker-alt me-2"></i>{{ match.court_location or 'Various locations' }}</div>
                                            <div><i class="fas fa-calendar me-2"></i>Completed {{ match.created_at[:10] }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Counter-Proposal Modals -->
{% for challenge in incoming_challenges %}
{% if challenge.status == 'pending' %}
<div class="modal fade" id="counterModal{{ challenge.id }}" tabindex="-1" aria-labelledby="counterModalLabel{{ challenge.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background: var(--dark-surface); border: 1px solid var(--glass-border);">
            <div class="modal-header" style="border-bottom: 1px solid var(--glass-border);">
                <h5 class="modal-title text-white text-bold neon-text" id="counterModalLabel{{ challenge.id }}">
                    <i class="fas fa-exchange-alt me-2"></i>Counter-Propose to {{ challenge.challenger_name }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="counterForm{{ challenge.id }}" action="/decline_challenge" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="challenge_id" value="{{ challenge.id }}">
                    
                    <div class="mb-3">
                        <h6 class="text-white text-bold">Current Proposal:</h6>
                        <div class="text-white-50">
                            <div><i class="fas fa-map-marker-alt me-2"></i>{{ challenge.court_location or 'Location TBD' }}</div>
                            <div><i class="fas fa-clock me-2"></i>{{ challenge.scheduled_time or 'Time TBD' }}</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-white text-bold">Alternative Location:</label>
                        <input type="text" class="form-control dark-input" name="proposed_location" 
                               placeholder="Suggest a different court or location">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-white text-bold">Alternative Date & Time:</label>
                        <input type="datetime-local" class="form-control dark-input" name="proposed_time">
                    </div>
                    
                    <div class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i>
                        Propose alternative details and they'll be notified to accept or decline your counter-offer.
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--glass-border);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning text-bold" onclick="handleCounterProposal({{ challenge.id }})">
                        <i class="fas fa-paper-plane me-1"></i>Send Counter-Proposal
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<!-- Challenge Modal -->
<div class="modal fade" id="challengeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: var(--card-bg); color: var(--text-primary);">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-handshake me-2"></i>Challenge <span id="challengePlayerName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="challengeForm" method="POST" action="{{ url_for('send_challenge_route') }}">
                    <input type="hidden" id="challengeOpponentId" name="opponent_id">
                    
                    <div class="mb-3">
                        <label class="form-label text-white text-bold">Proposed Location (Optional):</label>
                        <input type="text" id="courtLocation" class="form-control dark-input" 
                            name="court_location" placeholder="Court or location preference">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-white text-bold">Proposed Date & Time (Optional):</label>
                        <input type="datetime-local" class="form-control dark-input" name="scheduled_time">
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg text-bold">
                            <i class="fas fa-paper-plane me-2"></i>Send Challenge
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Submit Score Modal -->
<div class="modal fade" id="submitScoreModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: var(--card-bg); color: var(--text-primary);">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-trophy me-2"></i>Submit Score vs <span id="scoreOpponentName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="submitScoreForm">
                    <input type="hidden" id="scoreMatchId" name="match_id">
                    
                    <div class="mb-4">
                        <h6 class="text-white text-bold mb-3">Game Scores (Best of 3 Sets):</h6>
                        
                        <!-- Score Input Table -->
                        <div class="table-responsive">
                            <table class="table table-dark table-bordered">
                                <thead>
                                    <tr class="text-center">
                                        <th width="30%">Player</th>
                                        <th width="20%">Set 1</th>
                                        <th width="20%">Set 2</th>
                                        <th width="20%">Set 3</th>
                                        <th width="10%">Sets Won</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="text-white text-bold">You</td>
                                        <td><input type="number" class="form-control form-control-sm text-center dark-input" id="yourSet1" min="0" max="21" onchange="calculateWinner()"></td>
                                        <td><input type="number" class="form-control form-control-sm text-center dark-input" id="yourSet2" min="0" max="21" onchange="calculateWinner()"></td>
                                        <td><input type="number" class="form-control form-control-sm text-center dark-input" id="yourSet3" min="0" max="21" onchange="calculateWinner()"></td>
                                        <td class="text-center text-bold" id="yourSetsWon">0</td>
                                    </tr>
                                    <tr>
                                        <td class="text-white text-bold"><span id="opponentNameLabel"></span></td>
                                        <td><input type="number" class="form-control form-control-sm text-center dark-input" id="oppSet1" min="0" max="21" onchange="calculateWinner()"></td>
                                        <td><input type="number" class="form-control form-control-sm text-center dark-input" id="oppSet2" min="0" max="21" onchange="calculateWinner()"></td>
                                        <td><input type="number" class="form-control form-control-sm text-center dark-input" id="oppSet3" min="0" max="21" onchange="calculateWinner()"></td>
                                        <td class="text-center text-bold" id="oppSetsWon">0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="alert alert-info text-center" id="winnerDisplay" style="display: none;">
                            <i class="fas fa-trophy me-2"></i><span id="winnerText"></span>
                        </div>
                        
                        <div class="text-muted small mt-2">
                            <i class="fas fa-info-circle me-1"></i>
                            Enter the score for each set. Games are typically played to 11 points (must win by 2).
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-warning text-bold" onclick="submitMatchScore()">
                            <i class="fas fa-paper-plane me-2"></i>Submit Score
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Player Stats Modal -->
<div class="modal fade" id="playerStatsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--card-bg); color: var(--text-primary);">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-bar me-2"></i><span id="statsPlayerName"></span> Stats
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="playerStatsContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC4YOunqgW9gRhHybDYmY_78KXytRx9XZ4&libraries=places&callback=initGooglePlaces">
</script>

<script>
let map, service;

function initGooglePlaces() {
    console.log("Google Places API initialized");
}

document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("courtLocation");

    input.addEventListener("focus", function () {
        // Player's coordinates injected from Flask
        const playerLat = {{ player['location1'].split(',')[0] | safe }};
        const playerLng = {{ player['location1'].split(',')[1] | safe }};

        const playerLocation = new google.maps.LatLng(playerLat, playerLng);

        // Create a dummy map (required by PlacesService, but won’t be shown)
        map = new google.maps.Map(document.createElement("div"));
        service = new google.maps.places.PlacesService(map);

        const request = {
            location: playerLocation,
            radius: 24140, // 15 miles in meters
            keyword: "pickleball court"
        };

        service.nearbySearch(request, function (results, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                console.log("Nearby pickleball courts:", results);

                // Build a dropdown list under the input
                let dropdown = document.getElementById("courtDropdown");
                if (!dropdown) {
                    dropdown = document.createElement("ul");
                    dropdown.id = "courtDropdown";
                    dropdown.className = "list-group mt-2";
                    input.parentNode.appendChild(dropdown);
                }
                dropdown.innerHTML = "";

                results.forEach(place => {
                    const li = document.createElement("li");
                    li.className = "list-group-item list-group-item-action";
                    li.textContent = place.name + " – " + (place.vicinity || "");
                    li.onclick = () => {
                        input.value = place.name;
                        console.log("Selected court:", place);
                        dropdown.innerHTML = "";
                    };
                    dropdown.appendChild(li);
                });
            } else {
                console.error("Places search failed:", status);
            }
        });
    });
});
</script>

<!-- Match Popup -->
<div id="matchModal" class="modal fade" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white p-4 rounded-4">
      <h4 class="neon-text mb-3">Match in Progress</h4>
      <div id="matchPlayers" class="mb-4"></div>

      <div class="scoreboard text-center">
        <div class="d-flex justify-content-around align-items-center mb-4">
          <div>
            <h5 id="player1Name"></h5>
            <div class="d-flex justify-content-center align-items-center gap-2">
              <button class="btn btn-outline-light" id="p1Minus">-</button>
              <span class="fs-3" id="p1Score">0</span>
              <button class="btn btn-outline-light" id="p1Plus">+</button>
            </div>
          </div>
          <div>
            <h5 id="player2Name"></h5>
            <div class="d-flex justify-content-center align-items-center gap-2">
              <button class="btn btn-outline-light" id="p2Minus">-</button>
              <span class="fs-3" id="p2Score">0</span>
              <button class="btn btn-outline-light" id="p2Plus">+</button>
            </div>
          </div>
        </div>
      </div>

      <div class="text-center">
        <button id="finishGame" class="btn btn-success btn-lg">
          <i class="fas fa-flag-checkered me-1"></i>Finish Game
        </button>
      </div>
    </div>
  </div>
</div>

<script>
document.querySelectorAll('.start-match-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    const matchId = btn.dataset.matchId;
    const res = await fetch(`/start_match/${matchId}`);
    const data = await res.json();

    if (data.success) {
      document.getElementById('player1Name').innerText = data.player1_name;
      document.getElementById('player2Name').innerText = data.player2_name;
      document.getElementById('matchModal').dataset.matchId = matchId;
      new bootstrap.Modal(document.getElementById('matchModal')).show();
    }
  });
});

function setupScoreControls(pId, scoreId) {
  const plus = document.getElementById(`${pId}Plus`);
  const minus = document.getElementById(`${pId}Minus`);
  const score = document.getElementById(`${pId}Score`);
  plus.addEventListener('click', () => score.innerText = parseInt(score.innerText) + 1);
  minus.addEventListener('click', () => {
    if (parseInt(score.innerText) > 0)
      score.innerText = parseInt(score.innerText) - 1;
  });
}

setupScoreControls('p1', 'p1Score');
setupScoreControls('p2', 'p2Score');

document.getElementById('finishGame').addEventListener('click', async () => {
  const modal = document.getElementById('matchModal');
  const matchId = modal.dataset.matchId;
  const p1Score = parseInt(document.getElementById('p1Score').innerText);
  const p2Score = parseInt(document.getElementById('p2Score').innerText);

  const res = await fetch('/complete_match', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({match_id: matchId, player1_score: p1Score, player2_score: p2Score})
  });
  const result = await res.json();

  if (result.success) {
    alert('Game finished! ' + result.message);
    location.reload();
  } else {
    alert('Error: ' + result.message);
  }
});
</script>

<script>
    

    
// Challenge Modal Functions
function showChallengeModal(playerId, playerName) {
    document.getElementById('challengePlayerName').textContent = playerName;
    document.getElementById('challengeOpponentId').value = playerId;
    const modal = new bootstrap.Modal(document.getElementById('challengeModal'));
    modal.show();
}

// Submit Score Modal Functions
function showSubmitScore(matchId, opponentName) {
    document.getElementById('scoreMatchId').value = matchId;
    document.getElementById('scoreOpponentName').textContent = opponentName;
    document.getElementById('opponentNameLabel').textContent = opponentName;
    
    // Reset form - clear all score inputs
    ['yourSet1', 'yourSet2', 'yourSet3', 'oppSet1', 'oppSet2', 'oppSet3'].forEach(id => {
        document.getElementById(id).value = '';
    });
    document.getElementById('yourSetsWon').textContent = '0';
    document.getElementById('oppSetsWon').textContent = '0';
    document.getElementById('winnerDisplay').style.display = 'none';
    
    const modal = new bootstrap.Modal(document.getElementById('submitScoreModal'));
    modal.show();
}

function calculateWinner() {
    const yourScores = [
        parseInt(document.getElementById('yourSet1').value) || null,
        parseInt(document.getElementById('yourSet2').value) || null,
        parseInt(document.getElementById('yourSet3').value) || null
    ];
    
    const oppScores = [
        parseInt(document.getElementById('oppSet1').value) || null,
        parseInt(document.getElementById('oppSet2').value) || null,
        parseInt(document.getElementById('oppSet3').value) || null
    ];
    
    let yourSets = 0;
    let oppSets = 0;
    
    // Calculate sets won
    for (let i = 0; i < 3; i++) {
        if (yourScores[i] !== null && oppScores[i] !== null) {
            if (yourScores[i] > oppScores[i]) {
                yourSets++;
            } else if (oppScores[i] > yourScores[i]) {
                oppSets++;
            }
        }
    }
    
    // Update sets won display
    document.getElementById('yourSetsWon').textContent = yourSets;
    document.getElementById('oppSetsWon').textContent = oppSets;
    
    // Show winner if match is complete
    const winnerDisplay = document.getElementById('winnerDisplay');
    const winnerText = document.getElementById('winnerText');
    
    if (yourSets === 2) {
        winnerText.textContent = 'You Win!';
        winnerDisplay.className = 'alert alert-success text-center';
        winnerDisplay.style.display = 'block';
    } else if (oppSets === 2) {
        winnerText.textContent = document.getElementById('opponentNameLabel').textContent + ' Wins!';
        winnerDisplay.className = 'alert alert-warning text-center';
        winnerDisplay.style.display = 'block';
    } else {
        winnerDisplay.style.display = 'none';
    }
}

function submitMatchScore() {
    const matchId = document.getElementById('scoreMatchId').value;
    
    // Collect all scores
    const yourScores = [
        parseInt(document.getElementById('yourSet1').value) || null,
        parseInt(document.getElementById('yourSet2').value) || null,
        parseInt(document.getElementById('yourSet3').value) || null
    ];
    
    const oppScores = [
        parseInt(document.getElementById('oppSet1').value) || null,
        parseInt(document.getElementById('oppSet2').value) || null,
        parseInt(document.getElementById('oppSet3').value) || null
    ];
    
    // Calculate sets won
    let yourSets = 0;
    let oppSets = 0;
    let validSets = 0;
    let scoreString = '';
    
    for (let i = 0; i < 3; i++) {
        if (yourScores[i] !== null && oppScores[i] !== null) {
            validSets++;
            if (scoreString) scoreString += ' ';
            scoreString += `${yourScores[i]}-${oppScores[i]}`;
            
            if (yourScores[i] > oppScores[i]) {
                yourSets++;
            } else if (oppScores[i] > yourScores[i]) {
                oppSets++;
            }
        }
    }
    
    // Validation
    if (validSets < 2) {
        alert('Please enter scores for at least 2 sets');
        return;
    }
    
    if (yourSets === oppSets) {
        alert('Please enter a winner - matches cannot be tied');
        return;
    }
    
    if (yourSets < 2 && oppSets < 2) {
        alert('One player must win at least 2 sets');
        return;
    }
    
    // Submit to server
    fetch('/submit_match_result', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            match_id: matchId,
            player1_sets_won: yourSets,
            player2_sets_won: oppSets,
            match_score: scoreString
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Score submitted successfully! Waiting for opponent validation.');
            bootstrap.Modal.getInstance(document.getElementById('submitScoreModal')).hide();
            location.reload(); // Refresh to update the UI
        } else {
            alert('Error: ' + (data.message || 'Unable to submit score'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error submitting score. Please try again.');
    });
}

// Player Stats Modal Functions
function showPlayerStats(playerId) {
    const modal = new bootstrap.Modal(document.getElementById('playerStatsModal'));
    
    // Reset content
    document.getElementById('playerStatsContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    // Fetch player stats
    fetch(`/api/player_stats/${playerId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const player = data.player;
                document.getElementById('statsPlayerName').textContent = player.full_name;
                
                const winRate = (player.wins + player.losses) > 0 ? 
                    Math.round((player.wins / (player.wins + player.losses)) * 100) : 0;
                
                document.getElementById('playerStatsContent').innerHTML = `
                    <div class="row text-center mb-4">
                        <div class="col-4">
                            <div class="neon-frame p-3">
                                <div class="text-neon-green text-bold h3">${player.wins || 0}</div>
                                <div class="text-white">Wins</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="neon-frame p-3">
                                <div class="text-danger text-bold h3">${player.losses || 0}</div>
                                <div class="text-white">Losses</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="neon-frame p-3">
                                <div class="text-neon text-bold h3">${winRate}%</div>
                                <div class="text-white">Win Rate</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-6">
                            <div class="text-center">
                                <h6 class="text-white text-bold">Skill Level</h6>
                                <span class="badge badge-primary">${player.skill_level}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h6 class="text-white text-bold">Ranking Points</h6>
                                <span class="badge badge-warning">${player.ranking_points || 0} pts</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <h6 class="text-white text-bold">Total Matches</h6>
                                <span class="text-white">${(player.wins || 0) + (player.losses || 0)}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h6 class="text-white text-bold">Location</h6>
                                <span class="text-white">${player.location || 'Not specified'}</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('playerStatsContent').innerHTML = `
                    <div class="text-center text-danger">
                        <p>Unable to load player stats</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error fetching player stats:', error);
            document.getElementById('playerStatsContent').innerHTML = `
                <div class="text-center text-danger">
                    <p>Error loading player stats</p>
                </div>
            `;
        });
}
</script>

<script>
function handleCounterProposal(challengeId) {
    event.preventDefault();
    
    const form = document.getElementById('counterForm' + challengeId);
    const formData = new FormData(form);
    
    // Prepare the data for the backend
    const data = {
        challenge_id: formData.get('challenge_id'),
        proposed_location: formData.get('proposed_location'),
        proposed_time: formData.get('proposed_time'),
        player_id: {{ session.get('current_player_id', 'null') }}
    };
    
    fetch('/decline_challenge', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message and reload page
            alert(data.message);
            window.location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to send counter-proposal. Please try again.');
    });
}
</script>



{% endblock %}