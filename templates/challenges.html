{% extends "base.html" %}

{% block title %}Challenges - Ready 2 Dink{% endblock %}

{% block content %}


<div class="challenges-container">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="text-center mb-5">
                    <h1 class="display-4 text-bold mb-3 neon-text">
                        <i class="fas fa-swords me-3"></i>Challenges
                    </h1>
                    <p class="lead text-white text-bold">Challenge other players and manage your matches</p>
                </div>
            </div>
        </div>

        <!-- Incoming Challenges -->
        <div class="row mb-5">
            <div class="col-12">
                <h2 class="text-bold mb-4 neon-text">
                    <i class="fas fa-inbox me-2"></i>Incoming Challenges
                </h2>
                
                {% if incoming_challenges %}
                    {% for challenge in incoming_challenges %}
                    <div class="neon-frame challenge-card incoming mb-4">
                        <div class="card-body p-4">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    {% if challenge.challenger_selfie %}
                                        <img src="{{ url_for('static', filename='uploads/' + challenge.challenger_selfie) }}" 
                                             class="challenge-avatar" alt="Challenger">
                                    {% else %}
                                        <div class="avatar-placeholder">
                                            {{ challenge.challenger_name[0].upper() }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col">
                                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
                                        <div>
                                            <h5 class="mb-1 text-white text-bold neon-text">{{ challenge.challenger_username }}</h5>
                                            <div class="d-flex flex-wrap gap-2 mb-2">
                                                <span class="badge badge-success text-bold">{{ challenge.challenger_skill }}</span>
                                                <span class="badge badge-primary text-bold">{{ challenge.challenger_wins or 0 }}W-{{ challenge.challenger_losses or 0 }}L</span>
                                                {% if challenge.status == 'pending' %}<span class="badge badge-warning text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% elif challenge.status == 'confirmed' %}<span class="badge badge-success text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% elif challenge.status == 'counter_proposed' %}<span class="badge badge-primary text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% elif challenge.status == 'declined' %}<span class="badge badge-danger text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% else %}<span class="badge badge-secondary text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>{% endif %}
                                            </div>
                                            <div class="match-details">
                                                <div class="text-white text-bold"><i class="fas fa-map-marker-alt me-2 text-neon"></i>{{ challenge.court_location or 'Location TBD' }}</div>
                                                <div class="text-white text-bold"><i class="fas fa-clock me-2 text-neon"></i>{{ challenge.scheduled_time or 'Time TBD' }}</div>
                                                <div class="text-white text-bold"><i class="fas fa-calendar me-2 text-neon"></i>Challenged {{ challenge.created_at.strftime('%Y-%m-%d') }}</div>
                                            </div>
                                        </div>
                                        <div class="mt-3 mt-md-0">
                                            {% if challenge.status == 'pending' %}
                                                <form method="POST" action="{{ url_for('accept_challenge', challenge_id=challenge.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-success text-bold me-2">
                                                        <i class="fas fa-check me-1"></i>Accept
                                                    </button>
                                                </form>
                                                <button type="button" class="btn btn-warning text-bold me-2" 
                                                        data-bs-toggle="modal" data-bs-target="#counterModal{{ challenge.id }}">
                                                    <i class="fas fa-exchange-alt me-1"></i>Counter-Propose
                                                </button>
                                                <form method="POST" action="{{ url_for('decline_challenge', challenge_id=challenge.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-danger text-bold" onclick="return confirm('Are you sure you want to decline this challenge?')">
                                                        <i class="fas fa-times me-1"></i>Decline
                                                    </button>
                                                </form>
                                            {% elif challenge.status == 'counter_proposed' %}
                                                <form method="POST" action="{{ url_for('accept_challenge', challenge_id=challenge.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-success text-bold me-2">
                                                        <i class="fas fa-handshake me-1"></i>Accept Counter
                                                    </button>
                                                </form>
                                                <form method="POST" action="{{ url_for('decline_challenge', challenge_id=challenge.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-danger text-bold" onclick="return confirm('Are you sure you want to decline this challenge?')">
                                                        <i class="fas fa-times me-1"></i>Decline
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="neon-frame mb-4">
                        <div class="empty-state">
                            <i class="fas fa-inbox text-neon"></i>
                            <h5 class="text-white mb-2 text-bold neon-text">No Incoming Challenges</h5>
                            <p>When other players challenge you, they'll appear here</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Outgoing Challenges -->
        <div class="row mb-5">
            <div class="col-12">
                <h2 class="text-bold mb-4 neon-text">
                    <i class="fas fa-paper-plane me-2"></i>Sent Challenges
                </h2>
                
                {% if outgoing_challenges %}
                    {% for challenge in outgoing_challenges %}
                    <div class="neon-frame challenge-card outgoing mb-4">
                        <div class="card-body p-4">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    {% if challenge.opponent_selfie %}
                                        <img src="{{ url_for('static', filename='uploads/' + challenge.opponent_selfie) }}" 
                                             class="challenge-avatar" alt="Opponent">
                                    {% else %}
                                        <div class="avatar-placeholder">
                                            {{ challenge.opponent_username }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col">
                                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
                                        <div>
                                            <h5 class="mb-1 text-white text-bold neon-text">{{ challenge.opponent_username }}</h5>
                                            <div class="d-flex flex-wrap gap-2 mb-2">
                                                <span class="badge badge-success text-bold">{{ challenge.opponent_skill }}</span>
                                                <span class="badge badge-primary text-bold">{{ challenge.opponent_wins or 0 }}W-{{ challenge.opponent_losses or 0 }}L</span>
                                                {% if challenge.status == 'pending' %}<span class="badge badge-warning text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% elif challenge.status == 'confirmed' %}<span class="badge badge-success text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% elif challenge.status == 'counter_proposed' %}<span class="badge badge-primary text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% elif challenge.status == 'declined' %}<span class="badge badge-danger text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>
                                                {% else %}<span class="badge badge-secondary text-bold">{{ challenge.status.replace('_', ' ').title() }}</span>{% endif %}
                                            </div>
                                            <div class="match-details">
                                                <div class="text-white text-bold"><i class="fas fa-map-marker-alt me-2 text-neon"></i>{{ challenge.court_location or 'Location TBD' }}</div>
                                                <div class="text-white text-bold"><i class="fas fa-clock me-2 text-neon"></i>{{ challenge.scheduled_time or 'Time TBD' }}</div>
                                                <div class="text-white text-bold"><i class="fas fa-calendar me-2 text-neon"></i>Sent {{ challenge.created_at.strftime('%Y-%m-%d') }}</div>
                                            </div>
                                        </div>
                                        <div class="mt-3 mt-md-0">
                                            {% if challenge.status == 'pending' %}
                                                <span class="badge bg-warning">
                                                    <i class="fas fa-hourglass-half me-1"></i>Waiting for Response
                                                </span>
                                            {% elif challenge.status == 'counter_proposed' %}
                                                <span class="badge bg-info">
                                                    <i class="fas fa-exchange-alt me-1"></i>Counter-Proposed
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="neon-frame mb-4">
                        <div class="empty-state">
                            <i class="fas fa-paper-plane text-neon"></i>
                            <h5 class="text-white mb-2 text-bold neon-text">No Sent Challenges</h5>
                            <p>Challenge other players below to get started</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Past Due Matches - Need Score Submission -->
        {% set past_due_matches = confirmed_matches|selectattr("time_status", "equalto", "past_due")|list %}
        {% if past_due_matches %}
        <div class="row mb-5">
            <div class="col-12">
                <h2 class="text-bold mb-4 neon-text">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>Submit Score - Past Due Matches
                </h2>
                
                {% for match in past_due_matches %}
                <div class="neon-frame challenge-card past-due mb-4">
                    <div class="card-body p-4">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                {% if match.opponent_selfie %}
                                    <img src="{{ url_for('static', filename='uploads/' + match.opponent_selfie) }}" 
                                         class="challenge-avatar" alt="Opponent">
                                {% else %}
                                    <div class="avatar-placeholder">
                                        {{ match.opponent_username }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col">
                                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
                                    <div>
                                        <h5 class="mb-1 text-white text-bold neon-text">{{ match.opponent_username }}</h5>
                                        <div class="d-flex flex-wrap gap-2 mb-2">
                                            <span class="badge badge-success text-bold">{{ match.opponent_skill }}</span>
                                            <span class="badge badge-warning text-bold">Score Needed</span>
                                        </div>
                                        <div class="match-details">
                                            <div class="text-white text-bold"><i class="fas fa-map-marker-alt me-2 text-neon"></i>{{ match.court_location or 'Location TBD' }}</div>
                                            <div class="text-white text-bold"><i class="fas fa-clock me-2 text-neon"></i>{{ match.scheduled_time or 'Time TBD' }}</div>
                                            <div class="text-white text-bold"><i class="fas fa-calendar me-2 text-neon"></i>Confirmed {{ match.created_at.strftime('%Y-%m-%d') }}</div>
                                        </div>
                                    </div>
                                    <div class="mt-3 mt-md-0">
                                        <button class="btn btn-warning btn-sm text-bold" 
                                                onclick="showSubmitScore({{ match.id }}, '{{ match.opponent_username }}')">
                                            <i class="fas fa-trophy me-1"></i>Submit Score
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Confirmed Matches - Still Upcoming -->
{% if confirmed_matches %}
<div class="row mb-5">
    <div class="col-12">
        <h2 class="text-bold mb-4 neon-text">
            <i class="fas fa-calendar-check me-2"></i>Confirmed Matches
        </h2>

        {% for match in confirmed_matches %}
<div class="neon-frame challenge-card confirmed mb-4"
     data-username="{{ match.opponent_username }}">
    <div class="card-body p-4">
        <div class="row align-items-center">

            <div class="col">
                <h5 class="mb-1 text-white text-bold neon-text">
                    {{ match.opponent_username }}
                </h5>
                <div class="d-flex flex-wrap gap-2 mb-2">
                    <span class="badge badge-success text-bold">{{ match.opponent_skill }}</span>
                    <span class="badge badge-success text-bold">Confirmed</span>
                </div>
            </div>

            <div class="col-auto">
                <button class="btn btn-success btn-lg start-match-btn"
                        data-match-id="{{ match.id }}">
                    <i class="fas fa-play-circle me-1"></i>Start Match
                </button>
            </div>

        </div>
    </div>
</div>
{% endfor %}
    </div>
</div>
{% endif %}

        <div class="row mb-5">
    <div class="col-12 text-center">
        <h2 class="text-bold mb-4 neon-text">
            <i class="fas fa-random me-2"></i>Random Matchup
        </h2>

        <p class="text-white-50 mb-4">
            Click below to automatically find a nearby opponent with similar skill level.
        </p>

        <button class="btn btn-lg btn-primary px-5 py-3"
                onclick="findRandomMatchup()">
            ðŸŽ² Random Matchup
        </button>

        <div id="randomMatchupStatus" class="mt-4 text-white-50"></div>
    </div>
</div>

        <!-- Match History -->
        {% if completed_matches %}
        <div class="row">
            <div class="col-12">
                <h2 class="section-header">
                    <i class="fas fa-history me-2"></i>Match History
                </h2>
                
                {% for match in completed_matches %}
                <div class="challenge-card completed">

    <div class="card-body p-4">
        <div class="row align-items-center">
            <div class="col-auto">
                {% if match.opponent_selfie %}
                    <img src="{{ url_for('static', filename='uploads/' + match.opponent_selfie) }}" 
                         class="challenge-avatar" alt="Opponent">
                {% else %}
                    <div class="avatar-placeholder">
                        {{ match.opponent_username}}
                    </div>
                {% endif %}
            </div>
            <div class="col">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
                    <div>
                        <h5 class="mb-1 text-white fw-bold">{{ match.opponent_username }}</h5>
                        <div class="d-flex flex-wrap gap-2 mb-2">
                            <span class="skill-badge">{{ match.opponent_skill }}</span>
                            {% if match.winner_id %}
                        {% if match.winner_id == current_player_id %}
                            <span class="result-badge result-won">Won</span>
                            {% else %}
                            <span class="result-badge result-lost">Lost</span>
                                {% endif %}
                            {% else %}
                                <span class="result-badge">TBD</span>
                            {% endif %}
                                <span class="result-badge">{{match.match_result}}</span>
                        </div>
                        <div class="match-details">
                            <div><i class="fas fa-map-marker-alt me-2"></i>{{ match.court_location or 'Various locations' }}</div>
                            <div><i class="fas fa-calendar me-2"></i>Completed {{ match.created_at.strftime('%Y-%m-%d') }}</div>
                        </div>
                    </div>
                    <!-- ðŸ†• Rematch Button -->
                    <button class="btn btn-sm btn-outline-light mt-3 mt-md-0" 
                         onclick="rematch({{ match.id }})">
                    <i class="fas fa-redo me-1"></i> Rematch
                    </button>
                </div>
            </div>
        </div>
    </div>

                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Counter-Proposal Modals -->
{% for challenge in incoming_challenges %}
{% if challenge.status == 'pending' %}
<div class="modal fade" id="counterModal{{ challenge.id }}" tabindex="-1" aria-labelledby="counterModalLabel{{ challenge.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background: var(--dark-surface); border: 1px solid var(--glass-border);">
            <div class="modal-header" style="border-bottom: 1px solid var(--glass-border);">
                <h5 class="modal-title text-white text-bold neon-text" id="counterModalLabel{{ challenge.id }}">
                    <i class="fas fa-exchange-alt me-2"></i>Counter-Propose to {{ challenge.challenger_username }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="counterForm{{ challenge.id }}" action="/decline_challenge" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="challenge_id" value="{{ challenge.id }}">
                    
                    <div class="mb-3">
                        <h6 class="text-white text-bold">Current Proposal:</h6>
                        <div class="text-white-50">
                            <div><i class="fas fa-map-marker-alt me-2"></i>{{ challenge.court_location or 'Location TBD' }}</div>
                            <div><i class="fas fa-clock me-2"></i>{{ challenge.scheduled_time or 'Time TBD' }}</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-white text-bold">Alternative Location:</label>
                        <input type="text" class="form-control dark-input" name="proposed_location" 
                               placeholder="Suggest a different court or location">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-white text-bold">Alternative Date & Time:</label>
                        <input type="datetime-local" class="form-control dark-input" name="proposed_time">
                    </div>
                    
                    <div class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i>
                        Propose alternative details and they'll be notified to accept or decline your counter-offer.
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--glass-border);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning text-bold" onclick="handleCounterProposal({{ challenge.id }})">
                        <i class="fas fa-paper-plane me-1"></i>Send Counter-Proposal
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<!-- Challenge Modal -->
!-- Challenge Modal -->
<div class="modal fade" id="challengeModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content" style="background: var(--card-bg); color: var(--text-primary);">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-handshake me-2"></i>
          Challenge <span id="challengePlayerName" class="text-info"></span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="challengeForm" onsubmit="event.preventDefault(); sendChallenge();">
          <!-- Hidden IDs -->
          <input type="hidden" id="opponent_id">
          <input type="hidden" id="partner1_id">
          <input type="hidden" id="partner2_id">

          <div class="mb-3">
            <label for="partner1" class="form-label">Your Partner (optional for doubles)</label>
            <input type="text" id="partner1" class="form-control" placeholder="Search your partner...">
          </div>

          <div class="mb-3">
            <label for="partner2" class="form-label">Opponentâ€™s Partner (optional for doubles)</label>
            <input type="text" id="partner2" class="form-control" placeholder="Search opponentâ€™s partner...">
          </div>

          <div class="mb-3">
            <label class="form-label text-white text-bold">Proposed Location (Optional):</label>
            <input type="text" id="courtLocation" class="form-control dark-input" placeholder="Court or location preference">
            <div id="courtDropdownContainer"></div>
          </div>

          <div class="mb-3">
            <label class="form-label text-white text-bold">Proposed Date & Time (Optional):</label>
            <input type="datetime-local" id="scheduled_time" class="form-control dark-input">
          </div>

          <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg text-bold">
                            <i class="fas fa-paper-plane me-2"></i>Send Challenge
                        </button>
                    </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Submit Score Modal -->
<div class="modal fade" id="submitScoreModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content" style="background: var(--card-bg); color: var(--text-primary);">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-trophy me-2"></i>
          Submit Score: <span id="team1Label"></span> <span class="text-warning mx-1">vs</span> <span id="team2Label"></span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="submitScoreForm">
          <input type="hidden" id="scoreMatchId" name="match_id">

          <div class="mb-4">
            <h6 class="text-white text-bold mb-3">Game Scores (Best of 3 Sets):</h6>

            <!-- Score Input Table -->
            <div class="table-responsive">
              <table class="table table-dark table-bordered">
                <thead>
                  <tr class="text-center">
                    <th width="30%">Team</th>
                    <th width="20%">Set 1</th>
                    <th width="20%">Set 2</th>
                    <th width="20%">Set 3</th>
                    <th width="10%">Sets Won</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <!-- Team 1 label (Player 1 + Player 3 if doubles) -->
                    <td class="text-white text-bold"><span id="team1Name">Your Team</span></td>
                    <td><input type="number" class="form-control form-control-sm text-center dark-input" id="team1Set1" min="0" max="21" onchange="calculateWinner()"></td>
                    <td><input type="number" class="form-control form-control-sm text-center dark-input" id="team1Set2" min="0" max="21" onchange="calculateWinner()"></td>
                    <td><input type="number" class="form-control form-control-sm text-center dark-input" id="team1Set3" min="0" max="21" onchange="calculateWinner()"></td>
                    <td class="text-center text-bold" id="team1SetsWon">0</td>
                  </tr>
                  <tr>
                    <!-- Team 2 label (Player 2 + Player 4 if doubles) -->
                    <td class="text-white text-bold"><span id="team2Name">Opponent Team</span></td>
                    <td><input type="number" class="form-control form-control-sm text-center dark-input" id="team2Set1" min="0" max="21" onchange="calculateWinner()"></td>
                    <td><input type="number" class="form-control form-control-sm text-center dark-input" id="team2Set2" min="0" max="21" onchange="calculateWinner()"></td>
                    <td><input type="number" class="form-control form-control-sm text-center dark-input" id="team2Set3" min="0" max="21" onchange="calculateWinner()"></td>
                    <td class="text-center text-bold" id="team2SetsWon">0</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="alert alert-info text-center" id="winnerDisplay" style="display: none;">
              <i class="fas fa-trophy me-2"></i><span id="winnerText"></span>
            </div>

            <div class="text-muted small mt-2">
              <i class="fas fa-info-circle me-1"></i>
              Enter the score for each set. Games are typically played to 11 points (must win by 2).
            </div>
          </div>

          <div class="text-center">
            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-warning text-bold" onclick="submitMatchScore()">
              <i class="fas fa-paper-plane me-2"></i>Submit Score
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Player Stats Modal -->
<div class="modal fade" id="playerStatsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--card-bg); color: var(--text-primary);">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-bar me-2"></i><span id="statsPlayerName"></span> Stats
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="playerStatsContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC4YOunqgW9gRhHybDYmY_78KXytRx9XZ4&libraries=places&callback=initGooglePlaces">
</script>

<script>
function findRandomMatchup() {
    const status = document.getElementById("randomMatchupStatus");
    status.innerHTML = "Searching for players nearby...";

    fetch("/matchmaking/random", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) {
            status.innerHTML = `<span class="text-danger">${data.message}</span>`;
            return;
        }

        // Automatically send challenge
        fetch("/challenges/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                opponent_id: data.opponent_id,
                sport: "Pickleball",
                court_location: "TBD",
                match_date: data.default_match_date,
                scheduled_time: data.default_match_time
            })
        })
        .then(res => res.json())
        .then(challenge => {
            if (!challenge.success) {
                status.innerHTML = `<span class="text-danger">${challenge.error}</span>`;
                return;
            }

            status.innerHTML = `
                <span class="text-success">
                    Match Created!<br>
                    <strong>${challenge.team1.join(" & ")} vs ${challenge.team2.join(" & ")}</strong>
                </span>
            `;
        });
    })
    .catch(err => {
        status.innerHTML = `<span class="text-danger">Error: ${err}</span>`;
    });
}

async function rematch(matchId) {
    if (!confirm("Start a rematch with the same players?")) return;
    try {
        const response = await fetch(`/rematch/${matchId}`, {
            method: 'POST'
        });
        if (response.ok) {
            alert("Rematch created successfully!");
            location.reload();
        } else {
            const data = await response.json();
            alert("Failed to create rematch: " + (data.error || response.statusText));
        }
    } catch (err) {
        console.error(err);
        alert("An error occurred while creating the rematch.");
    }
}
</script>

<script>
let map, service;

function initGooglePlaces() {
    console.log("Google Places API initialized");
}

document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("courtLocation");

    input.addEventListener("focus", function () {
        // Player's coordinates injected from Flask
        const playerLat = {{ player['latitude'] }};
        const playerLng = {{ player['longitude'] }};

        const playerLocation = new google.maps.LatLng(playerLat, playerLng);

        // Create a dummy map (required by PlacesService, but wonâ€™t be shown)
        map = new google.maps.Map(document.createElement("div"));
        service = new google.maps.places.PlacesService(map);

        const request = {
            location: playerLocation,
            radius: 24140, // 15 miles in meters
            keyword: "pickleball court"
        };

        service.nearbySearch(request, function (results, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                console.log("Nearby pickleball courts:", results);

                // Build a dropdown list under the input
                let dropdown = document.getElementById("courtDropdown");
                if (!dropdown) {
                    dropdown = document.createElement("ul");
                    dropdown.id = "courtDropdown";
                    dropdown.className = "list-group mt-2";
                    input.parentNode.appendChild(dropdown);
                }
                dropdown.innerHTML = "";

                results.forEach(place => {
                    const li = document.createElement("li");
                    li.className = "list-group-item list-group-item-action";
                    li.textContent = place.name + " â€“ " + (place.vicinity || "");
                    li.onclick = () => {
                        input.value = place.name;
                        console.log("Selected court:", place);
                        dropdown.innerHTML = "";
                    };
                    dropdown.appendChild(li);
                });
            } else {
                console.error("Places search failed:", status);
            }
        });
    });
});
</script>

<!-- Match Popup -->
<div id="matchModal" class="modal fade" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white p-4 rounded-4">
      <h4 class="neon-text mb-3">Match in Progress</h4>
      <div id="matchPlayers" class="mb-4"></div>

      <div class="scoreboard text-center">
        <div class="d-flex justify-content-around align-items-center mb-4">
          <div>
            <h5 id="player1Name"></h5>
            <div class="d-flex justify-content-center align-items-center gap-2">
              <button class="btn btn-outline-light" id="p1Minus">-</button>
              <span class="fs-3" id="p1Score">0</span>
              <button class="btn btn-outline-light" id="p1Plus">+</button>
            </div>
          </div>
          <div>
            <h5 id="player2Name"></h5>
            <div class="d-flex justify-content-center align-items-center gap-2">
              <button class="btn btn-outline-light" id="p2Minus">-</button>
              <span class="fs-3" id="p2Score">0</span>
              <button class="btn btn-outline-light" id="p2Plus">+</button>
            </div>
          </div>
        </div>
      </div>

      <div class="text-center">
        <button id="finishGame" class="btn btn-success btn-lg">
          <i class="fas fa-flag-checkered me-1"></i>Finish Game
        </button>
      </div>
    </div>
  </div>
</div>

<script>
document.querySelectorAll('.start-match-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const card = btn.closest('.challenge-card');

    // Always read username from dataset
    const opponentName = card.dataset.username;

    const matchId = btn.dataset.matchId;
    showSubmitScore(matchId, opponentName);
  });
});
</script>

<script>
    

    
// Challenge Modal Functions
function showChallengeModal(opponentId, opponentName) {
    // Fill in opponent info
    document.getElementById("opponent_id").value = opponentId;
    document.getElementById("challengePlayerName").innerText = opponentName;

    // Reset partner fields
    document.getElementById("partner1").value = "";
    document.getElementById("partner2").value = "";
    document.getElementById("partner1_id").value = "";
    document.getElementById("partner2_id").value = "";

    const modal = new bootstrap.Modal(document.getElementById("challengeModal"));
    modal.show();
}


// Submit Score Modal Functions
function showSubmitScore(matchId, opponentName) {
  fetch(`/start_match/${matchId}`)
    .then(response => response.json())
    .then(data => {
      if (!data.success) return alert("Error loading match info.");
      console.log(data);

      // Build team labels
      const team1 = [data.player1_name];
      const team2 = [data.player2_name];
      if (data.player3_name) team1.push(data.player3_name);
      if (data.player4_name) team2.push(data.player4_name);

      const team1Label = team1.join(" & ");
      const team2Label = team2.join(" & ");

      // Set modal values
      document.getElementById("scoreMatchId").value = matchId;
      document.getElementById("team1Label").textContent = team1Label;
      document.getElementById("team2Label").textContent = team2Label;
      document.getElementById("team1Name").textContent = team1Label;
      document.getElementById("team2Name").textContent = team2Label;

      // Show modal
      const modal = new bootstrap.Modal(document.getElementById("submitScoreModal"));
      modal.show();
    })
    .catch(err => {
      console.error(err);
      alert("Failed to load match info.");
    });
}

function calculateWinner() {
    const team1Scores = [
        parseInt(document.getElementById('team1Set1').value) || null,
        parseInt(document.getElementById('team1Set2').value) || null,
        parseInt(document.getElementById('team1Set3').value) || null
    ];
    
    const team2Scores = [
        parseInt(document.getElementById('team2Set1').value) || null,
        parseInt(document.getElementById('team2Set2').value) || null,
        parseInt(document.getElementById('team2Set3').value) || null
    ];
    
    let team1Sets = 0;
    let team2Sets = 0;
    
    // Calculate sets won
    for (let i = 0; i < 3; i++) {
        if (team1Scores[i] !== null && team2Scores[i] !== null) {
            if (team1Scores[i] > team2Scores[i]) {
                team1Sets++;
            } else if (team2Scores[i] > team1Scores[i]) {
                team2Sets++;
            }
        }
    }
    
    // Update set totals in table
    document.getElementById('team1SetsWon').textContent = team1Sets;
    document.getElementById('team2SetsWon').textContent = team2Sets;
    
    // Winner alert logic
    const winnerDisplay = document.getElementById('winnerDisplay');
    const winnerText = document.getElementById('winnerText');
    const team1Name = document.getElementById('team1Name').textContent;
    const team2Name = document.getElementById('team2Name').textContent;
    
    if (team1Sets === 2) {
        winnerText.textContent = `${team1Name} Win!`;
        winnerDisplay.className = 'alert alert-success text-center';
        winnerDisplay.style.display = 'block';
    } else if (team2Sets === 2) {
        winnerText.textContent = `${team2Name} Win!`;
        winnerDisplay.className = 'alert alert-warning text-center';
        winnerDisplay.style.display = 'block';
    } else {
        winnerDisplay.style.display = 'none';
    }
}
function submitMatchScore() {
    const matchId = document.getElementById("scoreMatchId").value;
    //const match_score = `${team1Scores[0]}-${team2Scores[0]} ${team1Scores[1]}-${team2Scores[1]} ${team1Scores[2]}-${team2Scores[2]}`;

    // Collect per-set scores
    const team1Scores = [
        parseInt(document.getElementById('team1Set1').value) || 0,
        parseInt(document.getElementById('team1Set2').value) || 0,
        parseInt(document.getElementById('team1Set3').value) || 0
    ];

    const team2Scores = [
        parseInt(document.getElementById('team2Set1').value) || 0,
        parseInt(document.getElementById('team2Set2').value) || 0,
        parseInt(document.getElementById('team2Set3').value) || 0
    ];

    // Compute total points for tie-breaking or verification
    const team1Total = team1Scores.reduce((a, b) => a + b, 0);
    const team2Total = team2Scores.reduce((a, b) => a + b, 0);

    // Count sets won
    let team1Sets = 0;
    let team2Sets = 0;
    for (let i = 0; i < 3; i++) {
        if (team1Scores[i] > team2Scores[i]) team1Sets++;
        else if (team2Scores[i] > team1Scores[i]) team2Sets++;
    }

    // Determine winner
    let winner = null;
    if (team1Sets > team2Sets) {
        winner = "team1";
    } else if (team2Sets > team1Sets) {
        winner = "team2";
    }

    if (!winner) {
        alert("Please complete the sets before submitting a final score.");
        return;
    }

    const payload = {
    match_id: matchId,
    match_score: `${team1Scores.join('-')} ${team2Scores.join('-')}`,
    player1_sets_won: team1Sets,
    player2_sets_won: team2Sets
    };

   fetch("/submit_match_result", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
})
.then(response => response.json())
.then(data => {
    if (data.success) {
        alert("âœ… Score submitted successfully!");
        location.reload();
    } else {
        alert("âš ï¸ Error submitting score: " + data.message);
    }
})
.catch(err => {
    console.error(err);
    alert("Error submitting match score.");
});
}

// Player Stats Modal Functions
function showPlayerStats(playerId) {
    const modal = new bootstrap.Modal(document.getElementById('playerStatsModal'));
    
    // Reset content
    document.getElementById('playerStatsContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    // Fetch player stats
    fetch(`/api/player_stats/${playerId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const player = data.player;
                document.getElementById('statsPlayerName').textContent = player.full_name;
                
                const winRate = (player.wins + player.losses) > 0 ? 
                    Math.round((player.wins / (player.wins + player.losses)) * 100) : 0;
                
                document.getElementById('playerStatsContent').innerHTML = `
                    <div class="row text-center mb-4">
                        <div class="col-4">
                            <div class="neon-frame p-3">
                                <div class="text-neon-green text-bold h3">${player.wins || 0}</div>
                                <div class="text-white">Wins</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="neon-frame p-3">
                                <div class="text-danger text-bold h3">${player.losses || 0}</div>
                                <div class="text-white">Losses</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="neon-frame p-3">
                                <div class="text-neon text-bold h3">${winRate}%</div>
                                <div class="text-white">Win Rate</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-6">
                            <div class="text-center">
                                <h6 class="text-white text-bold">Skill Level</h6>
                                <span class="badge badge-primary">${player.skill_level}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h6 class="text-white text-bold">Ranking Points</h6>
                                <span class="badge badge-warning">${player.ranking_points || 0} pts</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <h6 class="text-white text-bold">Total Matches</h6>
                                <span class="text-white">${(player.wins || 0) + (player.losses || 0)}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h6 class="text-white text-bold">Location</h6>
                                <span class="text-white">${player.location || 'Not specified'}</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('playerStatsContent').innerHTML = `
                    <div class="text-center text-danger">
                        <p>Unable to load player stats</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error fetching player stats:', error);
            document.getElementById('playerStatsContent').innerHTML = `
                <div class="text-center text-danger">
                    <p>Error loading player stats</p>
                </div>
            `;
        });
}
</script>

<script>
function handleCounterProposal(challengeId) {
    event.preventDefault();
    
    const form = document.getElementById('counterForm' + challengeId);
    const formData = new FormData(form);
    
    // Prepare the data for the backend
    const data = {
        challenge_id: formData.get('challenge_id'),
        proposed_location: formData.get('proposed_location'),
        proposed_time: formData.get('proposed_time'),
        player_id: {{ session.get('current_player_id', 'null') }}
    };
    
    fetch('/decline_challenge', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message and reload page
            alert(data.message);
            window.location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to send counter-proposal. Please try again.');
    });
}
</script>

<script>
  async function sendChallenge() {
    try {
        const opponent_id = document.getElementById("opponent_id").value;
        if (!opponent_id) {
            alert("Opponent not found â€” please reselect a player.");
            return;
        }

        const partner1_id = document.getElementById("partner1_id").value || null;
        const partner2_id = document.getElementById("partner2_id").value || null;
        const court_location = document.getElementById("courtLocation").value || "TBD";
        const scheduled_time = document.getElementById("scheduled_time").value || null;

        const payload = {
            opponent_id,
            partner1_id,
            partner2_id,
            sport: "Pickleball",
            court_location,
            match_date: scheduled_time ? scheduled_time.split("T")[0] : null,
            scheduled_time
        };

        const res = await fetch("/challenges/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const result = await res.json();
        if (result.success) {
            alert(`Challenge sent!\n${result.team1.join(" & ")} vs ${result.team2.join(" & ")}`);
            bootstrap.Modal.getInstance(document.getElementById("challengeModal")).hide();
        } else {
            alert("Error: " + (result.error || "Unable to send challenge"));
        }
    } catch (err) {
        console.error("Error sending challenge:", err);
        alert("Something went wrong while sending the challenge.");
    }
}


// Initialize partner autocompletes
setupPartnerSearch("partner1", "partner1_id");
setupPartnerSearch("partner2", "partner2_id");

function setupPartnerSearch(inputId, hiddenId) {
    const input = document.getElementById(inputId);
    const hidden = document.getElementById(hiddenId);
    let dropdown;

    input.addEventListener("input", async () => {
        const term = input.value.trim();
        if (term.length < 2) return;

        const res = await fetch(`/search_players?query=${encodeURIComponent(term)}`);
        const players = await res.json();

        // remove old dropdown
        if (dropdown) dropdown.remove();

        dropdown = document.createElement("ul");
        dropdown.className = "list-group w-100 z-10";
        players.forEach(player => {
            const li = document.createElement("li");
            li.className = "list-group-item list-group-item-action";
            li.textContent = player.full_name || player.username;
            li.onclick = () => {
                input.value = player.full_name || player.username;
                hidden.value = player.id;
                dropdown.remove();
            };
            dropdown.appendChild(li);
        });

        input.parentNode.appendChild(dropdown);
    });
}

</script>

{% endblock %}
