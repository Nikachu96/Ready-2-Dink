{% extends "base.html" %}

{% block title %}Welcome {{ player.full_name.split()[0] }} - Ready 2 Dink{% endblock %}

{% block content %}

<style>
/* Dark Theme Dashboard Design */
:root {
    --primary-bg: #0f0f23;
    --secondary-bg: #1a1a2e;
    --card-bg: rgba(26, 26, 46, 0.8);
    --text-primary: #ffffff;
    --accent-cyan: #00f5ff;
    --accent-green: #00ff41;
    --accent-purple: #bf00ff;
    --border-subtle: rgba(226, 232, 240, 0.1);
    --glow-effect: 0 0 20px rgba(0, 245, 255, 0.3);
}

body {
    background: var(--primary-bg);
    color: var(--text-primary);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    overflow-x: hidden;
}

.dashboard-container {
    min-height: 100vh;
    background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
    padding: 2rem 0;
}

.player-card, .actions-card {
    background: var(--card-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-subtle);
    border-radius: 24px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
}

.player-card:hover, .actions-card:hover {
    border-color: var(--accent-cyan);
    box-shadow: var(--glow-effect);
    transform: translateY(-2px);
}

.player-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 4px solid var(--accent-cyan);
    box-shadow: 0 0 30px rgba(0, 245, 255, 0.4);
    object-fit: cover;
    transition: all 0.3s ease;
}

.player-avatar:hover {
    transform: scale(1.05);
    box-shadow: 0 0 40px rgba(0, 245, 255, 0.6);
}

.avatar-placeholder {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 4px solid var(--accent-cyan);
    background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    color: white;
    box-shadow: 0 0 30px rgba(0, 245, 255, 0.4);
}

.skill-badge {
    background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
    color: white;
    font-weight: 700;
    font-size: 1.1rem;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    box-shadow: 0 0 20px rgba(0, 255, 65, 0.4);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-item {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-subtle);
    border-radius: 16px;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
}

.stat-item:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: var(--accent-cyan);
    transform: translateY(-1px);
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent-cyan);
    text-shadow: 0 0 10px rgba(0, 245, 255, 0.5);
}

.stat-label {
    color: #ffffff !important;
    font-weight: 500;
    opacity: 1.0 !important;
    font-size: 16px !important;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.court-item {
    background: rgba(191, 0, 255, 0.1);
    border: 1px solid rgba(191, 0, 255, 0.3);
    border-radius: 12px;
    padding: 1rem;
    color: var(--text-primary);
    transition: all 0.3s ease;
}

.court-item:hover {
    background: rgba(191, 0, 255, 0.2);
    border-color: var(--accent-purple);
    transform: translateX(5px);
}

.action-btn {
    background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
    border: none;
    border-radius: 16px;
    padding: 1.25rem 2rem;
    font-weight: 600;
    font-size: 1.1rem;
    color: white;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 8px 32px rgba(0, 245, 255, 0.3);
    width: 100%;
    margin-bottom: 1rem;
}

.action-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 40px rgba(0, 245, 255, 0.5);
    background: linear-gradient(135deg, var(--accent-purple), var(--accent-green));
}

.action-btn i {
    margin-right: 0.75rem;
    font-size: 1.2rem;
}

.section-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent-cyan);
    margin-bottom: 1.5rem;
    text-shadow: 0 0 10px rgba(0, 245, 255, 0.5);
}

.notification-toggle {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-subtle);
    border-radius: 50px;
    padding: 0.75rem 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
}

.notification-toggle:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: var(--accent-cyan);
}

/* Mobile Responsive Design */
@media (max-width: 768px) {
    .dashboard-container {
        padding: 1rem;
    }
    
    .player-avatar, .avatar-placeholder {
        width: 100px;
        height: 100px;
    }
    
    .section-title {
        font-size: 1.3rem;
    }
    
    .action-btn {
        padding: 1rem 1.5rem;
        font-size: 1rem;
    }
    
    .stat-number {
        font-size: 1.5rem;
    }
}

/* Maintain existing score input styling for compatibility */
.score-input {
    background: #000 !important;
    color: #00FF00 !important;
    border: 2px solid #333 !important;
    font-family: 'Courier New', monospace !important;
    font-size: 24px !important;
    font-weight: bold !important;
}

/* Toast notifications */
.toast-container {
    position: fixed;
    top: 100px;
    right: 20px;
    z-index: 9999;
}
</style>

<!-- Profile Completion Modal (preserved from original) -->
<div class="modal fade" id="profileCompletionModal" tabindex="-1" aria-labelledby="profileCompletionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content surface-dark" data-bs-theme="dark">
            <div class="modal-header surface-dark">
                <h5 class="modal-title fw-bold" id="profileCompletionModalLabel">
                    <i class="fas fa-user-cog me-2"></i>Complete Your Profile
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body surface-dark">
                <div class="alert alert-info mb-4 surface-dark">
                    <h6><i class="fas fa-info-circle me-2"></i>Welcome to Ready 2 Dink!</h6>
                    <p class="mb-0">Complete your profile to unlock all features and find the perfect pickleball partners.</p>
                </div>
                
                <div class="row">
                    <div class="col-12 col-md-6">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-list-check me-2"></i>What's Missing?
                        </h6>
                        <ul class="list-group list-group-flush mb-4 surface-dark">
                            <li class="list-group-item d-flex align-items-center">
                                <i class="fas fa-map-marker-alt text-danger me-3"></i>
                                <span>Location & Preferred Courts</span>
                            </li>
                            <li class="list-group-item d-flex align-items-center">
                                <i class="fas fa-star text-warning me-3"></i>
                                <span>Skill Level</span>
                            </li>
                            <li class="list-group-item d-flex align-items-center">
                                <i class="fas fa-camera text-info me-3"></i>
                                <span>Profile Photo</span>
                            </li>
                            <li class="list-group-item d-flex align-items-center">
                                <i class="fas fa-wallet text-success me-3"></i>
                                <span>Payout Preferences</span>
                            </li>
                        </ul>
                    </div>
                    <div class="col-12 col-md-6">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-unlock me-2"></i>Unlock Features:
                        </h6>
                        <div class="card" style="background: white; border: 1px solid #ddd;">
                            <div class="card-body">
                                <ul class="mb-0 text-sm" style="color: #000 !important;">
                                    <li class="mb-2" style="color: #000 !important;"><i class="fas fa-users text-primary me-2"></i>Find compatible players nearby</li>
                                    <li class="mb-2" style="color: #000 !important;"><i class="fas fa-trophy text-warning me-2"></i>Enter tournaments</li>
                                    <li class="mb-2" style="color: #000 !important;"><i class="fas fa-handshake text-success me-2"></i>Match with players at your level</li>
                                    <li class="mb-0" style="color: #000 !important;"><i class="fas fa-dollar-sign text-info me-2"></i>Receive tournament winnings</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning surface-dark">
                    <i class="fas fa-clock me-2"></i>
                    <strong>Take your time!</strong> You can complete this now or later.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-clock me-1"></i>I'll Do This Later
                </button>
                <a href="{{ url_for('profile_settings') }}" class="btn btn-primary">
                    <i class="fas fa-user-edit me-1"></i>Complete Profile Now
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Birthday Message -->
{% if is_birthday %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-dismissible fade show" 
             style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); border: none; border-radius: 16px;">
            <div class="text-center py-3">
                <h2 class="fw-bold mb-0" style="color: #8B4513;">üéâ Happy Birthday, {{ player.full_name.split()[0] }}! üéâ</h2>
                <p class="mb-0 fs-5" style="color: #A0522D;">Hope you have a fantastic day filled with amazing matches! üèì</p>
                <button type="button" class="btn-close position-absolute top-0 end-0 m-3" 
                        data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Toast Container -->
<div class="toast-container"></div>

<!-- Main Dashboard Layout -->
<div class="dashboard-container">
    <div class="container-fluid">
        <div class="row g-4">
            
            <!-- Left Panel: Player Information -->
            <div class="col-12 col-lg-6">
                <div class="player-card p-4 h-100">
                    
                    <!-- Player Header -->
                    <div class="text-center mb-4">
                        {% if player.selfie %}
                            <img src="{{ url_for('static', filename='uploads/' + player.selfie) }}" 
                                 class="player-avatar mb-3" alt="Player Photo">
                        {% else %}
                            <div class="avatar-placeholder mb-3">
                                <i class="fas fa-user"></i>
                            </div>
                        {% endif %}
                        
                        <h1 class="fw-bold text-white mb-2">
                            Welcome back, {{ player.full_name.split()[0] }}!
                            {% if player.tournament_wins and player.tournament_wins > 0 %}
                            <i class="fas fa-crown ms-2" style="color: #FFD700;"></i>
                            {% endif %}
                        </h1>
                        
                        {% if player.player_id %}
                        <p class="mb-3" style="color: #ffffff !important; opacity: 1.0 !important;">
                            <i class="fas fa-id-card me-2"></i>Player ID: <strong style="color: var(--accent-cyan);">{{ player.player_id }}</strong>
                        </p>
                        {% endif %}
                        
                        <div class="skill-badge d-inline-block">
                            <i class="fas fa-star me-2"></i>{{ player.skill_level }}
                        </div>
                    </div>
                    
                    <!-- Player Stats -->
                    <div class="section-title">
                        <i class="fas fa-chart-line me-2"></i>Your Stats
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-6 col-md-3">
                            <div class="stat-item">
                                <div class="stat-number">{{ player.wins or 0 }}</div>
                                <div class="stat-label">Wins</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="stat-item">
                                <div class="stat-number">{{ player.losses or 0 }}</div>
                                <div class="stat-label">Losses</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="stat-item">
                                <div class="stat-number">{{ player.ranking_points or 0 }}</div>
                                <div class="stat-label">Points</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="stat-item">
                                <div class="stat-number">
                                    {% if player_ranking %}#{{ player_ranking }}{% else %}--{% endif %}
                                </div>
                                <div class="stat-label">Rank</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tournament Credits -->
                    {% if player.tournament_credits and player.tournament_credits > 0 %}
                    <div class="stat-item mb-4" style="background: linear-gradient(135deg, rgba(0, 255, 65, 0.1), rgba(0, 245, 255, 0.1));">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-wallet fa-2x me-3" style="color: var(--accent-green);"></i>
                            <div>
                                <div class="stat-number" style="color: var(--accent-green);">${{ "%.2f"|format(player.tournament_credits) }}</div>
                                <div class="stat-label">Tournament Credits</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Favorite Courts -->
                    {% if player.preferred_court_1 or player.preferred_court_2 %}
                    <div class="section-title">
                        <i class="fas fa-map-marker-alt me-2"></i>Favorite Courts
                    </div>
                    
                    <div class="mb-4">
                        {% if player.preferred_court_1 %}
                        <div class="court-item mb-2" onclick="showCourtLocation('{{ player.preferred_court_1 }}', 'primary')" style="cursor: pointer;">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-map-marker-alt me-3" style="color: var(--accent-purple);"></i>
                                <div>
                                    <div class="fw-bold">Primary Court</div>
                                    <span style="font-size: 16px !important; color: #f1f5f9 !important;">{{ player.preferred_court_1 }}</span>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if player.preferred_court_2 %}
                        <div class="court-item" onclick="showCourtLocation('{{ player.preferred_court_2 }}', 'secondary')" style="cursor: pointer;">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-map-marker-alt me-3" style="color: var(--accent-purple);"></i>
                                <div>
                                    <div class="fw-bold">Secondary Court</div>
                                    <span style="font-size: 16px !important; color: #f1f5f9 !important;">{{ player.preferred_court_2 }}</span>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Notification Toggle -->
                    <div class="notification-toggle">
                        <i class="fas fa-bell" style="color: var(--accent-cyan);"></i>
                        <span class="flex-grow-1">Notifications</span>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   role="switch" 
                                   id="notificationToggle"
                                   {% if player.notifications_enabled %}checked{% endif %}>
                            <label class="form-check-label fw-semibold" for="notificationToggle" id="notificationStatus">
                                {% if player.notifications_enabled %}ON{% else %}OFF{% endif %}
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel: Quick Actions -->
            <div class="col-12 col-lg-6">
                <div class="actions-card p-4 h-100">
                    <div class="section-title text-center">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </div>
                    
                    <div class="d-grid gap-3">
                        
                        <!-- Find Opponent Button -->
                        {% if player.membership_type == 'discovery' or player.membership_type == 'tournament' %}
                        <button class="action-btn" onclick="findNewMatch({{ player.id }})">
                            <i class="fas fa-users"></i>Find Opponent
                        </button>
                        {% else %}
                        <button class="action-btn" onclick="showMembershipModal('discovery')">
                            <i class="fas fa-lock"></i>Unlock Player Matching
                        </button>
                        {% endif %}
                        
                        <!-- Create Challenge Button -->
                        {% if player.membership_type == 'discovery' or player.membership_type == 'tournament' %}
                        <a href="{{ url_for('browse_players') }}" class="action-btn text-decoration-none">
                            <i class="fas fa-paper-plane"></i>Create Challenge
                        </a>
                        {% else %}
                        <button class="action-btn" onclick="showMembershipModal('discovery')">
                            <i class="fas fa-lock"></i>Unlock Challenges
                        </button>
                        {% endif %}
                        
                        <!-- Join Tournament Button -->
                        {% if player.membership_type == 'tournament' %}
                        <a href="{{ url_for('tournaments_overview') }}" class="action-btn text-decoration-none">
                            <i class="fas fa-trophy"></i>Join Tournament
                        </a>
                        {% else %}
                        <button class="action-btn" onclick="showMembershipModal('tournament')">
                            <i class="fas fa-crown"></i>Unlock Tournaments
                        </button>
                        {% endif %}
                        
                        <!-- Referral Button - Available to all users -->
                        <a href="{{ url_for('universal_referral_dashboard') }}" class="action-btn text-decoration-none" 
                           style="background: linear-gradient(135deg, var(--accent-green), #20c997); box-shadow: 0 8px 32px rgba(0, 255, 65, 0.3);">
                            <i class="fas fa-share-alt"></i>Share & Earn Rewards
                        </a>
                        
                        <!-- Additional Action Buttons -->
                        <div class="row g-2 mt-3">
                            <div class="col-6">
                                <button class="btn btn-outline-light w-100" onclick="loadChallenges()">
                                    <i class="fas fa-inbox me-1"></i><br><span style="font-size: 16px !important;">Challenges</span>
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-light w-100" onclick="loadPendingMatches()">
                                    <i class="fas fa-clipboard-list me-1"></i><br><span style="font-size: 16px !important;">Submit Results</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="row g-2">
                            <div class="col-6">
                                <a href="{{ url_for('profile_settings') }}" class="btn btn-outline-light w-100 text-decoration-none">
                                    <i class="fas fa-user-cog me-1"></i><br><span style="font-size: 16px !important;">Profile</span>
                                </a>
                            </div>
                            <div class="col-6">
                                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger w-100 text-decoration-none">
                                    <i class="fas fa-sign-out-alt me-1"></i><br><span style="font-size: 16px !important;">Sign Out</span>
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Stats Display -->
                    <div class="mt-4 pt-4" style="border-top: 1px solid var(--border-subtle);">
                        <div class="row g-2 text-center">
                            <div class="col-4">
                                <div class="mb-1" style="color: #f1f5f9 !important; font-size: 16px !important; font-weight: 500 !important;">Location</div>
                                <div class="fw-bold text-truncate" style="color: var(--accent-cyan); font-size: 16px !important;">
                                    <i class="fas fa-map-marker-alt me-1"></i>{{ player.location1 or 'Not Set' }}
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="mb-1" style="color: #f1f5f9 !important; font-size: 16px !important; font-weight: 500 !important;">Membership</div>
                                <div class="fw-bold" style="color: var(--accent-green); font-size: 16px !important;">
                                    <i class="fas fa-star me-1"></i>{{ player.membership_type|title or 'Free' }}
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="mb-1" style="color: #f1f5f9 !important; font-size: 16px !important; font-weight: 500 !important;">Win Rate</div>
                                <div class="fw-bold" style="color: var(--accent-purple); font-size: 16px !important;">
                                    {% set total_games = (player.wins or 0) + (player.losses or 0) %}
                                    {% if total_games > 0 %}
                                        {{ "%.0f"|format(((player.wins or 0) / total_games) * 100) }}%
                                    {% else %}
                                        --
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden containers for dynamic content -->
<div id="challenges-received-container" style="display: none;"></div>
<div id="challenges-sent-container" style="display: none;"></div>
<div id="upcoming-matches-container" style="display: none;"></div>
<div id="pending-matches-container" style="display: none;"></div>

{% endblock %}

{% block scripts %}
<!-- Show Profile Completion Modal if needed -->
{% if session.get('show_profile_completion') %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = new bootstrap.Modal(document.getElementById('profileCompletionModal'));
    modal.show();
    
    fetch('/clear_profile_completion_flag', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    });
});
</script>
{% endif %}

<script>
// Preserve all original JavaScript functionality
let currentRecipientId = null;
let currentMatchId = null;

// Toast notification functions
function showSuccessToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast show';
    toast.innerHTML = `
        <div class="toast-header" style="background: var(--accent-green); color: white;">
            <i class="fas fa-check-circle me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" onclick="this.closest('.toast').remove()"></button>
        </div>
        <div class="toast-body" style="background: white; color: #333;">
            ${message}
        </div>
    `;
    document.querySelector('.toast-container').appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

function showErrorToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast show';
    toast.innerHTML = `
        <div class="toast-header" style="background: #dc3545; color: white;">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong class="me-auto">Error</strong>
            <button type="button" class="btn-close btn-close-white" onclick="this.closest('.toast').remove()"></button>
        </div>
        <div class="toast-body" style="background: white; color: #333;">
            ${message}
        </div>
    `;
    document.querySelector('.toast-container').appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 7000);
}

// Notification toggle functionality
document.addEventListener('DOMContentLoaded', function() {
    const toggle = document.getElementById('notificationToggle');
    const status = document.getElementById('notificationStatus');
    
    if (toggle) {
        toggle.addEventListener('change', function() {
            const enabled = this.checked;
            status.textContent = enabled ? 'ON' : 'OFF';
            
            fetch('/toggle-notifications', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ enabled: enabled })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showSuccessToast(`Notifications ${enabled ? 'enabled' : 'disabled'}`);
                } else {
                    showErrorToast(data.message || 'Failed to update notification settings');
                    toggle.checked = !enabled;
                    status.textContent = !enabled ? 'ON' : 'OFF';
                }
            })
            .catch(error => {
                console.error('Notification toggle error:', error);
                showErrorToast(`Error: ${error.message || 'Network error'}`);
                // Revert the toggle state
                toggle.checked = !enabled;
                status.textContent = !enabled ? 'ON' : 'OFF';
            });
        });
    }
});

// Find match functionality
function findNewMatch(playerId) {
    fetch(`/find_match/${playerId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.players) {
            showPlayerSelectionModal(data.players);
        } else if (data.success) {
            showSuccessToast('Match found! Check your pending challenges.');
            setTimeout(() => location.reload(), 1000);
        } else {
            showErrorToast(data.message || 'No matches found at the moment. Try again later!');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorToast('Error finding match. Please try again.');
    });
}

// Player selection modal
function showPlayerSelectionModal(players) {
    const modal = document.createElement('div');
    modal.innerHTML = `
        <div class="modal fade" id="playerSelectionModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content" style="background: var(--card-bg); color: var(--text-primary);">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-users me-2"></i>Choose Players to Challenge
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-4">Found ${players.length} compatible players at your skill level:</p>
                        <div class="row">
                            ${players.map(player => `
                                <div class="col-12 col-sm-6 mb-3">
                                    <div class="card h-100" style="background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle);">
                                        <div class="card-body text-center">
                                            <h6 class="card-title fw-bold text-white">${player.name}</h6>
                                            <p class="mb-2" style="color: #ffffff !important; opacity: 1.0 !important; font-size: 16px !important;">
                                                <i class="fas fa-map-marker-alt me-1"></i>${player.location}
                                            </p>
                                            <p class="small mb-3" style="color: var(--accent-cyan);">
                                                <i class="fas fa-star me-1"></i>${player.skill_level}
                                            </p>
                                            <button class="btn btn-primary btn-sm" onclick="challengePlayer(${player.id})">
                                                <i class="fas fa-paper-plane me-1"></i>Challenge
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(document.getElementById('playerSelectionModal'));
    bootstrapModal.show();
    
    document.getElementById('playerSelectionModal').addEventListener('hidden.bs.modal', function () {
        document.body.removeChild(modal);
    });
}

// Challenge player functionality
function challengePlayer(playerId) {
    fetch('/challenge_player', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ challenged_player_id: playerId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessToast('Challenge sent successfully!');
            setTimeout(() => location.reload(), 1000);
        } else {
            showErrorToast(data.message || 'Failed to send challenge');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorToast('Error sending challenge');
    });
}

// Load challenges functionality
function loadChallenges() {
    showSuccessToast('Loading challenges...');
    setTimeout(() => location.reload(), 500);
}

// Load pending matches functionality
function loadPendingMatches() {
    showSuccessToast('Loading pending matches...');
    setTimeout(() => location.reload(), 500);
}

// Membership modal functionality
function showMembershipModal(suggestedType = 'discovery') {
    const modalHtml = `
        <div class="modal fade" id="membershipModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content" style="background: var(--card-bg); color: var(--text-primary);">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-star me-2"></i>Choose Your Membership
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-4">
                            <h3 class="fw-bold">Start Your Journey</h3>
                            <p style="color: #ffffff !important; opacity: 1.0 !important; font-size: 16px !important;">Choose the membership that fits your pickleball goals</p>
                        </div>
                        
                        <div class="row g-4">
                            <div class="col-12 col-md-6">
                                <div class="card h-100" style="background: rgba(255,255,255,0.05); border: ${suggestedType === 'discovery' ? '2px solid var(--accent-cyan)' : '1px solid var(--border-subtle)'};">
                                    <div class="card-body p-4 text-center">
                                        <i class="fas fa-users fa-3x mb-3" style="color: var(--accent-cyan);"></i>
                                        <h4 class="fw-bold text-white">Player Discovery</h4>
                                        <div class="display-5 fw-bold mb-2" style="color: var(--accent-cyan);">$4.99</div>
                                        <span style="color: #f1f5f9 !important; opacity: 1.0 !important; font-size: 16px !important;">per month</span>
                                        
                                        <ul class="list-unstyled mt-4 mb-4 text-start">
                                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Find compatible players</li>
                                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Chat with players</li>
                                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Organize casual games</li>
                                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>View detailed profiles</li>
                                        </ul>
                                        
                                        <button class="btn btn-primary w-100 btn-lg" onclick="startSubscription('discovery')">
                                            <i class="fas fa-rocket me-2"></i>Start Free Trial
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12 col-md-6">
                                <div class="card h-100" style="background: rgba(255,255,255,0.05); border: ${suggestedType === 'tournament' ? '2px solid var(--accent-green)' : '1px solid var(--border-subtle)'};">
                                    <div class="card-body p-4 text-center">
                                        <i class="fas fa-trophy fa-3x mb-3" style="color: var(--accent-green);"></i>
                                        <h4 class="fw-bold text-white">Tournament Access</h4>
                                        <div class="display-5 fw-bold mb-2" style="color: var(--accent-green);">$9.99</div>
                                        <span style="color: #f1f5f9 !important; opacity: 1.0 !important; font-size: 16px !important;">per month</span>
                                        
                                        <ul class="list-unstyled mt-4 mb-4 text-start">
                                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i><strong>Everything in Discovery</strong></li>
                                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Enter paid tournaments</li>
                                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Compete for cash prizes</li>
                                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Advanced statistics</li>
                                        </ul>
                                        
                                        <button class="btn w-100 btn-lg" style="background: var(--accent-green); color: white;" onclick="startSubscription('tournament')">
                                            <i class="fas fa-crown me-2"></i>Start Free Trial
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Maybe Later</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('membershipModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modalElement = document.getElementById('membershipModal');
    const modalInstance = new bootstrap.Modal(modalElement);
    modalInstance.show();
}

// Start subscription functionality
function startSubscription(membershipType) {
    const modal = bootstrap.Modal.getInstance(document.getElementById('membershipModal'));
    if (modal) {
        modal.hide();
    }
    
    setTimeout(() => {
        window.location.href = `/membership_payment/${membershipType}`;
    }, 300);
}

// Court location functionality
function showCourtLocation(courtName, type) {
    showSuccessToast(`Opening location for ${courtName}`);
    // Could integrate with maps API here
}
</script>
{% endblock %}