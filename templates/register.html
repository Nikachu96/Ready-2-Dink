{% extends "base.html" %}

{% block title %}Join Ready 2 Dink - Create Your Profile{% endblock %}

{% block content %}
<div class="row justify-content-center animate-in">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header text-white" style="background: var(--gradient-primary); border: none;">
                <h4 class="card-title mb-0 fw-bold">
                    <img src="{{ url_for('static', filename='images/ready2dink-logo.png') }}" alt="Ready 2 Dink" style="height: 40px; width: auto;" class="me-2">Join the Game
                </h4>
                <p class="mb-0 opacity-90">Create your profile to start matching with pickleball players</p>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('register') }}" onsubmit="console.log('Form submitting...'); return true;">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="full_name" class="form-label text-white">
                                    <i class="fas fa-user me-1"></i>Full Name *
                                </label>
                                <input type="text" class="form-control" id="full_name" name="full_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label text-white">
                                    <i class="fas fa-envelope me-1"></i>Email Address *
                                </label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="dob" class="form-label text-white">
                                    <i class="fas fa-birthday-cake me-1"></i>Date of Birth *
                                </label>
                                <input type="text" class="form-control" id="dob" name="dob" 
                                       placeholder="MM-DD-YYYY" required>
                                <div class="form-text text-white">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Format: MM-DD-YYYY (e.g., 08-05-1976)
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="username" class="form-label text-white">
                                    <i class="fas fa-at me-1"></i>Create Username *
                                </label>
                                <input type="text" class="form-control" id="username" name="username" 
                                       placeholder="Choose a unique username" required>
                                <div class="form-text text-white">
                                    <i class="fas fa-info-circle me-1"></i>
                                    This will be your unique identifier in Ready 2 Dink
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="password" class="form-label text-white">
                                    <i class="fas fa-lock me-1"></i>Create Password *
                                </label>
                                <input type="password" class="form-control" id="password" name="password" 
                                       placeholder="Choose a strong password" required>
                                <div class="form-text text-white">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Minimum 6 characters
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="confirm_password" class="form-label text-white">
                                    <i class="fas fa-lock me-1"></i>Confirm Password *
                                </label>
                                <input type="password" class="form-control" id="confirm_password" name="confirm_password" 
                                       placeholder="Re-enter your password" required>
                                <div class="form-text text-white">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Must match your password
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden field for guardian email -->
                    <input type="hidden" id="guardian_email" name="guardian_email" value="">
                    
                    <div class="alert text-white mb-4" style="background-color: #2c3e50; border-color: #34495e;">
                        <i class="fas fa-info-circle me-2 text-white"></i>
                        <strong class="text-white">Quick Registration:</strong> 
                        <p class="mb-0 mt-2 text-white">Get started with just the basics! After joining, you can complete your profile with courts, skill level, and photos in your account settings.</p>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary me-md-2" style="color: white;">Cancel</a>
                        <button type="submit" class="btn btn-primary" id="register-btn">
                            <i class="fas fa-user-plus me-1"></i>Create Account
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Guardian Consent Modal for Under-13 Players -->
<div class="modal fade" id="guardianConsentModal" tabindex="-1" aria-labelledby="guardianConsentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="guardianConsentModalLabel">
                    <i class="fas fa-shield-alt me-2"></i>Guardian Consent Required
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-4">
                    <h6><i class="fas fa-info-circle me-2"></i>Children's Online Privacy Protection Act (COPPA) Compliance</h6>
                    <p class="mb-0">Since you are 13 years old or younger, we need permission from your parent or legal guardian before you can create an account. This is required by federal law to protect children's privacy online.</p>
                </div>
                
                <div class="mb-4">
                    <h6><i class="fas fa-user-friends me-2"></i>What happens next?</h6>
                    <ol class="ps-3">
                        <li>You'll provide your parent/guardian's email address</li>
                        <li>We'll send them a consent form to review and sign</li>
                        <li>Your account will be created but remain "pending" until we receive their authorization</li>
                        <li>Once approved, you'll be able to use all Ready 2 Dink features!</li>
                    </ol>
                </div>
                
                <div class="mb-3">
                    <label for="guardian_email_input" class="form-label">
                        <i class="fas fa-envelope me-1"></i>Parent/Guardian Email Address *
                    </label>
                    <input type="email" class="form-control" id="guardian_email_input" 
                           placeholder="parent@example.com" required>
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        We'll send the consent form to this email address
                    </div>
                </div>
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Important:</strong> Make sure this is your parent or legal guardian's email address. They must review and sign the consent form before your account can be activated.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel Registration
                </button>
                <button type="button" class="btn btn-primary" id="confirm-guardian-email">
                    <i class="fas fa-check me-1"></i>Continue with Guardian Consent
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables for age verification
let requiresGuardianConsent = false;
let guardianModalShown = false;

// Date of birth validation and age verification
document.getElementById('dob').addEventListener('input', function(e) {
    // Store cursor position before formatting
    let cursorPosition = e.target.selectionStart;
    let oldValue = e.target.value;
    let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
    
    // Auto-format as user types: MM-DD-YYYY
    let formattedValue = '';
    if (value.length >= 2 && value.length <= 4) {
        formattedValue = value.substring(0, 2) + '-' + value.substring(2);
    } else if (value.length > 4) {
        formattedValue = value.substring(0, 2) + '-' + value.substring(2, 4) + '-' + value.substring(4, 8);
    } else {
        formattedValue = value;
    }
    
    // Only update if the value actually changed (prevents cursor jumping)
    if (formattedValue !== oldValue) {
        e.target.value = formattedValue;
        
        // Restore cursor position intelligently
        let newCursorPosition = cursorPosition;
        if (formattedValue.length < oldValue.length) {
            // User is deleting, keep cursor where it was
            newCursorPosition = Math.min(cursorPosition, formattedValue.length);
        } else if (formattedValue.length > oldValue.length) {
            // Auto-formatting added characters, adjust cursor
            if (cursorPosition === 2 || cursorPosition === 5) {
                newCursorPosition = cursorPosition + 1;
            }
        }
        
        // Set cursor position after a brief delay to ensure it takes effect
        setTimeout(() => {
            e.target.setSelectionRange(newCursorPosition, newCursorPosition);
        }, 0);
    }
    
    // Use the formatted value for validation
    let value_for_validation = formattedValue;
    
    // Validate date format - simplified validation
    const datePattern = /^\d{2}-\d{2}-\d{4}$/;
    if (datePattern.test(value_for_validation)) {
        const [month, day, year] = value_for_validation.split('-').map(Number);
        
        // Basic validation: month 1-12, day 1-31, year 1900-current year
        const currentYear = new Date().getFullYear();
        if (month >= 1 && month <= 12 && 
            day >= 1 && day <= 31 && 
            year >= 1900 && year <= currentYear) {
            
            // Calculate age for COPPA compliance
            const birthDate = new Date(year, month - 1, day);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            // Check if player is 13 or under
            if (age <= 13 && !guardianModalShown) {
                requiresGuardianConsent = true;
                guardianModalShown = true;
                
                // Show guardian consent modal after a brief delay
                setTimeout(() => {
                    const guardianModal = new bootstrap.Modal(document.getElementById('guardianConsentModal'));
                    guardianModal.show();
                }, 500);
            } else if (age > 13) {
                requiresGuardianConsent = false;
                document.getElementById('guardian_email').value = '';
            }
            
            // Clear any validation errors
            e.target.setCustomValidity('');
            e.target.classList.remove('is-invalid');
            e.target.classList.add('is-valid');
        } else {
            e.target.setCustomValidity('Please enter a valid date');
            e.target.classList.remove('is-valid');
            e.target.classList.add('is-invalid');
        }
    } else if (value_for_validation.length === 10) {
        e.target.setCustomValidity('Please use MM-DD-YYYY format');
        e.target.classList.remove('is-valid');
        e.target.classList.add('is-invalid');
    } else {
        // Reset validation state for incomplete dates
        e.target.setCustomValidity('');
        e.target.classList.remove('is-valid', 'is-invalid');
        requiresGuardianConsent = false;
    }
});

// Guardian consent modal handlers
document.getElementById('confirm-guardian-email').addEventListener('click', function() {
    const guardianEmailInput = document.getElementById('guardian_email_input');
    const guardianEmail = guardianEmailInput.value.trim();
    
    if (!guardianEmail) {
        guardianEmailInput.classList.add('is-invalid');
        guardianEmailInput.setCustomValidity('Guardian email is required');
        return;
    }
    
    // Basic email validation
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailPattern.test(guardianEmail)) {
        guardianEmailInput.classList.add('is-invalid');
        guardianEmailInput.setCustomValidity('Please enter a valid email address');
        return;
    }
    
    // Set the guardian email in the hidden field
    document.getElementById('guardian_email').value = guardianEmail;
    guardianEmailInput.classList.remove('is-invalid');
    guardianEmailInput.setCustomValidity('');
    
    // Close the modal
    const guardianModal = bootstrap.Modal.getInstance(document.getElementById('guardianConsentModal'));
    guardianModal.hide();
    
    // Show success message
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
    alertDiv.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        <strong>Guardian Email Saved!</strong> Your registration will be processed pending guardian approval.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert before the form buttons
    const buttonContainer = document.querySelector('.d-grid.gap-2');
    buttonContainer.parentNode.insertBefore(alertDiv, buttonContainer);
});

// Form submission validation
document.querySelector('form').addEventListener('submit', function(e) {
    if (requiresGuardianConsent && !document.getElementById('guardian_email').value) {
        e.preventDefault();
        alert('Please complete the guardian consent process before submitting your registration.');
        return false;
    }
});

// Preview uploaded image
document.getElementById('selfie').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            // Create or update image preview
            let preview = document.getElementById('image-preview');
            if (!preview) {
                preview = document.createElement('img');
                preview.id = 'image-preview';
                preview.className = 'img-thumbnail mt-2';
                preview.style.maxWidth = '150px';
                preview.style.maxHeight = '150px';
                document.getElementById('selfie').parentNode.appendChild(preview);
            }
            preview.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
});

// Map functionality for court search
let maps = {};
let markers = {};

function initializeMap(containerId, inputId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    // Default to a general location (USA center)
    const map = L.map(containerId).setView([39.8283, -98.5795], 4);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    maps[containerId] = map;
    markers[containerId] = null;
    
    return map;
}

function searchCourt(query, mapId, inputId) {
    if (!query || query.length < 3) return;
    
    // Enhanced search for pickleball courts and venues
    const searchQuery = `pickleball court ${query}`;
    
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=8&addressdetails=1`)
        .then(response => response.json())
        .then(data => {
            if (data && data.length > 0) {
                const result = data[0];
                const lat = parseFloat(result.lat);
                const lon = parseFloat(result.lon);
                
                // Store coordinates for database (create hidden input)
                let coordinatesInput = document.getElementById(inputId + '_coordinates');
                if (!coordinatesInput) {
                    coordinatesInput = document.createElement('input');
                    coordinatesInput.type = 'hidden';
                    coordinatesInput.id = inputId + '_coordinates';
                    coordinatesInput.name = inputId + '_coordinates';
                    document.getElementById(inputId).parentNode.appendChild(coordinatesInput);
                }
                coordinatesInput.value = JSON.stringify({lat: lat, lng: lon, address: result.display_name});
                
                const map = maps[mapId];
                if (map) {
                    // Remove existing marker
                    if (markers[mapId]) {
                        map.removeLayer(markers[mapId]);
                    }
                    
                    // Add new marker with enhanced popup for exact directions
                    const popupContent = `
                        <div class="text-center" style="min-width: 200px;">
                            <strong style="color: #3F567F;">${result.display_name}</strong><br>
                            <small class="text-muted">Lat: ${lat.toFixed(6)}, Lng: ${lon.toFixed(6)}</small><br>
                            <div class="mt-2">
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" 
                                   target="_blank" class="btn btn-sm btn-primary me-1">
                                   <i class="fas fa-directions"></i> Get Directions
                                </a>
                                <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}" 
                                   target="_blank" class="btn btn-sm btn-outline-secondary">
                                   <i class="fas fa-map"></i> View on Map
                                </a>
                            </div>
                            <div class="mt-1">
                                <small class="text-success">
                                    <i class="fas fa-map-pin"></i> Exact location saved
                                </small>
                            </div>
                        </div>
                    `;
                    
                    markers[mapId] = L.marker([lat, lon])
                        .addTo(map)
                        .bindPopup(popupContent)
                        .openPopup();
                    
                    // Center map on court with higher zoom for precision
                    map.setView([lat, lon], 16);
                }
            }
        })
        .catch(error => {
            console.log('Court search error:', error);
        });
}

// Initialize court search functionality
document.addEventListener('DOMContentLoaded', function() {
    const courtInputs = document.querySelectorAll('.court-search');
    
    courtInputs.forEach(input => {
        const mapId = input.id + '-map';
        let searchTimeout;
        
        input.addEventListener('input', function() {
            const query = this.value.trim();
            const mapContainer = document.getElementById(mapId);
            
            if (query.length >= 3) {
                // Show map container
                if (mapContainer) {
                    mapContainer.style.display = 'block';
                    
                    // Initialize map if not already done
                    if (!maps[mapId]) {
                        setTimeout(() => {
                            initializeMap(mapId, input.id);
                        }, 100);
                    }
                    
                    // Debounced search
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        searchCourt(query, mapId, input.id);
                    }, 500);
                }
            } else {
                // Hide map container if query is too short
                if (mapContainer) {
                    mapContainer.style.display = 'none';
                }
            }
        });
    });
});
</script>
{% endblock %}
