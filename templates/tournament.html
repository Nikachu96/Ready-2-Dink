{% extends "base.html" %}

{% block title %}Enter Tournament - Tournament Management System{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <i class="fas fa-trophy me-2"></i>Tournament Entry
                </h4>
            </div>
            <div class="card-body">
                {% if player %}
                    <div class="mb-4">
                        <div class="d-flex align-items-center">
                            {% if player.selfie %}
                                <img src="{{ url_for('static', filename='uploads/' + player.selfie) }}" 
                                     class="rounded-circle me-3" style="width: 60px; height: 60px; object-fit: cover;" 
                                     alt="Player Photo">
                            {% else %}
                                <div class="rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center me-3" 
                                     style="width: 60px; height: 60px;">
                                    <i class="fas fa-user text-white fa-lg"></i>
                                </div>
                            {% endif %}
                            <div>
                                <h5 class="mb-1">{{ player.full_name }}</h5>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-star me-1"></i>{{ player.skill_level }} â€¢ 
                                    <i class="fas fa-table-tennis me-1"></i>Pickleball
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <form method="POST">
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="tournament_type" class="form-label">
                                        <i class="fas fa-users me-1"></i>Tournament Type *
                                    </label>
                                    <select class="form-select" id="tournament_type" name="tournament_type" required onchange="togglePartnerSelection()">
                                        <option value="">Select type</option>
                                        <option value="singles">Singles (1v1)</option>
                                        <option value="doubles">Doubles (2v2) - Additional $10 fee</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Partner Selection for Doubles -->
                        <div class="row" id="partner-selection" style="display: none;">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="partner_id" class="form-label">
                                        <i class="fas fa-user-friends me-1"></i>Select Your Doubles Partner *
                                    </label>
                                    <select class="form-select" id="partner_id" name="partner_id">
                                        <option value="">Choose a partner...</option>
                                        {% if connections %}
                                            {% for connection in connections %}
                                            <option value="{{ connection.opponent_id }}">
                                                {{ connection.opponent_name }} 
                                                <small>({{ connection.matches_played }} matches played)</small>
                                            </option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                    <div class="form-text text-white">
                                        <i class="fas fa-info-circle me-1"></i>
                                        You can only invite players you've previously played with. Your partner will receive an invitation to accept and pay their fee.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-trophy me-1"></i>Available Tournaments *
                            </label>
                            {% if tournaments_list %}
                                <div class="row">
                                    {% for tournament in tournaments_list %}
                                    <div class="col-md-6 mb-3">
                                        <div class="card tournament-card" onclick="selectTournament('{{ tournament.id }}', this)">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <input type="radio" name="tournament_instance_id" value="{{ tournament.id }}" id="tournament_{{ tournament.id }}" class="form-check-input" {% if tournament.spots_remaining <= 0 %}disabled{% endif %}>
                                                        <label for="tournament_{{ tournament.id }}" class="form-check-label fw-bold ms-2">
                                                            {{ tournament.name }}
                                                        </label>
                                                    </div>
                                                    <span class="badge bg-primary fs-6 tournament-fee" data-base-fee="{{ tournament.entry_fee }}">${{ "%.0f"|format(tournament.entry_fee) }}</span>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <small class="text-muted">
                                                        <i class="fas fa-star me-1"></i>{{ tournament.skill_level }}
                                                    </small>
                                                    <small class="text-muted">
                                                        <i class="fas fa-users me-1"></i>{{ tournament.current_players }}/{{ tournament.max_players }} players
                                                    </small>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    {% if tournament.spots_remaining <= 0 %}
                                                        <span class="badge bg-danger">Full</span>
                                                    {% elif tournament.spots_remaining <= 5 %}
                                                        <span class="badge bg-warning">{{ tournament.spots_remaining }} spots left</span>
                                                    {% else %}
                                                        <span class="badge bg-success">{{ tournament.spots_remaining }} spots left</span>
                                                    {% endif %}
                                                </div>
                                                <p class="card-text small mb-2">{{ tournament.description }}</p>
                                                <p class="card-text small text-muted mb-0">
                                                    <i class="fas fa-trophy me-1"></i>{{ tournament.prize_pool }}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    No tournaments are currently open for registration. Check back later!
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Payment Method Selection -->
                        <div class="card mb-4" id="payment-method-section" style="display: none;">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-credit-card me-2"></i>Payment Method
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Display Credit Balance -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="alert alert-info d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-wallet me-2"></i>
                                                <strong>Available Tournament Credits: ${{ "%.2f"|format(player.tournament_credits or 0) }}</strong>
                                            </div>
                                            {% if player.tournament_credits and player.tournament_credits > 0 %}
                                                <span class="badge bg-success">Available</span>
                                            {% else %}
                                                <span class="badge bg-secondary">No Credits</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Payment Method Options -->
                                <div class="row">
                                    <div class="col-12">
                                        <label class="form-label">Choose Payment Method:</label>
                                        
                                        {% if player.tournament_credits and player.tournament_credits > 0 %}
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="radio" name="payment_method" id="payment_credits" value="credits" checked onchange="updatePaymentMethod()">
                                                <label class="form-check-label" for="payment_credits">
                                                    <i class="fas fa-coins me-2 text-success"></i>
                                                    <strong>Use Tournament Credits</strong>
                                                    <br><small class="text-muted">Pay with your available credits (Refunds from previous tournaments)</small>
                                                </label>
                                            </div>
                                        {% endif %}
                                        
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="payment_method" id="payment_cash" value="cash" 
                                                   {% if not player.tournament_credits or player.tournament_credits <= 0 %}checked{% endif %} onchange="updatePaymentMethod()">
                                            <label class="form-check-label" for="payment_cash">
                                                <i class="fas fa-dollar-sign me-2 text-primary"></i>
                                                <strong>Pay Entry Fee</strong>
                                                <br><small class="text-muted">Standard tournament entry payment</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Credit Usage Info -->
                                <div id="credit-usage-info" class="mt-3" style="display: none;">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-6">
                                                    <small class="text-muted">Entry Fee:</small>
                                                    <div class="fw-bold" id="entry-fee-display">$0</div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">After Payment:</small>
                                                    <div class="fw-bold" id="remaining-credits">${{ "%.2f"|format(player.tournament_credits or 0) }}</div>
                                                </div>
                                            </div>
                                            <div id="insufficient-credits-warning" class="alert alert-warning mt-2" style="display: none;">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                <strong>Insufficient Credits!</strong> You need additional payment to cover the full entry fee.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert text-white" style="background-color: #2c3e50; border-color: #34495e;">
                            <i class="fas fa-info-circle me-2 text-white"></i>
                            <strong class="text-white">Tournament Rules:</strong> 
                            <ul class="mb-0 mt-2 text-white">
                                <li class="text-white">Tournaments run for 2 weeks from entry date</li>
                                <li class="text-white">Players are matched based on skill level</li>
                                <li class="text-white">Entry fees contribute to prize pools</li>
                                <li class="text-white">Brackets are generated automatically</li>
                            </ul>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('dashboard', player_id=player.id) }}" class="btn btn-secondary me-md-2">Back to Dashboard</a>
                            <button type="submit" class="btn btn-success" id="submit-button">
                                <i class="fas fa-credit-card me-1"></i>Enter Tournament
                            </button>
                        </div>
                    </form>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Player Not Found</h5>
                        <p class="text-muted">Please register first to enter tournaments.</p>
                        <a href="{{ url_for('register') }}" class="btn btn-primary">
                            <i class="fas fa-user-plus me-1"></i>Register Player
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function selectTournament(tournamentId, cardElement) {
    // Check the radio button
    const radioButton = document.getElementById('tournament_' + tournamentId);
    if (radioButton) {
        radioButton.checked = true;
    }
    
    // Remove active class from all cards
    document.querySelectorAll('.tournament-card').forEach(card => {
        card.classList.remove('border-primary', 'bg-light');
    });
    
    // Add active class to selected card
    if (cardElement && cardElement.classList) {
        cardElement.classList.add('border-primary', 'bg-light');
    }
}

// Highlight recommended tournament level based on player skill
document.addEventListener('DOMContentLoaded', function() {
    const playerSkill = '{{ player.skill_level }}';
    
    // Find tournament card that matches player's skill level
    const tournamentCards = document.querySelectorAll('.tournament-card');
    tournamentCards.forEach(card => {
        const skillBadge = card.querySelector('.badge.bg-secondary');
        if (skillBadge && skillBadge.textContent.trim() === playerSkill) {
            const radioInput = card.querySelector('input[type="radio"]');
            if (radioInput) {
                radioInput.checked = true;
                card.classList.add('border-primary', 'bg-light');
            }
        }
    });
});

// Toggle partner selection based on tournament type
function togglePartnerSelection() {
    const tournamentType = document.getElementById('tournament_type').value;
    const partnerSelection = document.getElementById('partner-selection');
    const partnerSelect = document.getElementById('partner_id');
    const tournamentCards = document.querySelectorAll('.tournament-card');
    
    if (tournamentType === 'doubles') {
        partnerSelection.style.display = 'block';
        partnerSelect.required = true;
        
        // Update tournament fees to show +$10 for doubles
        tournamentCards.forEach(card => {
            const feeElement = card.querySelector('.tournament-fee');
            if (feeElement) {
                const baseFee = parseFloat(feeElement.dataset.baseFee);
                const doublesFee = baseFee + 10;
                feeElement.textContent = '$' + doublesFee.toFixed(0);
            }
        });
    } else {
        partnerSelection.style.display = 'none';
        partnerSelect.required = false;
        
        // Reset tournament fees to original amounts
        tournamentCards.forEach(card => {
            const feeElement = card.querySelector('.tournament-fee');
            if (feeElement) {
                const baseFee = parseFloat(feeElement.dataset.baseFee);
                feeElement.textContent = '$' + baseFee.toFixed(0);
            }
        });
    }
}

// Add styling for interactive cards
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.tournament-card').forEach(card => {
        card.style.cursor = 'pointer';
        card.style.transition = 'all 0.2s ease';
        
        card.addEventListener('mouseenter', function() {
            if (!this.classList.contains('border-primary')) {
                this.classList.add('border-secondary');
            }
        });
        
        card.addEventListener('mouseleave', function() {
            this.classList.remove('border-secondary');
        });
    });
    
    // Initialize payment method section and fee calculations
    updateTournamentSelection();
    updatePaymentMethod();
    
    // Add event listeners to tournament radio buttons
    document.querySelectorAll('input[name="tournament_instance_id"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updateTournamentSelection();
            
            // Update card styling
            document.querySelectorAll('.tournament-card').forEach(card => {
                card.classList.remove('border-primary', 'bg-light');
            });
            
            if (this.checked) {
                const card = this.closest('.tournament-card');
                if (card) {
                    card.classList.add('border-primary', 'bg-light');
                }
            }
        });
    });
    
    // Add event listeners to payment method radio buttons
    document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
        radio.addEventListener('change', updatePaymentMethod);
    });
});

// Credit management and payment calculation functions
const playerCredits = {{ player.tournament_credits or 0 }};

function updateTournamentSelection() {
    const selectedTournament = document.querySelector('input[name="tournament_instance_id"]:checked');
    const paymentSection = document.getElementById('payment-method-section');
    
    if (selectedTournament) {
        paymentSection.style.display = 'block';
        updatePaymentMethod();
    } else {
        paymentSection.style.display = 'none';
    }
}

function updatePaymentMethod() {
    const selectedTournament = document.querySelector('input[name="tournament_instance_id"]:checked');
    const tournamentType = document.getElementById('tournament_type').value;
    const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
    const creditUsageInfo = document.getElementById('credit-usage-info');
    const entryFeeDisplay = document.getElementById('entry-fee-display');
    const remainingCreditsDisplay = document.getElementById('remaining-credits');
    const insufficientWarning = document.getElementById('insufficient-credits-warning');
    const submitButton = document.getElementById('submit-button');
    
    if (!selectedTournament) {
        creditUsageInfo.style.display = 'none';
        return;
    }
    
    // Calculate entry fee
    const baseFee = parseFloat(selectedTournament.closest('.tournament-card').querySelector('.tournament-fee').dataset.baseFee);
    const entryFee = baseFee + (tournamentType === 'doubles' ? 10 : 0);
    
    entryFeeDisplay.textContent = '$' + entryFee.toFixed(2);
    
    // Show credit usage info if credits payment method is selected
    if (paymentMethod && paymentMethod.value === 'credits') {
        creditUsageInfo.style.display = 'block';
        
        const remainingCredits = Math.max(0, playerCredits - entryFee);
        remainingCreditsDisplay.textContent = '$' + remainingCredits.toFixed(2);
        
        // Check if credits are sufficient
        if (playerCredits < entryFee) {
            insufficientWarning.style.display = 'block';
            const shortfall = entryFee - playerCredits;
            insufficientWarning.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Insufficient Credits!</strong> You need an additional $${shortfall.toFixed(2)} to cover the full entry fee.
                Credit will be partially used and you'll need to pay the remaining amount.
            `;
            submitButton.innerHTML = '<i class="fas fa-credit-card me-1"></i>Continue with Partial Credit + Payment';
        } else {
            insufficientWarning.style.display = 'none';
            submitButton.innerHTML = '<i class="fas fa-coins me-1"></i>Enter Tournament with Credits';
        }
    } else {
        creditUsageInfo.style.display = 'none';
        submitButton.innerHTML = '<i class="fas fa-credit-card me-1"></i>Enter Tournament';
    }
}

// Enhanced selectTournament function to handle payment method updates
function selectTournament(tournamentId, cardElement) {
    // Check the radio button
    const radioButton = document.getElementById('tournament_' + tournamentId);
    if (radioButton) {
        radioButton.checked = true;
    }
    
    // Remove active class from all cards
    document.querySelectorAll('.tournament-card').forEach(card => {
        card.classList.remove('border-primary', 'bg-light');
    });
    
    // Add active class to selected card
    if (cardElement && cardElement.classList) {
        cardElement.classList.add('border-primary', 'bg-light');
    }
    
    // Update payment method section
    updateTournamentSelection();
}

// Enhanced togglePartnerSelection to handle payment updates
function togglePartnerSelection() {
    const tournamentType = document.getElementById('tournament_type').value;
    const partnerSelection = document.getElementById('partner-selection');
    const partnerSelect = document.getElementById('partner_id');
    const tournamentCards = document.querySelectorAll('.tournament-card');
    
    if (tournamentType === 'doubles') {
        partnerSelection.style.display = 'block';
        partnerSelect.required = true;
        
        // Update tournament fees to show +$10 for doubles
        tournamentCards.forEach(card => {
            const feeElement = card.querySelector('.tournament-fee');
            if (feeElement) {
                const baseFee = parseFloat(feeElement.dataset.baseFee);
                const doublesFee = baseFee + 10;
                feeElement.textContent = '$' + doublesFee.toFixed(0);
            }
        });
    } else {
        partnerSelection.style.display = 'none';
        partnerSelect.required = false;
        
        // Reset tournament fees to original amounts
        tournamentCards.forEach(card => {
            const feeElement = card.querySelector('.tournament-fee');
            if (feeElement) {
                const baseFee = parseFloat(feeElement.dataset.baseFee);
                feeElement.textContent = '$' + baseFee.toFixed(0);
            }
        });
    }
    
    // Update payment calculations
    updatePaymentMethod();
}
</script>
{% endblock %}
