import os
import sqlite3
import json
import requests
import math
from datetime import datetime, timedelta
from flask import Flask, render_template, request, redirect, url_for, flash, session, jsonify, Response
from werkzeug.utils import secure_filename
from functools import wraps
import logging
import stripe

# Configure logging
logging.basicConfig(level=logging.DEBUG)

# Email configuration for SendGrid
def send_admin_credentials_email(full_name, email, username, password, login_url):
    """Send admin login credentials via email"""
    try:
        from sendgrid import SendGridAPIClient
        from sendgrid.helpers.mail import Mail
        
        sendgrid_key = os.environ.get('SENDGRID_API_KEY')
        if not sendgrid_key:
            logging.error("SendGrid API key not found")
            return False
        
        # Create email content
        subject = "Ready 2 Dink - Admin Access Credentials"
        
        html_content = f"""
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #3F567F 0%, #D174D2 100%); padding: 20px; text-align: center;">
                <h1 style="color: white; margin: 0;">Ready 2 Dink</h1>
                <p style="color: white; margin: 5px 0;">Admin Portal Access</p>
            </div>
            
            <div style="padding: 30px; background: #f8f9fa;">
                <h2 style="color: #333;">Hello {full_name},</h2>
                
                <p>You have been granted admin access to the Ready 2 Dink platform. Here are your login credentials:</p>
                
                <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #3F567F; margin: 20px 0;">
                    <h3 style="margin-top: 0; color: #3F567F;">Login Information</h3>
                    <p><strong>Username:</strong> {username}</p>
                    <p><strong>Temporary Password:</strong> {password}</p>
                    <p><strong>Login URL:</strong> <a href="{login_url}">{login_url}</a></p>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin: 20px 0;">
